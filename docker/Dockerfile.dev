FROM python:3.12-bookworm

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    OMNIPKG_HOME=/home/omnipkg

RUN apt-get update && apt-get install -y --no-install-recommends \
    vim nano git curl wget htop tmux \
    build-essential gcc g++ make cmake ninja-build \
    zstd xz-utils \
    libmagic1 libssl-dev libffi-dev \
    shellcheck ripgrep fd-find \
    && rm -rf /var/lib/apt/lists/*

RUN groupadd --system --gid 1000 omnipkg && \
    useradd --system --uid 1000 --gid omnipkg --create-home --home-dir $OMNIPKG_HOME omnipkg

WORKDIR $OMNIPKG_HOME
COPY --chown=omnipkg:omnipkg pyproject.toml README.md ./
COPY --chown=omnipkg:omnipkg src/ ./src/

# Security fix: Upgrade pip to >=25.3 (CVE-2025-8869)
RUN pip install --no-cache-dir --upgrade pip>=25.3 && \
    pip install --no-cache-dir . && \
    pip install --no-cache-dir ipython pytest black ruff mypy

RUN mkdir -p $OMNIPKG_HOME/.omnipkg && \
    chown -R omnipkg:omnipkg $OMNIPKG_HOME

COPY --chown=omnipkg:omnipkg docker-entrypoint.sh ./
RUN chmod +x docker-entrypoint.sh

USER omnipkg
ENTRYPOINT ["./docker-entrypoint.sh"]
CMD ["/bin/bash"]
