FROM python:3.14-alpine

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    OMNIPKG_HOME=/home/omnipkg

RUN apk add --no-cache \
    vim nano git curl wget htop tmux \
    build-base gcc g++ make cmake ninja \
    zstd xz \
    libmagic openssl-dev libffi-dev \
    shellcheck ripgrep fd

RUN addgroup -g 1000 -S omnipkg && \
    adduser -u 1000 -S omnipkg -G omnipkg -h $OMNIPKG_HOME

WORKDIR $OMNIPKG_HOME
COPY --chown=omnipkg:omnipkg pyproject.toml README.md ./
COPY --chown=omnipkg:omnipkg src/ ./src/

# Security fix: Upgrade pip to >=25.3 (CVE-2025-8869)
RUN pip install --no-cache-dir --upgrade "pip>=25.3" && \
    pip install --no-cache-dir . && \
    pip install --no-cache-dir ipython pytest black ruff mypy

RUN mkdir -p $OMNIPKG_HOME/.omnipkg && \
    chown -R omnipkg:omnipkg $OMNIPKG_HOME

COPY --chown=omnipkg:omnipkg docker-entrypoint.sh ./
RUN chmod +x docker-entrypoint.sh

USER omnipkg
ENTRYPOINT ["./docker-entrypoint.sh"]
CMD ["/bin/sh"]
