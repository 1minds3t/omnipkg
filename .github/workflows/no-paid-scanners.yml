name: üõ°Ô∏è Guardrail - Block Paid Security Scanners

on:
  pull_request:
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for paid security scanners
        run: |
          FORBIDDEN='snyk|veracode|black.duck|synopsys|jfrog|sonarqube|sonarcloud|checkmarx|anchore|sysdig|zscaler|endorlabs|ethicalcheck|crunch42|contrast|frogbot|mayhem|cloudrail|crda|kubesec|xanitizer|soos'
          
          echo "üîç Scanning for paid security scanners..."
          
          # Check workflow files
          SCANNER_FOUND=false
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [[ -f "$file" ]]; then
              if grep -iE "$FORBIDDEN" "$file" > /dev/null; then
                echo "‚ùå Found forbidden scanner in: $(basename "$file")"
                SCANNER_FOUND=true
              fi
            fi
          done
          
          if [[ "$SCANNER_FOUND" == "true" ]]; then
            echo ""
            echo "üö´ BLOCKED: Paid security scanner detected!"
            echo "These scanners require paid accounts and API keys."
            echo ""
            echo "Allowed free scanners:"
            echo "  - codeql (GitHub), ossar (Microsoft), devskim (Microsoft)"
            echo "  - bandit, semgrep, safety, pylint (Python)"
            echo ""
            echo "Remove the paid scanner or convert it to workflow_dispatch only."
            exit 1
          else
            echo "‚úÖ No paid security scanners found. PR approved!"
          fi
