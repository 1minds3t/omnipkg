name: "ðŸ”¬ Flask Port Diagnostic"

on:
  workflow_dispatch:

jobs:
  diagnose-windows:
    runs-on: windows-latest
    name: "Diagnose Windows Flask Issue"
    
    steps:
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Flask
        run: |
          python -m pip install --upgrade pip
          pip install flask requests psutil
          Write-Host "âœ… Flask installed"
        shell: pwsh
      
      - name: Create Flask Test App
        run: |
          @"
          from flask import Flask
          import sys
          
          print('ðŸ” FLASK: Script starting...', file=sys.stderr, flush=True)
          
          app = Flask(__name__)
          
          print('ðŸ” FLASK: Flask app created', file=sys.stderr, flush=True)
          
          @app.route('/')
          def hello():
              print('ðŸ” FLASK: Route handler called!', file=sys.stderr, flush=True)
              return 'Success!'
          
          print('ðŸ” FLASK: Route registered', file=sys.stderr, flush=True)
          
          if __name__ == '__main__':
              print('ðŸ” FLASK: About to call app.run()...', file=sys.stderr, flush=True)
              app.run(host='0.0.0.0', port=5000, use_reloader=False, debug=False)
              print('ðŸ” FLASK: app.run() returned (should never see this)', file=sys.stderr, flush=True)
          "@ | Out-File -FilePath flask_app.py -Encoding utf8
          
          Write-Host "âœ… Flask app created at flask_app.py"
          Get-Content flask_app.py
        shell: pwsh
      
      - name: Start Flask in Background
        run: |
          Write-Host "ðŸš€ Starting Flask app in background..."
          
          # Use Start-Process instead of Start-Job for better control
          $proc = Start-Process python -ArgumentList "flask_app.py" -PassThru -RedirectStandardOutput "flask_stdout.log" -RedirectStandardError "flask_stderr.log" -NoNewWindow
          
          
      
      - name: Check What's Listening on Port 5000
        run: |
          Write-Host ""
          Write-Host "="*70
          Write-Host "ðŸ” DIAGNOSTIC: What's on port 5000?"
          Write-Host "="*70
          
          # Method 1: netstat
          Write-Host ""
          Write-Host "ðŸ“¡ Method 1: netstat"
          Write-Host "-"*70
          netstat -ano | Select-String "5000" | ForEach-Object {
            Write-Host $_
          }
          
          # Method 2: Get-NetTCPConnection (PowerShell native)
          Write-Host ""
          Write-Host "ðŸ“¡ Method 2: Get-NetTCPConnection"
          Write-Host "-"*70
          try {
            Get-NetTCPConnection -LocalPort 5000 -ErrorAction SilentlyContinue | Format-List *
          } catch {
            Write-Host "âš ï¸  No connections found on port 5000"
          }
          
          # Method 3: Test socket connection
          Write-Host ""
          Write-Host "ðŸ“¡ Method 3: Test-NetConnection"
          Write-Host "-"*70
          Test-NetConnection -ComputerName 127.0.0.1 -Port 5000 -InformationLevel Detailed
          
          # Method 4: Try to connect with Python
          Write-Host ""
          Write-Host "ðŸ“¡ Method 4: Python socket test"
          Write-Host "-"*70
          python -c @"
          import socket
          import sys
          
          print('Attempting to connect to 127.0.0.1:5000...')
          
          try:
              sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
              sock.settimeout(2)
              result = sock.connect_ex(('127.0.0.1', 5000))
              
              if result == 0:
                  print('âœ… Port 5000 is OPEN and accepting connections')
              else:
                  print(f'âŒ Connection failed with error code: {result}')
              
              sock.close()
          except Exception as e:
              print(f'âŒ Exception: {e}')
          "@
        shell: pwsh
      
      - name: Try HTTP Request
        run: |
          Write-Host ""
          Write-Host "="*70
          Write-Host "ðŸŒ HTTP Request Test"
          Write-Host "="*70
          
          python -c @"
          import requests
          import socket
          
          urls = [
              'http://127.0.0.1:5000',
              'http://localhost:5000',
              'http://0.0.0.0:5000'
          ]
          
          for url in urls:
              print(f'\nðŸ”— Trying {url}...')
              try:
                  response = requests.get(url, timeout=5)
                  print(f'   âœ… Status: {response.status_code}')
                  print(f'   ðŸ“ Content: {response.text}')
              except requests.exceptions.ConnectionError as e:
                  print(f'   âŒ Connection Error: {e}')
              except Exception as e:
                  print(f'   âŒ Error: {type(e).__name__}: {e}')
          "@
        shell: pwsh
      
      - name: Check Flask Process Details
        run: |
          Write-Host ""
          Write-Host "="*70
          Write-Host "ðŸ” Flask Process Details"
          Write-Host "="*70
          
          python -c @"
          import psutil
          
          print('\nðŸ“Š All Python processes:')
          print('-' * 70)
          
          for proc in psutil.process_iter(['pid', 'name', 'cmdline']):
              try:
                  if 'python' in proc.info['name'].lower():
                      print(f'\nPID: {proc.info["pid"]}')
                      print(f'Name: {proc.info["name"]}')
                      print(f'Command: {" ".join(proc.info["cmdline"])}')
                      
                      # Check network connections using the correct method
                      try:
                          p = psutil.Process(proc.info['pid'])
                          connections = p.net_connections()
                          if connections:
                              print(f'Network connections:')
                              for conn in connections:
                                  print(f'  - {conn}')
                          else:
                              print('  No network connections')
                      except (psutil.AccessDenied, psutil.NoSuchProcess):
                          print('  Could not get connections (access denied)')
              except (psutil.NoSuchProcess, psutil.AccessDenied):
                  pass
          "@
        shell: pwsh
      
      - name: Show Flask Output Log
        run: |
          Write-Host ""
          Write-Host "="*70
          Write-Host "ðŸ“¤ Flask Output Log"
          Write-Host "="*70
          
          if (Test-Path flask_output.log) {
            Get-Content flask_output.log
          } else {
            Write-Host "âš ï¸  No log file found"
          }
        shell: pwsh
      
      - name: Cleanup
        if: always()
        run: |
          Write-Host "ðŸ§¹ Cleaning up..."
          Get-Job | Stop-Job
          Get-Job | Remove-Job
        shell: pwsh

  diagnose-macos:
    runs-on: macos-latest
    name: "Diagnose macOS Flask Issue"
    
    steps:
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Flask
        run: |
          python -m pip install --upgrade pip
          pip install flask requests psutil
          echo "âœ… Flask installed"
      
      - name: Create Flask Test App
        run: |
          cat > flask_app.py << 'EOF'
          from flask import Flask
          import sys
          
          print('ðŸ” FLASK: Script starting...', file=sys.stderr, flush=True)
          
          app = Flask(__name__)
          
          print('ðŸ” FLASK: Flask app created', file=sys.stderr, flush=True)
          
          @app.route('/')
          def hello():
              print('ðŸ” FLASK: Route handler called!', file=sys.stderr, flush=True)
              return 'Success!'
          
          print('ðŸ” FLASK: Route registered', file=sys.stderr, flush=True)
          
          if __name__ == '__main__':
              print('ðŸ” FLASK: About to call app.run()...', file=sys.stderr, flush=True)
              app.run(host='0.0.0.0', port=5000, use_reloader=False, debug=False)
              print('ðŸ” FLASK: app.run() returned (should never see this)', file=sys.stderr, flush=True)
          EOF
          
          echo "âœ… Flask app created"
          cat flask_app.py
      
      - name: Start Flask in Background
        run: |
          echo "ðŸš€ Starting Flask app in background..."
          python flask_app.py > flask_output.log 2>&1 &
          FLASK_PID=$!
          echo "âœ… Flask started with PID: $FLASK_PID"
          echo $FLASK_PID > flask.pid
          
          echo "â³ Waiting 5 seconds for Flask to start..."
          sleep 5
          
          # Check if process is still running
          if ps -p $FLASK_PID > /dev/null; then
            echo "âœ… Flask process is still running"
          else
            echo "âŒ Flask process died!"
            echo "ðŸ“¤ Output:"
            cat flask_output.log
          fi
      
      - name: Check What's Listening on Port 5000
        run: |
          echo ""
          echo "======================================================================"
          echo "ðŸ” DIAGNOSTIC: What's on port 5000?"
          echo "======================================================================"
          
          # Method 1: lsof
          echo ""
          echo "ðŸ“¡ Method 1: lsof"
          echo "----------------------------------------------------------------------"
          lsof -i :5000 || echo "âš ï¸  No process found on port 5000"
          
          # Method 2: netstat
          echo ""
          echo "ðŸ“¡ Method 2: netstat"
          echo "----------------------------------------------------------------------"
          netstat -an | grep 5000 || echo "âš ï¸  Port 5000 not in netstat output"
          
          # Method 3: Test socket connection
          echo ""
          echo "ðŸ“¡ Method 3: nc (netcat) test"
          echo "----------------------------------------------------------------------"
          if nc -z 127.0.0.1 5000; then
            echo "âœ… Port 5000 is OPEN"
          else
            echo "âŒ Port 5000 is CLOSED"
          fi
          
          # Method 4: Try to connect with Python
          echo ""
          echo "ðŸ“¡ Method 4: Python socket test"
          echo "----------------------------------------------------------------------"
          python -c "
          import socket
          import sys
          
          print('Attempting to connect to 127.0.0.1:5000...')
          
          try:
              sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
              sock.settimeout(2)
              result = sock.connect_ex(('127.0.0.1', 5000))
              
              if result == 0:
                  print('âœ… Port 5000 is OPEN and accepting connections')
              else:
                  print(f'âŒ Connection failed with error code: {result}')
              
              sock.close()
          except Exception as e:
              print(f'âŒ Exception: {e}')
          "
      
      - name: Try HTTP Request
        run: |
          echo ""
          echo "======================================================================"
          echo "ðŸŒ HTTP Request Test"
          echo "======================================================================"
          
          python -c "
          import requests
          
          urls = [
              'http://127.0.0.1:5000',
              'http://localhost:5000',
              'http://0.0.0.0:5000'
          ]
          
          for url in urls:
              print(f'\nðŸ”— Trying {url}...')
              try:
                  response = requests.get(url, timeout=5)
                  print(f'   âœ… Status: {response.status_code}')
                  print(f'   ðŸ“ Content: {response.text}')
              except requests.exceptions.ConnectionError as e:
                  print(f'   âŒ Connection Error: {e}')
              except Exception as e:
                  print(f'   âŒ Error: {type(e).__name__}: {e}')
          "
      
      - name: Check Flask Process Details
        run: |
          echo ""
          echo "======================================================================"
          echo "ðŸ” Flask Process Details"
          echo "======================================================================"
          
          python -c "
          import psutil
          
          print('\nðŸ“Š All Python processes:')
          print('-' * 70)
          
          for proc in psutil.process_iter(['pid', 'name', 'cmdline']):
              try:
                  if 'python' in proc.info['name'].lower():
                      print(f'\nPID: {proc.info[\"pid\"]}')
                      print(f'Name: {proc.info[\"name\"]}')
                      print(f'Command: {\" \".join(proc.info[\"cmdline\"])}')
                      
                      # Check network connections using the correct method
                      try:
                          p = psutil.Process(proc.info['pid'])
                          connections = p.net_connections()
                          if connections:
                              print(f'Network connections:')
                              for conn in connections:
                                  print(f'  - {conn}')
                          else:
                              print('  No network connections')
                      except (psutil.AccessDenied, psutil.NoSuchProcess):
                          print('  Could not get connections (access denied)')
              except (psutil.NoSuchProcess, psutil.AccessDenied):
                  pass
          "
      
      - name: Show Flask Output Log
        run: |
          echo ""
          echo "======================================================================"
          echo "ðŸ“¤ Flask Output Log"
          echo "======================================================================"
          
          if [ -f flask_output.log ]; then
            cat flask_output.log
          else
            echo "âš ï¸  No log file found"
          fi
      
      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          if [ -f flask.pid ]; then
            kill $(cat flask.pid) 2>/dev/null || true
          fi
