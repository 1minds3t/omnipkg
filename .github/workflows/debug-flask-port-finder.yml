name: "ğŸŒ Cross-Platform Flask Server"

on:
  workflow_dispatch:

jobs:
  flask-server:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    name: "Flask on ${{ matrix.os }}"
    
    steps:
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Flask
        run: |
          python -m pip install --upgrade pip
          pip install flask requests
        shell: bash
      
      - name: Create Flask App
        run: |
          cat > flask_app.py << 'EOF'
          from flask import Flask, jsonify
          import sys
          
          app = Flask(__name__)
          
          @app.route('/')
          def home():
              return f'Hello from {sys.platform}!'
          
          @app.route('/api/data')
          def get_data():
              return jsonify({
                  'status': 'success',
                  'platform': sys.platform
              })
          
          @app.route('/health')
          def health():
              return jsonify({'status': 'healthy'})
          
          if __name__ == '__main__':
              app.run(host='127.0.0.1', port=5000, debug=False, use_reloader=False)
          EOF
          echo "âœ… Flask app created"
        shell: bash
      
      - name: Start Flask Server (Windows)
        if: runner.os == 'Windows'
        run: |
          Write-Host "Starting Flask server..."
          
          # Windows: Use Start-Process WITHOUT output redirection
          $proc = Start-Process python `
            -ArgumentList "flask_app.py" `
            -PassThru `
            -WindowStyle Hidden
          
          Write-Host "âœ… Server started (PID: $($proc.Id))"
          $proc.Id | Out-File -FilePath "server.pid" -Encoding ascii
          
          Start-Sleep -Seconds 8
          
          if (Get-Process -Id $proc.Id -ErrorAction SilentlyContinue) {
            Write-Host "âœ… Server is running"
          } else {
            Write-Host "âŒ Server failed to start"
            exit 1
          }
        shell: pwsh
      
      - name: Start Flask Server (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "Starting Flask server..."
          
          # Unix: Standard background process
          python flask_app.py > server.log 2>&1 &
          SERVER_PID=$!
          echo $SERVER_PID > server.pid
          
          echo "âœ… Server started (PID: $SERVER_PID)"
          sleep 5
          
          if ps -p $SERVER_PID > /dev/null; then
            echo "âœ… Server is running"
          else
            echo "âŒ Server failed to start"
            cat server.log
            exit 1
          fi
        shell: bash
      
      - name: Test Server
        run: |
          python << 'EOF'
          import requests
          import time
          
          print("\n" + "="*50)
          print("Testing Flask Server")
          print("="*50)
          
          endpoints = [
              ('/', 'Home'),
              ('/api/data', 'API'),
              ('/health', 'Health')
          ]
          
          results = []
          for path, name in endpoints:
              url = f'http://127.0.0.1:5000{path}'
              print(f"\nğŸ”— Testing {name}: {url}")
              
              for attempt in range(3):
                  try:
                      response = requests.get(url, timeout=5)
                      print(f"   âœ… Status: {response.status_code}")
                      print(f"   ğŸ“ Response: {response.text[:100]}")
                      results.append(True)
                      break
                  except Exception as e:
                      if attempt == 2:
                          print(f"   âŒ Failed: {type(e).__name__}")
                          results.append(False)
                      time.sleep(1)
          
          print("\n" + "="*50)
          passed = sum(results)
          total = len(results)
          print(f"Results: {passed}/{total} tests passed")
          print("="*50)
          
          if passed < total:
              exit(1)
          EOF
        shell: bash
      
      - name: Cleanup (Windows)
        if: always() && runner.os == 'Windows'
        run: |
          if (Test-Path "server.pid") {
            $pid = Get-Content "server.pid"
            Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue
            Write-Host "âœ… Cleanup complete"
          }
        shell: pwsh
      
      - name: Cleanup (Unix)
        if: always() && runner.os != 'Windows'
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) 2>/dev/null || true
            echo "âœ… Cleanup complete"
          fi
        shell: bash
