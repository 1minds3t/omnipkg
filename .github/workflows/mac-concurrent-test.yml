name: "ðŸŽ macOS - Omnipkg Demo Test (CI - No Redis)"
on:
  push:
    branches: [ development ]
  pull_request:
    branches: [ development ]
  workflow_dispatch:

jobs:
  test:
    runs-on: macos-latest
    timeout-minutes: 30
    env:
      PYTHONIOENCODING: "utf-8"
      PYTHONUTF8: "1"
      LANG: "en_US.UTF-8"
      LC_ALL: "en_US.UTF-8"
      OMNIPKG_NONINTERACTIVE: "1"
      OMNIPKG_DEBUG: "1"
      CI: "true"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: src

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install omnipkg
        run: |
          python -m pip install --upgrade pip
          pip install -e src
        shell: bash

      # No manual config.json needed - OMNIPKG_NONINTERACTIVE handles it
      - name: Verify omnipkg installed correctly
        run: |
          omnipkg --version || true
          omnipkg status
        shell: bash
        working-directory: src

      - name: Run Demo - Run 1
        run: |
          echo "=== Demo Run 1 ===" 
          omnipkg demo 8 --non-interactive
          echo "=== Run 1 complete ==="
        shell: bash
        working-directory: src

      - name: Run Demo - Run 2 (warm workers)
        run: |
          echo "=== Demo Run 2 ==="
          omnipkg demo 8 --non-interactive
          echo "=== Run 2 complete ==="
        shell: bash
        working-directory: src

      - name: Run Demo - Run 3 (warm workers)
        run: |
          echo "=== Demo Run 3 ==="
          omnipkg demo 8 --non-interactive
          echo "=== Run 3 complete ==="
        shell: bash
        working-directory: src

      - name: Display daemon log
        if: always()
        run: |
          echo "=== Omnipkg Daemon Log ==="
          # Find wherever DAEMON_LOG_FILE points
          LOG_CANDIDATES=(
            "/tmp/omnipkg_daemon.log"
            "$HOME/.config/omnipkg/daemon.log"
            "/tmp/omnipkg/daemon.log"
          )
          FOUND=false
          for log in "${LOG_CANDIDATES[@]}"; do
            if [ -f "$log" ]; then
              echo "ðŸ“„ Found log at: $log"
              echo "--- Last 200 lines ---"
              tail -200 "$log"
              FOUND=true
            fi
          done
          if [ "$FOUND" = false ]; then
            echo "âš ï¸  No daemon log found. Searched:"
            for log in "${LOG_CANDIDATES[@]}"; do
              echo "   - $log"
            done
            # Try to find it
            find /tmp -name "*.log" -newer /tmp 2>/dev/null | head -10 || true
            find $HOME -name "*omnipkg*log*" 2>/dev/null | head -10 || true
          fi
        shell: bash

      - name: Display system information
        if: always()
        run: |
          echo "=== System Information ==="
          sw_vers
          echo ""
          echo "=== Python Information ==="
          python --version
          which python
          echo ""
          echo "=== Omnipkg Installation ==="
          pip show omnipkg
          echo ""
          echo "=== Omnipkg Interpreter Registry ==="
          # Show what interpreters omnipkg knows about
          find / -name "registry.json" -path "*omnipkg*" 2>/dev/null | head -5 | while read f; do
            echo "ðŸ“„ $f:"
            cat "$f"
            echo ""
          done || true
          echo ""
          echo "=== Temp Worker Scripts ==="
          ls /tmp/*.py 2>/dev/null || echo "No temp scripts found"
        shell: bash
