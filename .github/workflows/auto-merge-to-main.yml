name: Auto-merge Development to Main

on:
  workflow_run:
    workflows:
      - "Cross-Platform Sanity Check"
      - "Package Discovery Demo - Omnipkg Intelligence"
      - "LIVE - Quantum Python Auto-Switch Test"
      - "Flask Port Finder & Auto-Healing Test"
      - "Live NumPy/SciPy Hot-Swapping"
      - "LIVE - Python Library Hot-Swap"
      - "Nuclear Test: TensorFlow Dependency Hot-Swap"
      - "LIVE - Package Upgrade Test"
      - "LIVE - Omnipkg Self-Upgrade Test"
      - "Omnipkg Multi-Language Intelligence Demo"
      - "LIVE - Omnipkg Quantum Multiverse Warp (FINAL)"
      - "Package Manager Comparison Test"
      - "macOS - Omnipkg Demo Test (CI - No Redis)"
      - "Windows - Omnipkg Demo Test (CI - No Redis)"
      - "Omnipkg True First-Run Test (Windows)"
      - "UV Self-Downgrades Auto-Revert"
      - "Simple UV Multi-Version Test"
      - "Old Rich Test"
      - "Simple Python Adoption Test"
      - "Demo Matrix Test (All Demos)"
    types:
      - completed
    branches:
      - development

permissions:
  contents: write
  actions: read

concurrency:
  group: auto-merge-main
  cancel-in-progress: false

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'development'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Check All Workflows Passed
      id: check
      run: |
        COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
        
        gh run list \
          --branch development \
          --commit $COMMIT_SHA \
          --json conclusion,status \
          --limit 100 > runs.json
        
        TOTAL=$(jq 'length' runs.json)
        SUCCESS=$(jq '[.[] | select(.conclusion == "success" or .conclusion == "skipped")] | length' runs.json)
        IN_PROGRESS=$(jq '[.[] | select(.status == "in_progress" or .status == "queued")] | length' runs.json)
        FAILED=$(jq '[.[] | select(.conclusion == "failure")] | length' runs.json)
        
        echo "Total: $TOTAL, Success: $SUCCESS, In Progress: $IN_PROGRESS, Failed: $FAILED"
        
        if [ "$IN_PROGRESS" -gt 0 ]; then
          echo "Workflows still running, skipping merge"
          echo "should_merge=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        if [ "$FAILED" -gt 0 ]; then
          echo "Some workflows failed, skipping merge"
          echo "should_merge=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        if [ "$SUCCESS" -lt 5 ]; then
          echo "Not enough workflows passed, skipping merge"
          echo "should_merge=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "All workflows passed"
        echo "should_merge=true" >> $GITHUB_OUTPUT
        echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Check Not Already Merged
      if: steps.check.outputs.should_merge == 'true'
      id: check_merged
      run: |
        COMMIT_SHA="${{ steps.check.outputs.commit_sha }}"
        git fetch origin main
        
        if git merge-base --is-ancestor $COMMIT_SHA origin/main; then
          echo "Commit already in main"
          echo "already_merged=true" >> $GITHUB_OUTPUT
        else
          echo "Commit not yet merged"
          echo "already_merged=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Merge to Main
      if: steps.check.outputs.should_merge == 'true' && steps.check_merged.outputs.already_merged == 'false'
      run: |
        COMMIT_SHA="${{ steps.check.outputs.commit_sha }}"
        SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-7)
        
        git checkout main
        git pull origin main
        git fetch origin development
        
        git merge $COMMIT_SHA --no-ff -m "Auto-merge development to main ($SHORT_SHA)" -m "All CI checks passed"
        git push origin main
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
