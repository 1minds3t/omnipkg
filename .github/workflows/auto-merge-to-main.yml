name: "üöÄ Auto-merge Development ‚Üí Main"

on:
  workflow_run:
    workflows:
      - "Cross-Platform Sanity Check"
      - "üîç Package Discovery Demo - Omnipkg Intelligence"
      - "üåå LIVE - Quantum Python Auto-Switch Test"
      - "üß™ Flask Port Finder & Auto-Healing Test"
      - "üî• Live NumPy/SciPy Hot-Swapping"
      - "üî• LIVE - Python Library Hot-Swap"
      - "üí• Nuclear Test: TensorFlow Dependency Hot-Swap"
      - "‚¨ÜÔ∏è LIVE - Package Upgrade Test"
      - "üîÑ LIVE - Omnipkg Self-Upgrade Test"
      - "üåç Omnipkg Multi-Language Intelligence Demo"
      - "üå† LIVE - Omnipkg Quantum Multiverse Warp (FINAL)"
      - "Package Manager Comparison Test"
      - "üçé macOS - Omnipkg Demo Test (CI - No Redis)"
      - "üöÄ Windows - Omnipkg Demo Test (CI - No Redis)"
      - "Omnipkg True First-Run Test (Windows)"
      - "üîÑ UV Self-Downgrades ‚Üí Auto-Revert"
      - "Simple UV Multi-Version Test"
      - "Old Rich Test"
      - "Simple Python Adoption Test"
      - "üé™ Demo Matrix Test (All Demos)"
    types:
      - completed
    branches:
      - development

permissions:
  contents: write
  actions: read
  issues: write

# Prevents two merges from happening at the same time
concurrency:
  group: auto-merge-main
  cancel-in-progress: false

jobs:
  check-and-merge:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'development'
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Analyze Workflow Status
      id: check_all
      run: |
        COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
        SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-7)
        echo "üìä Analyzing commit: $SHORT_SHA"
        
        # Get all workflow runs for this specific commit
        gh run list \
          --branch development \
          --commit $COMMIT_SHA \
          --json conclusion,status,name \
          --limit 200 > runs.json
        
        # Calculate stats
        TOTAL=$(jq '. | length' runs.json)
        SUCCESS=$(jq '[.[] | select(.conclusion == "success")] | length' runs.json)
        SKIPPED=$(jq '[.[] | select(.conclusion == "skipped" or .conclusion == "neutral")] | length' runs.json)
        IN_PROGRESS=$(jq '[.[] | select(.status == "in_progress" or .status == "queued" or .status == "waiting")] | length' runs.json)
        FAILED=$(jq '[.[] | select(.conclusion == "failure" or .conclusion == "timed_out" or .conclusion == "cancelled")] | length' runs.json)
        
        EFFECTIVE_PASS=$((SUCCESS + SKIPPED))
        
        echo "üìä Stats for commit $SHORT_SHA:"
        echo "   Total workflows: $TOTAL"
        echo "   ‚úÖ Success: $SUCCESS"
        echo "   ‚è≠Ô∏è  Skipped: $SKIPPED"
        echo "   ‚è≥ In Progress: $IN_PROGRESS"
        echo "   ‚ùå Failed: $FAILED"
        echo ""
        
        # 1. If anything is still running, wait for the last workflow to trigger merge
        if [ "$IN_PROGRESS" -gt 0 ]; then
          echo "‚è≥ Workflows still running. Waiting for completion..."
          echo "should_merge=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # 2. If anything failed, block merge
        if [ "$FAILED" -gt 0 ]; then
          echo "‚ùå Some workflows failed. Not merging."
          echo "Failed workflows:"
          jq -r '.[] | select(.conclusion == "failure" or .conclusion == "timed_out" or .conclusion == "cancelled") | "  - \(.name): \(.conclusion)"' runs.json
          echo "should_merge=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # 3. Safety check: Ensure we ran enough tests (at least 5)
        if [ "$EFFECTIVE_PASS" -lt 5 ]; then
          echo "‚ö†Ô∏è  Too few workflows completed ($EFFECTIVE_PASS/5). Possible CI issue."
          echo "should_merge=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "‚úÖ All $EFFECTIVE_PASS workflows passed! Ready to merge."
        echo "should_merge=true" >> $GITHUB_OUTPUT
        echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
        echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Check if already merged
      if: steps.check_all.outputs.should_merge == 'true'
      id: check_merged
      run: |
        COMMIT_SHA="${{ steps.check_all.outputs.commit_sha }}"
        SHORT_SHA="${{ steps.check_all.outputs.short_sha }}"
        
        git fetch origin main
        
        # Check if this commit (or its ancestors) are already in main
        if git merge-base --is-ancestor $COMMIT_SHA origin/main; then
          echo "‚úÖ Commit $SHORT_SHA is already in main. Nothing to do."
          echo "already_merged=true" >> $GITHUB_OUTPUT
        else
          echo "üìù Commit $SHORT_SHA not yet in main. Proceeding with merge."
          echo "already_merged=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Merge development into main
      if: steps.check_all.outputs.should_merge == 'true' && steps.check_merged.outputs.already_merged == 'false'
      run: |
        COMMIT_SHA="${{ steps.check_all.outputs.commit_sha }}"
        SHORT_SHA="${{ steps.check_all.outputs.short_sha }}"
        
        echo "üîÑ Merging development (up to $SHORT_SHA) into main..."
        
        # Switch to main and update
        git checkout main
        git pull origin main
        
        # Fetch latest development
        git fetch origin development
        
        # Merge the commit (this brings all ancestor commits too!)
        WORKFLOW_COUNT=$(jq '. | length' runs.json)
        
        if git merge $COMMIT_SHA --no-ff -m "Auto-merge: development ‚Üí main ($SHORT_SHA)

All CI checks passed for commit $SHORT_SHA.

‚úÖ Workflows completed: $WORKFLOW_COUNT
üì¶ Merged by: GitHub Actions
üîó Triggered by: ${{ github.event.workflow_run.name }}"; then
          
          echo "‚úÖ Merge successful!"
          
          # Push to main
          git push origin main
          
          echo "üöÄ Successfully merged to main!"
          
        else
          echo "‚ùå Merge conflict detected!"
          git merge --abort
          
          # Create issue for manual resolution
          gh issue create \
            --title "üö® Auto-merge Failed: Conflict in $SHORT_SHA" \
            --body "## Merge Conflict Detected

Commit [$SHORT_SHA](https://github.com/${{ github.repository }}/commit/$COMMIT_SHA) passed all CI tests but has merge conflicts with main.

**Manual intervention required:**

\`\`\`bash
git checkout main
git pull origin main
git merge $COMMIT_SHA
# Resolve conflicts
git commit
git push origin main
\`\`\`

**Or rebase development on main:**

\`\`\`bash
git checkout development
git pull origin development
git rebase origin/main
# Resolve conflicts
git push --force-with-lease origin development
\`\`\`

Once resolved, this workflow will retry automatically." \
            --label "auto-merge-conflict" \
            --label "needs-manual-merge"
          
          exit 1
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
