name: "üöÄ Auto-merge Development ‚Üí Main"

on:
  workflow_run:
    workflows:
      - "Cross-Platform Sanity Check"
      - "Package Discovery Demo - Omnipkg Intelligence"
      - "Quantum Python Auto-Switch Test"
      - "Flask Port Finder & Auto-Healing Test"
      - "Live NumPy/SciPy Hot-Swapping"
      - "Python Library Hot-Swap"
      - "Nuclear Test: TensorFlow Dependency Hot-Swap"
      - "Package Upgrade Test"
      - "Omnipkg Self-Upgrade Test"
      - "Omnipkg Multi-Language Intelligence Demo"
      - "Omnipkg Quantum Multiverse Warp (FINAL)"
      - "Package Manager Comparison Test"
      - "macOS - Omnipkg Demo Test (CI - No Redis)"
      - "Windows - Omnipkg Demo Test (CI - No Redis)"
      - "Omnipkg True First-Run Test (Windows)"
      - "UV Self-Downgrades ‚Üí Auto-Revert"
      - "Simple UV Multi-Version Test"
      - "Old Rich Test"
      - "Simple Python Adoption Test"
      - "Demo Matrix Test (All Demos)"
    types:
      - completed
    branches:
      - development

permissions:
  contents: write
  actions: read
  issues: write

# Prevents two merges from happening at the exact same time
concurrency:
  group: auto-merge-main
  cancel-in-progress: false

jobs:
  check-and-merge:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'development'
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Analyze Workflow Status
      id: check_all
      run: |
        COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
        echo "Analyzing commit: $COMMIT_SHA"
        
        # Get all workflow runs for this specific commit
        # We increase limit to 200 to ensure we catch your large matrix
        gh run list \
          --branch development \
          --commit $COMMIT_SHA \
          --json conclusion,status,name \
          --limit 200 > runs.json
        
        # Calculate stats
        TOTAL=$(jq '. | length' runs.json)
        SUCCESS=$(jq '[.[] | select(.conclusion == "success")] | length' runs.json)
        # We also count 'skipped' or 'neutral' as acceptable for conditional workflows
        SKIPPED=$(jq '[.[] | select(.conclusion == "skipped" or .conclusion == "neutral")] | length' runs.json)
        IN_PROGRESS=$(jq '[.[] | select(.status == "in_progress" or .status == "queued" or .status == "waiting")] | length' runs.json)
        FAILED=$(jq '[.[] | select(.conclusion == "failure" or .conclusion == "timed_out")] | length' runs.json)
        
        EFFECTIVE_PASS=$((SUCCESS + SKIPPED))
        
        echo "üìä Stats for commit $COMMIT_SHA:"
        echo "   Total: $TOTAL"
        echo "   ‚úÖ Success: $SUCCESS"
        echo "   ‚è≠Ô∏è Skipped: $SKIPPED"
        echo "   ‚è≥ In Progress: $IN_PROGRESS"
        echo "   ‚ùå Failed: $FAILED"
        
        # 1. Exit if anything is still running (Let the last workflow trigger the merge)
        if [ "$IN_PROGRESS" -gt 0 ]; then
          echo "‚è≥ Workflows still running. Exiting and waiting for the last one."
          echo "should_merge=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # 2. Exit if anything failed
        if [ "$FAILED" -gt 0 ]; then
          echo "‚ùå Commit failed validation."
          echo "should_merge=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # 3. Safety Check: Ensure we actually ran a decent number of tests
        # Lowered to 5 to be safe, assuming at least the matrix runs
        if [ "$EFFECTIVE_PASS" -lt 5 ]; then
          echo "‚ö†Ô∏è Too few workflows completed ($EFFECTIVE_PASS). Something might be wrong."
          echo "should_merge=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "‚úÖ All checks passed! Ready to merge."
        echo "should_merge=true" >> $GITHUB_OUTPUT
        echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Merge to Main
      if: steps.check_all.outputs.should_merge == 'true'
      run: |
        COMMIT_SHA="${{ steps.check_all.outputs.commit_sha }}"
        SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-7)
        
        git checkout main
        git pull origin main
        
        # Check if already merged
        if git merge-base --is-ancestor $COMMIT_SHA HEAD; then
          echo "‚úÖ Commit $COMMIT_SHA is already in main."
          exit 0
        fi
        
        echo "üöÄ Merging commit $COMMIT_SHA into main..."
        
        # Prepare the commit message in a variable to avoid YAML syntax errors
        MERGE_MSG="Auto-merge: development ‚Üí main ($SHORT_SHA) - All Tests Passed"
        
        # Try to merge
        if git merge $COMMIT_SHA --no-ff -m "$MERGE_MSG"; then
          git push origin main
          echo "‚úÖ Successfully pushed to main."
        else
          echo "‚ùå Merge conflict detected."
          git merge --abort
          
          # Create an issue for manual resolution
          gh issue create \
            --title "üö® Auto-merge Failed: Conflict in $SHORT_SHA" \
            --body "Commit $SHORT_SHA passed all tests but conflicts with main. Manual intervention required." \
            --label "auto-merge-conflict"
          exit 1
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
