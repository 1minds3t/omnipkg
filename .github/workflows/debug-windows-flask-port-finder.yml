name: "üéØ Working Windows Flask Server"

on:
  workflow_dispatch:

jobs:
  flask-server:
    runs-on: windows-latest
    name: "Flask Server Demo"
    
    steps:
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Flask
        run: |
          python -m pip install --upgrade pip
          pip install flask requests
          Write-Host "[OK] Flask installed"
        shell: pwsh
      
      - name: Create Flask App
        run: |
          $app = @'
          from flask import Flask, jsonify
          import sys
          
          app = Flask(__name__)
          
          @app.route('/')
          def home():
              return 'Hello from Windows Flask!'
          
          @app.route('/api/data')
          def get_data():
              return jsonify({
                  'status': 'success',
                  'message': 'Flask is working on Windows!',
                  'platform': sys.platform
              })
          
          @app.route('/health')
          def health():
              return jsonify({'status': 'healthy'})
          
          if __name__ == '__main__':
              print('[SERVER] Starting Flask on 127.0.0.1:5000', flush=True)
              # CRITICAL: Use 127.0.0.1, not 0.0.0.0 on Windows!
              app.run(host='127.0.0.1', port=5000, debug=False, use_reloader=False)
          '@
          
          $app | Out-File -FilePath flask_app.py -Encoding utf8
          Write-Host "[OK] Flask app created"
        shell: pwsh
      
      - name: Start Flask Server
        run: |
          Write-Host "Starting Flask server in background..."
          
          # Critical: Don't redirect stdout/stderr - this kills the server on Windows!
          $proc = Start-Process python `
            -ArgumentList "flask_app.py" `
            -PassThru `
            -WindowStyle Hidden
          
          Write-Host "[OK] Server started with PID: $($proc.Id)"
          
          # Wait for server to be ready
          Write-Host "[INFO] Waiting for server to initialize..."
          Start-Sleep -Seconds 8
          
          # Verify process is still running
          $running = Get-Process -Id $proc.Id -ErrorAction SilentlyContinue
          if ($running) {
            Write-Host "[OK] Server process is running"
          } else {
            Write-Host "[ERROR] Server process died!"
            exit 1
          }
          
          # Save PID for cleanup (use different variable name, not $pid)
          $proc.Id | Out-File -FilePath "server_pid.txt" -Encoding ascii
        shell: pwsh
      
      - name: Test Server Endpoints
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "TESTING FLASK ENDPOINTS"
          Write-Host "=========================================="
          
          $testScript = @'
          import requests
          import json
          
          def test_endpoint(url, name):
              print(f'\n--- Testing {name} ---')
              try:
                  response = requests.get(url, timeout=5)
                  print(f'Status: {response.status_code}')
                  print(f'Content: {response.text}')
                  
                  if response.status_code == 200:
                      print(f'‚úì {name} SUCCESS')
                      return True
                  else:
                      print(f'‚úó {name} FAILED')
                      return False
              except Exception as e:
                  print(f'‚úó {name} ERROR: {e}')
                  return False
          
          print('Testing Flask server at http://127.0.0.1:5000')
          
          results = []
          results.append(test_endpoint('http://127.0.0.1:5000/', 'Home page'))
          results.append(test_endpoint('http://127.0.0.1:5000/api/data', 'API endpoint'))
          results.append(test_endpoint('http://127.0.0.1:5000/health', 'Health check'))
          
          print('\n========================================')
          print('SUMMARY')
          print('========================================')
          passed = sum(results)
          total = len(results)
          print(f'Tests passed: {passed}/{total}')
          
          if passed == total:
              print('\nüéâ ALL TESTS PASSED!')
          else:
              print(f'\n‚ö†Ô∏è {total - passed} test(s) failed')
              exit(1)
          '@
          
          $testScript | Out-File -FilePath test_server.py -Encoding utf8
          $env:PYTHONIOENCODING = "utf-8"
          python test_server.py
        shell: pwsh
      
      - name: Check Server Logs
        if: always()
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "SERVER STATUS"
          Write-Host "=========================================="
          
          if (Test-Path "server_pid.txt") {
            $serverId = Get-Content "server_pid.txt"
            $process = Get-Process -Id $serverId -ErrorAction SilentlyContinue
            if ($process) {
              Write-Host "[OK] Server still running (PID: $serverId)"
              Write-Host "Process info:"
              $process | Format-Table Id, ProcessName, StartTime, @{Name="CPU(s)";Expression={$_.CPU}}
            } else {
              Write-Host "[INFO] Server process no longer running"
            }
          }
        shell: pwsh
      
      - name: Load Test (Optional)
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "LOAD TEST - 50 rapid requests"
          Write-Host "=========================================="
          
          $loadTest = @'
          import requests
          import time
          import statistics
          
          url = 'http://127.0.0.1:5000/'
          num_requests = 50
          
          print(f'Sending {num_requests} requests...')
          
          times = []
          successes = 0
          
          for i in range(num_requests):
              start = time.time()
              try:
                  response = requests.get(url, timeout=5)
                  elapsed = time.time() - start
                  times.append(elapsed)
                  
                  if response.status_code == 200:
                      successes += 1
                  
                  if (i + 1) % 10 == 0:
                      print(f'  Completed {i + 1}/{num_requests}')
              except Exception as e:
                  print(f'  Request {i + 1} failed: {e}')
          
          print('\nResults:')
          print(f'  Successful requests: {successes}/{num_requests}')
          print(f'  Success rate: {successes/num_requests*100:.1f}%')
          
          if times:
              print(f'  Avg response time: {statistics.mean(times)*1000:.2f}ms')
              print(f'  Min response time: {min(times)*1000:.2f}ms')
              print(f'  Max response time: {max(times)*1000:.2f}ms')
              print(f'  Median response time: {statistics.median(times)*1000:.2f}ms')
          '@
          
          $loadTest | Out-File -FilePath load_test.py -Encoding utf8
          python load_test.py
        shell: pwsh
      
      - name: Cleanup
        if: always()
        run: |
          Write-Host ""
          Write-Host "Cleaning up..."
          
          if (Test-Path "server_pid.txt") {
            $serverId = Get-Content "server_pid.txt"
            try {
              Stop-Process -Id $serverId -Force -ErrorAction SilentlyContinue
              Write-Host "[OK] Stopped server process $serverId"
            } catch {
              Write-Host "[INFO] Process already stopped"
            }
          }
          
          # Kill any remaining Python processes
          Get-Process python -ErrorAction SilentlyContinue | Stop-Process -Force
          Write-Host "[OK] Cleanup complete"
        shell: pwsh
