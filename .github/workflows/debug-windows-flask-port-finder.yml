name: "ðŸªŸ Windows Flask Parallel Test"

on:
  workflow_dispatch:

jobs:
  windows-flask-parallel:
    runs-on: windows-latest
    name: "Parallel Flask Methods"
    
    steps:
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flask requests waitress
          Write-Host "[OK] Dependencies installed"
        shell: pwsh
      
      - name: Create Flask Apps on Different Ports
        run: |
          # Method 1: Standard Flask (Port 5001)
          $app1 = @'
          from flask import Flask
          import sys
          
          app = Flask(__name__)
          
          @app.route('/')
          def hello():
              return 'Method 1: Standard Flask on 5001'
          
          if __name__ == '__main__':
              print('[M1] Starting on 0.0.0.0:5001', file=sys.stderr, flush=True)
              app.run(host='0.0.0.0', port=5001, use_reloader=False, threaded=True)
          '@
          
          # Method 2: Flask with 127.0.0.1 (Port 5002)
          $app2 = @'
          from flask import Flask
          import sys
          
          app = Flask(__name__)
          
          @app.route('/')
          def hello():
              return 'Method 2: Flask on 127.0.0.1:5002'
          
          if __name__ == '__main__':
              print('[M2] Starting on 127.0.0.1:5002', file=sys.stderr, flush=True)
              app.run(host='127.0.0.1', port=5002, use_reloader=False, threaded=True)
          '@
          
          # Method 3: Waitress WSGI (Port 5003)
          $app3 = @'
          from flask import Flask
          from waitress import serve
          import sys
          
          app = Flask(__name__)
          
          @app.route('/')
          def hello():
              return 'Method 3: Waitress WSGI on 5003'
          
          if __name__ == '__main__':
              print('[M3] Starting Waitress on 0.0.0.0:5003', file=sys.stderr, flush=True)
              serve(app, host='0.0.0.0', port=5003)
          '@
          
          # Method 4: Flask with SO_REUSEADDR (Port 5004)
          $app4 = @'
          from flask import Flask
          import sys
          import socket
          
          app = Flask(__name__)
          
          @app.route('/')
          def hello():
              return 'Method 4: Flask with SO_REUSEADDR on 5004'
          
          if __name__ == '__main__':
              print('[M4] Starting with SO_REUSEADDR on 0.0.0.0:5004', file=sys.stderr, flush=True)
              
              # Monkey-patch socket to set SO_REUSEADDR
              original_socket = socket.socket
              def patched_socket(*args, **kwargs):
                  s = original_socket(*args, **kwargs)
                  s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
                  return s
              socket.socket = patched_socket
              
              app.run(host='0.0.0.0', port=5004, use_reloader=False, threaded=True)
          '@
          
          # Method 5: Windows-specific localhost (Port 5005)
          $app5 = @'
          from flask import Flask
          import sys
          
          app = Flask(__name__)
          
          @app.route('/')
          def hello():
              return 'Method 5: Flask on localhost:5005'
          
          if __name__ == '__main__':
              print('[M5] Starting on localhost:5005', file=sys.stderr, flush=True)
              app.run(host='localhost', port=5005, use_reloader=False, threaded=True)
          '@
          
          $app1 | Out-File -FilePath flask_app1.py -Encoding utf8
          $app2 | Out-File -FilePath flask_app2.py -Encoding utf8
          $app3 | Out-File -FilePath flask_app3.py -Encoding utf8
          $app4 | Out-File -FilePath flask_app4.py -Encoding utf8
          $app5 | Out-File -FilePath flask_app5.py -Encoding utf8
          
          Write-Host "[OK] All 5 Flask apps created"
        shell: pwsh
      
      - name: Launch All Methods in Parallel
        run: |
          Write-Host "=========================================="
          Write-Host "LAUNCHING ALL 5 METHODS IN PARALLEL"
          Write-Host "=========================================="
          
          # Start all 5 methods without stderr redirect (this seems to be critical!)
          $procs = @()
          
          1..5 | ForEach-Object {
            $proc = Start-Process python `
              -ArgumentList "flask_app$_.py" `
              -PassThru `
              -RedirectStandardOutput "flask$_.log" `
              -NoNewWindow
            
            $procs += $proc
            Write-Host "[OK] Method $_ started: PID $($proc.Id)"
          }
          
          Write-Host ""
          Write-Host "[INFO] Waiting 15 seconds for all servers to start..."
          Start-Sleep -Seconds 15
          
          # Check which processes are still alive
          Write-Host ""
          Write-Host "=== PROCESS STATUS ==="
          1..5 | ForEach-Object {
            $proc = $procs[$_ - 1]
            $isRunning = Get-Process -Id $proc.Id -ErrorAction SilentlyContinue
            if ($isRunning) {
              Write-Host "[OK] Method $_ (PID $($proc.Id)): RUNNING"
            } else {
              Write-Host "[FAIL] Method $_ (PID $($proc.Id)): DEAD"
            }
          }
          
          # Save PIDs
          $procs | ForEach-Object { $_.Id } | Out-File -FilePath "pids.txt" -Encoding ascii
        shell: pwsh
      
      - name: Check All Ports Simultaneously
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "PORT STATUS CHECK (All 5 ports)"
          Write-Host "=========================================="
          
          Write-Host ""
          Write-Host "=== NETSTAT OUTPUT ==="
          netstat -ano | Select-String "500[1-5]"
          
          Write-Host ""
          Write-Host "=== SOCKET TESTS ==="
          $socketTest = @'
          import socket
          
          for port in [5001, 5002, 5003, 5004, 5005]:
              try:
                  sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                  sock.settimeout(2)
                  result = sock.connect_ex(('127.0.0.1', port))
                  if result == 0:
                      print(f'[OK] Port {port} is OPEN')
                  else:
                      print(f'[FAIL] Port {port} closed (error {result})')
                  sock.close()
              except Exception as e:
                  print(f'[ERROR] Port {port}: {e}')
          '@
          python -c $socketTest
        shell: pwsh
      
      - name: HTTP Tests on All Ports
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "HTTP REQUEST TESTS (All 5 methods)"
          Write-Host "=========================================="
          
          $httpTest = @'
          import requests
          import time
          
          for port in [5001, 5002, 5003, 5004, 5005]:
              print(f'\n--- Testing port {port} ---')
              success = False
              for attempt in range(3):
                  try:
                      response = requests.get(f'http://127.0.0.1:{port}', timeout=5)
                      print(f'[OK] Status: {response.status_code}')
                      print(f'[OK] Response: {response.text}')
                      success = True
                      break
                  except requests.exceptions.ConnectionError:
                      print(f'[FAIL] Attempt {attempt+1}: Connection refused')
                  except Exception as e:
                      print(f'[FAIL] Attempt {attempt+1}: {type(e).__name__}: {e}')
                  time.sleep(1)
              
              if not success:
                  print(f'[FAIL] Port {port} completely unreachable')
          '@
          python -c $httpTest
        shell: pwsh
      
      - name: Show Server Logs
        if: always()
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "SERVER LOGS"
          Write-Host "=========================================="
          
          1..5 | ForEach-Object {
            Write-Host ""
            Write-Host "=== METHOD $_ LOG ==="
            if (Test-Path "flask$_.log") {
              Get-Content "flask$_.log"
            } else {
              Write-Host "(no log file)"
            }
          }
        shell: pwsh
      
      - name: Advanced Diagnostics
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "ADVANCED DIAGNOSTICS"
          Write-Host "=========================================="
          
          Write-Host ""
          Write-Host "=== Python processes ==="
          Get-Process python -ErrorAction SilentlyContinue | Format-Table Id, ProcessName, StartTime
          
          Write-Host ""
          Write-Host "=== Firewall check ==="
          Get-NetFirewallProfile | Select-Object Name, Enabled
          
          Write-Host ""
          Write-Host "=== Listening ports ==="
          Get-NetTCPConnection -State Listen | Where-Object {$_.LocalPort -ge 5001 -and $_.LocalPort -le 5005} | Format-Table
          
          Write-Host ""
          Write-Host "=== Test with PowerShell WebRequest ==="
          5001..5005 | ForEach-Object {
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:$_" -TimeoutSec 3 -ErrorAction Stop
              Write-Host "[OK] Port $_`: $($response.StatusCode) - $($response.Content)"
            } catch {
              Write-Host "[FAIL] Port $_`: $($_.Exception.Message)"
            }
          }
        shell: pwsh
      
      - name: Cleanup
        if: always()
        run: |
          Write-Host ""
          Write-Host "Cleaning up..."
          Get-Process python -ErrorAction SilentlyContinue | Stop-Process -Force
          Write-Host "[OK] Cleanup complete"
        shell: pwsh
