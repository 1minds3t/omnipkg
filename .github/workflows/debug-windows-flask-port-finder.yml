name: "ðŸªŸ Windows Flask - Self-Test Approach"

on:
  workflow_dispatch:

jobs:
  windows-flask-test:
    runs-on: windows-latest
    name: "Flask Self-Test"
    
    steps:
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flask requests waitress
          Write-Host "[OK] Dependencies installed"
        shell: pwsh
      
      - name: Test 1 - Flask with Self-Test Client
        run: |
          Write-Host "=========================================="
          Write-Host "TEST 1: Flask with built-in test client"
          Write-Host "=========================================="
          
          $app = @'
          from flask import Flask
          import sys
          import time
          from threading import Thread
          import requests
          
          app = Flask(__name__)
          
          @app.route('/')
          def hello():
              return 'Flask Self-Test Success!'
          
          def test_client():
              print('[TEST] Waiting 5 seconds for server startup...', flush=True)
              time.sleep(5)
              
              print('[TEST] Attempting to connect to server...', flush=True)
              for i in range(10):
                  try:
                      response = requests.get('http://127.0.0.1:5001', timeout=2)
                      print(f'[SUCCESS] Got response: {response.status_code}', flush=True)
                      print(f'[SUCCESS] Content: {response.text}', flush=True)
                      return
                  except Exception as e:
                      print(f'[TEST] Attempt {i+1} failed: {type(e).__name__}', flush=True)
                      time.sleep(1)
              
              print('[FAIL] All test attempts failed', flush=True)
          
          if __name__ == '__main__':
              # Start test client in background
              test_thread = Thread(target=test_client, daemon=True)
              test_thread.start()
              
              print('[SERVER] Starting Flask on 127.0.0.1:5001...', flush=True)
              
              # Run server for 20 seconds then exit
              import signal
              def timeout_handler(signum, frame):
                  print('[SERVER] Timeout reached, exiting...', flush=True)
                  sys.exit(0)
              
              try:
                  signal.signal(signal.SIGALRM, timeout_handler)
                  signal.alarm(20)
              except:
                  pass  # Windows doesn't have SIGALRM
              
              app.run(host='127.0.0.1', port=5001, debug=False, use_reloader=False)
          '@
          
          $app | Out-File -FilePath self_test.py -Encoding utf8
          
          $env:PYTHONIOENCODING = "utf-8"
          python self_test.py
        shell: pwsh
        timeout-minutes: 1
        continue-on-error: true
      
      - name: Test 2 - Server in Background, Test in Foreground
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "TEST 2: Background server, foreground test"
          Write-Host "=========================================="
          
          $server = @'
          from flask import Flask
          import sys
          
          app = Flask(__name__)
          
          @app.route('/')
          def hello():
              return 'Background Flask Success!'
          
          if __name__ == '__main__':
              print('[SERVER] Starting on 127.0.0.1:5002...', file=sys.stderr, flush=True)
              app.run(host='127.0.0.1', port=5002, debug=False, use_reloader=False)
          '@
          
          $server | Out-File -FilePath bg_server.py -Encoding utf8
          
          # Start server as background process (not job)
          $proc = Start-Process python `
            -ArgumentList "bg_server.py" `
            -PassThru `
            -WindowStyle Hidden
          
          Write-Host "[OK] Server started as PID $($proc.Id)"
          Write-Host "[INFO] Waiting 10 seconds..."
          Start-Sleep -Seconds 10
          
          # Check if it's still running
          $stillRunning = Get-Process -Id $proc.Id -ErrorAction SilentlyContinue
          if ($stillRunning) {
            Write-Host "[OK] Process still alive"
          } else {
            Write-Host "[FAIL] Process died"
          }
          
          # Test from same PowerShell session
          Write-Host "[TEST] Testing connection..."
          $env:PYTHONIOENCODING = "utf-8"
          python -c @"
          import requests
          import time
          
          for i in range(5):
              try:
                  r = requests.get('http://127.0.0.1:5002', timeout=3)
                  print(f'[SUCCESS] Status: {r.status_code}, Content: {r.text}')
                  break
              except Exception as e:
                  print(f'[FAIL] Attempt {i+1}: {type(e).__name__}: {e}')
                  time.sleep(2)
          "@
          
          # Cleanup
          Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
        shell: pwsh
      
      - name: Test 3 - Simple Socket Server + Telnet-style Test
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "TEST 3: Raw socket with manual connection"
          Write-Host "=========================================="
          
          $combo = @'
          import socket
          import sys
          import time
          from threading import Thread
          
          def run_server():
              try:
                  server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                  server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
                  server.bind(('127.0.0.1', 5003))
                  server.listen(1)
                  print('[SERVER] Listening on 127.0.0.1:5003', flush=True)
                  
                  server.settimeout(15)  # Timeout after 15 seconds
                  conn, addr = server.accept()
                  print(f'[SERVER] Connection from {addr}!', flush=True)
                  
                  data = conn.recv(1024)
                  print(f'[SERVER] Received: {data[:50]}', flush=True)
                  
                  response = b'HTTP/1.1 200 OK\r\nContent-Length: 21\r\n\r\nRaw Socket Success!!!'
                  conn.sendall(response)
                  print('[SERVER] Sent response', flush=True)
                  
                  conn.close()
                  server.close()
              except Exception as e:
                  print(f'[SERVER] Error: {e}', flush=True)
                  import traceback
                  traceback.print_exc()
          
          def run_client():
              print('[CLIENT] Waiting 3 seconds...', flush=True)
              time.sleep(3)
              
              for i in range(10):
                  try:
                      print(f'[CLIENT] Attempt {i+1}: Connecting to 127.0.0.1:5003...', flush=True)
                      sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                      sock.settimeout(2)
                      sock.connect(('127.0.0.1', 5003))
                      print('[CLIENT] Connected!', flush=True)
                      
                      request = b'GET / HTTP/1.1\r\nHost: localhost\r\n\r\n'
                      sock.sendall(request)
                      print('[CLIENT] Sent request', flush=True)
                      
                      response = sock.recv(1024)
                      print(f'[CLIENT] Received: {response}', flush=True)
                      
                      sock.close()
                      print('[SUCCESS] Raw socket communication worked!', flush=True)
                      return
                  except Exception as e:
                      print(f'[CLIENT] Attempt {i+1} failed: {type(e).__name__}: {e}', flush=True)
                      time.sleep(1)
              
              print('[FAIL] All client attempts failed', flush=True)
          
          if __name__ == '__main__':
              server_thread = Thread(target=run_server)
              server_thread.start()
              
              run_client()
              
              server_thread.join(timeout=5)
              print('[DONE]', flush=True)
          '@
          
          $combo | Out-File -FilePath socket_test.py -Encoding utf8
          $env:PYTHONIOENCODING = "utf-8"
          python socket_test.py
        shell: pwsh
      
      - name: Test 4 - HTTP Server with Direct Test
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "TEST 4: http.server with urllib test"
          Write-Host "=========================================="
          
          $combo = @'
          from http.server import HTTPServer, BaseHTTPRequestHandler
          import urllib.request
          import sys
          import time
          from threading import Thread
          
          class Handler(BaseHTTPRequestHandler):
              def do_GET(self):
                  self.send_response(200)
                  self.send_header('Content-type', 'text/plain')
                  self.end_headers()
                  self.wfile.write(b'HTTP.Server Success!')
              
              def log_message(self, format, *args):
                  print(f'[SERVER] {format % args}', flush=True)
          
          def run_server():
              try:
                  server = HTTPServer(('127.0.0.1', 5004), Handler)
                  print('[SERVER] Listening on 127.0.0.1:5004', flush=True)
                  
                  # Handle one request then stop
                  server.handle_request()
                  print('[SERVER] Handled request, shutting down', flush=True)
              except Exception as e:
                  print(f'[SERVER] Error: {e}', flush=True)
          
          def run_client():
              print('[CLIENT] Waiting 3 seconds...', flush=True)
              time.sleep(3)
              
              for i in range(5):
                  try:
                      print(f'[CLIENT] Attempt {i+1}...', flush=True)
                      response = urllib.request.urlopen('http://127.0.0.1:5004', timeout=3)
                      content = response.read().decode()
                      print(f'[SUCCESS] Got: {content}', flush=True)
                      return
                  except Exception as e:
                      print(f'[CLIENT] Failed: {type(e).__name__}: {e}', flush=True)
                      time.sleep(1)
              
              print('[FAIL] All attempts failed', flush=True)
          
          if __name__ == '__main__':
              server_thread = Thread(target=run_server)
              server_thread.start()
              
              run_client()
              
              server_thread.join(timeout=5)
          '@
          
          $combo | Out-File -FilePath http_test.py -Encoding utf8
          $env:PYTHONIOENCODING = "utf-8"
          python http_test.py
        shell: pwsh
      
      - name: Test 5 - Check What Netstat Actually Shows
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "TEST 5: Start server and check netstat IMMEDIATELY"
          Write-Host "=========================================="
          
          $server = @'
          import socket
          import time
          
          sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
          sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
          sock.bind(('127.0.0.1', 5005))
          sock.listen(5)
          print('BOUND', flush=True)
          
          # Keep alive for 30 seconds
          time.sleep(30)
          '@
          
          $server | Out-File -FilePath netstat_test.py -Encoding utf8
          
          # Start in background
          $proc = Start-Process python `
            -ArgumentList "netstat_test.py" `
            -PassThru `
            -RedirectStandardOutput "netstat_out.txt" `
            -WindowStyle Hidden
          
          Write-Host "[OK] Started PID $($proc.Id)"
          
          # Wait for "BOUND" message
          Start-Sleep -Seconds 2
          
          if (Test-Path "netstat_out.txt") {
            $output = Get-Content "netstat_out.txt"
            Write-Host "[INFO] Server output: $output"
          }
          
          Write-Host ""
          Write-Host "=== NETSTAT (immediately after bind) ==="
          netstat -ano | Select-String "5005"
          
          Write-Host ""
          Write-Host "=== Get-NetTCPConnection ==="
          Get-NetTCPConnection -LocalPort 5005 -ErrorAction SilentlyContinue | Format-Table
          
          Write-Host ""
          Write-Host "=== Process info ==="
          Get-Process -Id $proc.Id -ErrorAction SilentlyContinue | Format-Table Id, ProcessName, @{Name="Handles";Expression={$_.HandleCount}}
          
          Write-Host ""
          Write-Host "=== Python socket test ==="
          python -c @"
          import socket
          sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
          sock.settimeout(2)
          result = sock.connect_ex(('127.0.0.1', 5005))
          print(f'Connect result: {result}')
          if result == 0:
              print('SUCCESS: Port is listening!')
          else:
              print(f'FAIL: Port not listening (error {result})')
          sock.close()
          "@
          
          # Cleanup
          Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
        shell: pwsh
