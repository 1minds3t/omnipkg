name: Build and Upload Conda Packages (Noarch + Platform)

on:
  workflow_run:
    workflows: ["Publish to PyPI"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version to build'
        required: true
        type: string
      update_feedstock:
        description: 'Update conda-forge feedstock (yes/no)'
        required: false
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'

jobs:
  # Job 1: Wait for PyPI availability
  wait-for-pypi:
    runs-on: ubuntu-latest
    timeout-minutes: 300
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      sha256: ${{ steps.get-sha.outputs.sha256 }}
    steps:
    - name: Get version from workflow or input
      id: get-version
      run: |
        if [ "${{ github.event_name }}" == "workflow_run" ]; then
          VERSION=$(echo "${{ github.event.workflow_run.head_branch }}" | sed 's/^v//')
          if [ -z "$VERSION" ]; then
            VERSION=$(gh api repos/${{ github.repository }}/releases/latest --jq '.tag_name' | sed 's/^v//')
          fi
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "üîç Waiting for version: $VERSION"
      env:
        GH_TOKEN: ${{ github.token }}
        
    - name: Wait for PyPI package availability
      id: wait-pypi
      run: |
        VERSION="${{ steps.get-version.outputs.version }}"
        MAX_ATTEMPTS=600
        SLEEP_TIME=30
        
        echo "‚è≥ Checking for omnipkg version $VERSION on PyPI..."
        
        for i in $(seq 1 $MAX_ATTEMPTS); do
          ELAPSED=$((i * SLEEP_TIME / 60))
          echo "üîÑ Attempt $i/$MAX_ATTEMPTS (${ELAPSED} minutes elapsed)..."
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://pypi.org/pypi/omnipkg/$VERSION/json")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Package version found on PyPI API!"
            
            DOWNLOAD_URL="https://files.pythonhosted.org/packages/source/o/omnipkg/omnipkg-$VERSION.tar.gz"
            DOWNLOAD_CODE=$(curl -s -o /dev/null -w "%{http_code}" -I "$DOWNLOAD_URL")
            
            if [ "$DOWNLOAD_CODE" = "200" ] || [ "$DOWNLOAD_CODE" = "302" ]; then
              echo "‚úÖ Package file is downloadable!"
              sleep 10
              break
            else
              echo "‚ö†Ô∏è  Package found but file not yet on CDN (HTTP $DOWNLOAD_CODE)"
            fi
          else
            echo "‚è≥ Package not available (HTTP $HTTP_CODE)"
          fi
          
          if [ $i -eq $MAX_ATTEMPTS ]; then
            echo "‚ùå Package not found after 5 hours"
            exit 1
          fi
          
          if [ $i -gt 60 ]; then
            SLEEP_TIME=60
          fi
          
          sleep $SLEEP_TIME
        done
        
    - name: Download and calculate SHA256
      id: get-sha
      run: |
        VERSION="${{ steps.get-version.outputs.version }}"
        
        echo "üì¶ Downloading package from PyPI..."
        if ! curl -L -f -o "omnipkg-$VERSION.tar.gz" \
          "https://files.pythonhosted.org/packages/source/o/omnipkg/omnipkg-$VERSION.tar.gz"; then
          echo "‚ö†Ô∏è  CDN failed, trying fallback..."
          curl -L -f -o "omnipkg-$VERSION.tar.gz" \
            "https://pypi.org/packages/source/o/omnipkg/omnipkg-$VERSION.tar.gz"
        fi
        
        FILE_SIZE=$(wc -c < "omnipkg-$VERSION.tar.gz")
        echo "üìä File size: $FILE_SIZE bytes"
        if [ "$FILE_SIZE" -lt 10000 ]; then
          echo "‚ùå Downloaded file too small ($FILE_SIZE bytes)"
          exit 1
        fi
        
        SHA256=$(sha256sum "omnipkg-$VERSION.tar.gz" | cut -d' ' -f1)
        echo "sha256=$SHA256" >> $GITHUB_OUTPUT
        echo "‚úÖ SHA256: $SHA256"

  # Job 2: Update local meta.yaml templates
  update-local-metas:
    needs: wait-for-pypi
    runs-on: ubuntu-latest
    steps:
    - name: Checkout omnipkg repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update meta-noarch.yaml
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "üìù Updating meta-noarch.yaml"
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" src/omnipkg/conda-recipe/meta-noarch.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" src/omnipkg/conda-recipe/meta-noarch.yaml
        
        echo "‚úÖ Updated meta-noarch.yaml"
        head -30 src/omnipkg/conda-recipe/meta-noarch.yaml
        
    - name: Update meta-platform.yaml
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "üìù Updating meta-platform.yaml"
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" src/omnipkg/conda-recipe/meta-platform.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" src/omnipkg/conda-recipe/meta-platform.yaml
        sed -i "s/number: 0/number: 1/" src/omnipkg/conda-recipe/meta-platform.yaml
        
        echo "‚úÖ Updated meta-platform.yaml"
        head -30 src/omnipkg/conda-recipe/meta-platform.yaml
        
    - name: Commit and push updates
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add src/omnipkg/conda-recipe/meta-noarch.yaml src/omnipkg/conda-recipe/meta-platform.yaml
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit"
        else
          git commit -m "chore: update conda meta files to version $VERSION"
          git push
          echo "‚úÖ Changes pushed"
        fi

  # Job 3: Build noarch for custom channel (build 0)
  build-noarch:
    needs: [wait-for-pypi, update-local-metas]
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.11'
        channels: conda-forge,defaults
        channel-priority: strict

    - name: Install conda-build and anaconda-client
      shell: bash -l {0}
      run: conda install conda-build anaconda-client -y
        
    - name: Copy meta-noarch.yaml to meta.yaml
      shell: bash -l {0}
      run: |
        cp src/omnipkg/conda-recipe/meta-noarch.yaml src/omnipkg/conda-recipe/meta.yaml
        echo "üìã Using noarch configuration (build 0):"
        head -30 src/omnipkg/conda-recipe/meta.yaml
        
    - name: Build noarch conda package
      shell: bash -l {0}
      run: |
        export PYTHONIOENCODING=UTF-8
        conda build src/omnipkg/conda-recipe --output-folder ./conda-dist
        echo "‚úÖ Noarch package built (build 0)"
        
    - name: Upload to custom channel (minds3t)
      shell: bash -l {0}
      run: |
        find ./conda-dist -name "*.conda" -o -name "*.tar.bz2" | while read file; do
          echo "üì§ Uploading $file to anaconda.org/minds3t"
          anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload "$file" --force --user minds3t
        done
        echo "‚úÖ Noarch package uploaded to custom channel"
      env:
        ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN }}

  # Job 4: Build platform-specific for custom channel (build 1)
  build-platform:
    needs: [wait-for-pypi, build-noarch]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            platform: linux-64
          # Linux ARM64
          - os: ubuntu-latest
            platform: linux-aarch64
          # Linux ppc64le  
          - os: ubuntu-latest
            platform: linux-ppc64le
          # macOS Intel
          - os: macos-13
            platform: osx-64
          # macOS Apple Silicon
          - os: macos-latest
            platform: osx-arm64
          # Windows x86_64
          - os: windows-latest
            platform: win-64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.11'
        channels: conda-forge,defaults
        channel-priority: strict

    - name: Install conda-build and anaconda-client
      shell: bash -l {0}
      run: conda install conda-build anaconda-client -y

    - name: Install cross-compilation tools (Linux ARM/PPC only)
      if: matrix.platform == 'linux-aarch64' || matrix.platform == 'linux-ppc64le'
      shell: bash -l {0}
      run: |
        conda install -y -c conda-forge qemu-user-static
        
    - name: Copy meta-platform.yaml to meta.yaml
      shell: bash -l {0}
      run: |
        cp src/omnipkg/conda-recipe/meta-platform.yaml src/omnipkg/conda-recipe/meta.yaml
        echo "üìã Using platform configuration (build 1) for ${{ matrix.platform }}:"
        head -30 src/omnipkg/conda-recipe/meta.yaml
        
    - name: Build platform-specific package
      shell: bash -l {0}
      run: |
        export PYTHONIOENCODING=UTF-8
        
        # Set platform-specific build flags
        if [ "${{ matrix.platform }}" = "linux-aarch64" ]; then
          export CONDA_SUBDIR=linux-aarch64
          conda build src/omnipkg/conda-recipe --output-folder ./conda-dist -m .ci_support/linux_aarch64_.yaml || true
        elif [ "${{ matrix.platform }}" = "linux-ppc64le" ]; then
          export CONDA_SUBDIR=linux-ppc64le
          conda build src/omnipkg/conda-recipe --output-folder ./conda-dist -m .ci_support/linux_ppc64le_.yaml || true
        else
          conda build src/omnipkg/conda-recipe --output-folder ./conda-dist
        fi
        
        echo "‚úÖ Platform package built for ${{ matrix.platform }}"
        
    - name: Upload to custom channel (minds3t)
      shell: bash -l {0}
      run: |
        find ./conda-dist -name "*.conda" -o -name "*.tar.bz2" | while read file; do
          echo "üì§ Uploading $file to anaconda.org/minds3t"
          anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload "$file" --force --user minds3t
        done
        echo "‚úÖ Platform package uploaded to custom channel"
      env:
        ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN }}

  # Job 5: Update conda-forge feedstock (OPTIONAL)
  update-feedstock:
    needs: [wait-for-pypi, build-platform]
    if: github.event.inputs.update_feedstock == 'yes' || github.event_name == 'workflow_run'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - name: Checkout feedstock fork
      uses: actions/checkout@v4
      with:
        repository: 1minds3t/omnipkg-feedstock
        token: ${{ secrets.FEEDSTOCK_TOKEN }}
        path: feedstock

    - name: Update feedstock meta.yaml
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "üìù Updating recipe/meta.yaml to version $VERSION"
        
        # Update version and SHA
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" recipe/meta.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" recipe/meta.yaml
        
        # For feedstock, typically use build 0 and let conda-forge increment
        sed -i "s/number: .*/number: 0/" recipe/meta.yaml
        
        echo "‚úÖ Updated meta.yaml:"
        head -40 recipe/meta.yaml
        
    - name: Commit and push to fork
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add recipe/meta.yaml
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit"
          exit 0
        fi
        
        git commit -m "Update omnipkg to $VERSION"
        git push origin main
        echo "‚úÖ Changes pushed to fork"
        
    - name: Create PR to conda-forge
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.FEEDSTOCK_TOKEN }}
        path: feedstock
        commit-message: "Update omnipkg to ${{ needs.wait-for-pypi.outputs.version }}"
        title: "Update omnipkg to ${{ needs.wait-for-pypi.outputs.version }}"
        body: |
          ü§ñ Automated update to omnipkg version ${{ needs.wait-for-pypi.outputs.version }}
          
          **Changes:**
          - ‚úÖ Version: ${{ needs.wait-for-pypi.outputs.version }}
          - ‚úÖ SHA256: ${{ needs.wait-for-pypi.outputs.sha256 }}
          - ‚úÖ Build number: 0
          
          **Supported platforms:**
          - linux-64, linux-aarch64, linux-ppc64le
          - osx-64, osx-arm64
          - win-64
          - noarch
          
          This PR updates the recipe for the latest release. All platform builds are available on anaconda.org/minds3t.
        branch: "update-v${{ needs.wait-for-pypi.outputs.version }}"
        base: main
        delete-branch: true
