name: Build and Upload Conda Packages (Noarch + Platform)

on:
  # Trigger from your publish.yml workflow
  workflow_run:
    workflows: ["Publish to PyPI"]  # Name of your publish workflow
    types:
      - completed
  # Manual trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version to build'
        required: true
        type: string

jobs:
  # Job 1: Wait for PyPI availability (extended timeout)
  wait-for-pypi:
    runs-on: ubuntu-latest
    timeout-minutes: 300  # 5 hours max wait
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      sha256: ${{ steps.get-sha.outputs.sha256 }}
    steps:
    - name: Get version from workflow or input
      id: get-version
      run: |
        if [ "${{ github.event_name }}" == "workflow_run" ]; then
          # Extract version from the triggering workflow's tag
          VERSION=$(echo "${{ github.event.workflow_run.head_branch }}" | sed 's/^v//')
          # Fallback: try to get from release tag
          if [ -z "$VERSION" ]; then
            VERSION=$(gh api repos/${{ github.repository }}/releases/latest --jq '.tag_name' | sed 's/^v/')
          fi
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "üîç Waiting for version: $VERSION"
      env:
        GH_TOKEN: ${{ github.token }}
        
    - name: Wait for PyPI package availability (extended)
      id: wait-pypi
      run: |
        VERSION="${{ steps.get-version.outputs.version }}"
        MAX_ATTEMPTS=600  # 5 hours: 600 attempts * 30 seconds
        SLEEP_TIME=30
        
        echo "‚è≥ Checking for omnipkg version $VERSION on PyPI (will try for up to 5 hours)..."
        
        for i in $(seq 1 $MAX_ATTEMPTS); do
          ELAPSED=$((i * SLEEP_TIME / 60))
          echo "üîÑ Attempt $i/$MAX_ATTEMPTS (${ELAPSED} minutes elapsed)..."
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://pypi.org/pypi/omnipkg/$VERSION/json")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Package version found on PyPI API!"
            
            DOWNLOAD_URL="https://files.pythonhosted.org/packages/source/o/omnipkg/omnipkg-$VERSION.tar.gz"
            DOWNLOAD_CODE=$(curl -s -o /dev/null -w "%{http_code}" -I "$DOWNLOAD_URL")
            
            if [ "$DOWNLOAD_CODE" = "200" ] || [ "$DOWNLOAD_CODE" = "302" ]; then
              echo "‚úÖ Package file is downloadable! Proceeding."
              sleep 10  # Extra buffer for CDN propagation
              break
            else
              echo "‚ö†Ô∏è  Package found in API but file not yet available on CDN (HTTP $DOWNLOAD_CODE)"
            fi
          else
            echo "‚è≥ Package not yet available on API (HTTP $HTTP_CODE)"
          fi
          
          if [ $i -eq $MAX_ATTEMPTS ]; then
            echo "‚ùå Package not found after 5 hours ($MAX_ATTEMPTS attempts)"
            echo "üìç Check: https://pypi.org/project/omnipkg/$VERSION/"
            exit 1
          fi
          
          # Progressive backoff: increase wait time after 30 minutes
          if [ $i -gt 60 ]; then
            SLEEP_TIME=60  # Increase to 1 minute intervals
          fi
          
          echo "üí§ Waiting ${SLEEP_TIME}s before next attempt..."
          sleep $SLEEP_TIME
        done
        
    - name: Download and calculate SHA256
      id: get-sha
      run: |
        VERSION="${{ steps.get-version.outputs.version }}"
        
        echo "üì¶ Downloading package from PyPI..."
        if ! curl -L -f -o "omnipkg-$VERSION.tar.gz" \
          "https://files.pythonhosted.org/packages/source/o/omnipkg/omnipkg-$VERSION.tar.gz"; then
          echo "‚ö†Ô∏è  CDN failed, trying pypi.org fallback..."
          curl -L -f -o "omnipkg-$VERSION.tar.gz" \
            "https://pypi.org/packages/source/o/omnipkg/omnipkg-$VERSION.tar.gz"
        fi
        
        FILE_SIZE=$(wc -c < "omnipkg-$VERSION.tar.gz")
        echo "üìä File size: $FILE_SIZE bytes"
        if [ "$FILE_SIZE" -lt 10000 ]; then
          echo "‚ùå Error: Downloaded file is too small ($FILE_SIZE bytes)"
          exit 1
        fi
        
        echo "üîê Calculating SHA256..."
        SHA256=$(sha256sum "omnipkg-$VERSION.tar.gz" | cut -d' ' -f1)
        
        echo "sha256=$SHA256" >> $GITHUB_OUTPUT
        echo "‚úÖ SHA256: $SHA256"

  # Job 2: Update local meta.yaml templates
  update-local-metas:
    needs: wait-for-pypi
    runs-on: ubuntu-latest
    steps:
    - name: Checkout omnipkg repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update meta-noarch.yaml
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "üìù Updating src/omnipkg/conda-recipe/meta-noarch.yaml"
        
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" src/omnipkg/conda-recipe/meta-noarch.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" src/omnipkg/conda-recipe/meta-noarch.yaml
        
        echo "‚úÖ Updated meta-noarch.yaml (first 30 lines):"
        head -30 src/omnipkg/conda-recipe/meta-noarch.yaml
        
    - name: Update meta-platform.yaml
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "üìù Updating src/omnipkg/conda-recipe/meta-platform.yaml"
        
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" src/omnipkg/conda-recipe/meta-platform.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" src/omnipkg/conda-recipe/meta-platform.yaml
        # Update build number to 1 for platform builds
        sed -i "s/number: 0/number: 1/" src/omnipkg/conda-recipe/meta-platform.yaml
        
        echo "‚úÖ Updated meta-platform.yaml (first 30 lines):"
        head -30 src/omnipkg/conda-recipe/meta-platform.yaml
        
    - name: Commit and push updates
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add src/omnipkg/conda-recipe/meta-noarch.yaml src/omnipkg/conda-recipe/meta-platform.yaml
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit"
        else
          git commit -m "chore: update conda meta files to version $VERSION"
          git push
          echo "‚úÖ Changes pushed to omnipkg repo"
        fi

  # Job 3: Build noarch package for your channel
  build-noarch:
    needs: [wait-for-pypi, update-local-metas]
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main  # Get latest with updated meta files

    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.11'
        channels: conda-forge,defaults
        channel-priority: strict

    - name: Install conda-build and anaconda-client
      shell: bash -l {0}
      run: conda install conda-build anaconda-client -y
        
    - name: Copy meta-noarch.yaml to meta.yaml
      shell: bash -l {0}
      run: |
        cp src/omnipkg/conda-recipe/meta-noarch.yaml src/omnipkg/conda-recipe/meta.yaml
        echo "üìã Using noarch configuration:"
        head -30 src/omnipkg/conda-recipe/meta.yaml
        
    - name: Build noarch conda package
      shell: bash -l {0}
      run: |
        export PYTHONIOENCODING=UTF-8
        conda build src/omnipkg/conda-recipe --output-folder ./conda-dist
        echo "‚úÖ Noarch package built"
        
    - name: Upload noarch to your Anaconda channel
      shell: bash -l {0}
      run: |
        find ./conda-dist -name "*.conda" -o -name "*.tar.bz2" | while read file; do
          echo "üì§ Uploading $file to your channel"
          anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload "$file" --force
        done
        echo "‚úÖ Noarch package uploaded"
      env:
        ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN }}

  # Job 4: Update conda-forge feedstock with noarch (build 0)
  update-feedstock-noarch:
    needs: [wait-for-pypi, build-noarch]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - name: Checkout your feedstock fork
      uses: actions/checkout@v4
      with:
        repository: 1minds3t/omnipkg-feedstock
        token: ${{ secrets.FEEDSTOCK_TOKEN }}
        path: feedstock

    - name: Update feedstock with noarch meta
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "üìù Updating recipe/meta.yaml to noarch version $VERSION (build 0)"
        
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" recipe/meta.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" recipe/meta.yaml
        sed -i "s/number: .*/number: 0/" recipe/meta.yaml
        
        # Ensure noarch: python is present
        if ! grep -q "noarch: python" recipe/meta.yaml; then
          sed -i "/^build:/a\\  noarch: python" recipe/meta.yaml
        fi
        
        echo "‚úÖ Updated meta.yaml (noarch, build 0):"
        head -40 recipe/meta.yaml
        
    - name: Commit and push noarch to fork
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add recipe/meta.yaml
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit"
        else
          git commit -m "Update omnipkg to version $VERSION (noarch)"
          git push origin main
          echo "‚úÖ Noarch changes pushed to fork"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.FEEDSTOCK_TOKEN }}
        
    - name: Create PR to conda-forge (noarch)
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.FEEDSTOCK_TOKEN }}
        path: feedstock
        commit-message: "Update omnipkg to version ${{ needs.wait-for-pypi.outputs.version }} (noarch)"
        title: "Update omnipkg to version ${{ needs.wait-for-pypi.outputs.version }} (noarch)"
        body: |
          ü§ñ Automated noarch update to omnipkg version ${{ needs.wait-for-pypi.outputs.version }}
          
          - ‚úÖ Updated version in meta.yaml
          - ‚úÖ Updated SHA256: ${{ needs.wait-for-pypi.outputs.sha256 }}
          - ‚úÖ Build number: 0 (noarch)
          - üì¶ Package type: noarch python
          
          This is the noarch build. A platform-specific build (build 1) will follow.
        branch: "noarch-v${{ needs.wait-for-pypi.outputs.version }}"
        base: main
        delete-branch: true

  # Job 5: Build platform-specific packages for your channel
  build-platform:
    needs: [wait-for-pypi, update-feedstock-noarch]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: ${{ matrix.python-version }}
        channels: conda-forge,defaults
        channel-priority: strict

    - name: Install conda-build and anaconda-client
      shell: bash -l {0}
      run: conda install conda-build anaconda-client -y
        
    - name: Copy meta-platform.yaml to meta.yaml
      shell: bash -l {0}
      run: |
        cp src/omnipkg/conda-recipe/meta-platform.yaml src/omnipkg/conda-recipe/meta.yaml
        echo "üìã Using platform-specific configuration:"
        head -30 src/omnipkg/conda-recipe/meta.yaml
        
    - name: Build platform-specific conda package
      shell: bash -l {0}
      run: |
        export PYTHONIOENCODING=UTF-8
        conda build src/omnipkg/conda-recipe --output-folder ./conda-dist
        echo "‚úÖ Platform package built for ${{ matrix.os }}"
        
    - name: Upload platform package to your Anaconda channel
      shell: bash -l {0}
      run: |
        find ./conda-dist -name "*.conda" -o -name "*.tar.bz2" | while read file; do
          echo "üì§ Uploading $file to your channel"
          anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload "$file" --force
        done
        echo "‚úÖ Platform package uploaded"
      env:
        ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN }}

  # Job 6: Update conda-forge feedstock with platform build (build 1)
  update-feedstock-platform:
    needs: [wait-for-pypi, build-platform]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - name: Checkout your feedstock fork
      uses: actions/checkout@v4
      with:
        repository: 1minds3t/omnipkg-feedstock
        token: ${{ secrets.FEEDSTOCK_TOKEN }}
        path: feedstock

    - name: Update feedstock with platform meta
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "üìù Updating recipe/meta.yaml to platform version $VERSION (build 1)"
        
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" recipe/meta.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" recipe/meta.yaml
        sed -i "s/number: .*/number: 1/" recipe/meta.yaml
        
        # Remove noarch: python line for platform builds
        sed -i "/noarch: python/d" recipe/meta.yaml
        
        echo "‚úÖ Updated meta.yaml (platform, build 1):"
        head -40 recipe/meta.yaml
        
    - name: Commit and push platform to fork
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add recipe/meta.yaml
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit"
        else
          git commit -m "Update omnipkg to version $VERSION (platform-specific)"
          git push origin main
          echo "‚úÖ Platform changes pushed to fork"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.FEEDSTOCK_TOKEN }}
        
    - name: Create PR to conda-forge (platform)
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.FEEDSTOCK_TOKEN }}
        path: feedstock
        commit-message: "Update omnipkg to version ${{ needs.wait-for-pypi.outputs.version }} (platform)"
        title: "Update omnipkg to version ${{ needs.wait-for-pypi.outputs.version }} (platform-specific)"
        body: |
          ü§ñ Automated platform-specific update to omnipkg version ${{ needs.wait-for-pypi.outputs.version }}
          
          - ‚úÖ Updated version in meta.yaml
          - ‚úÖ Updated SHA256: ${{ needs.wait-for-pypi.outputs.sha256 }}
          - ‚úÖ Build number: 1 (platform-specific)
          - üñ•Ô∏è  Package type: platform-specific (Linux, macOS, Windows)
          
          This is the platform-specific build (build 1), following the noarch build (build 0).
        branch: "platform-v${{ needs.wait-for-pypi.outputs.version }}"
        base: main
        delete-branch: true
