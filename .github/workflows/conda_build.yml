name: Build and Upload Conda Packages + Conda-Forge Automation

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version to build (e.g., 2.1.2)'
        required: true
        type: string

jobs:

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 1: Wait for PyPI and get SHA256 from PyPI directly
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  wait-for-pypi:
    runs-on: ubuntu-latest
    timeout-minutes: 1440
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      sha256: ${{ steps.get-sha.outputs.sha256 }}
    steps:
    - name: Get version from release or input
      id: get-version
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # ‚Üê STRIP the v here (ALREADY IN YOUR CODE!)
        else
          VERSION="${{ github.event.inputs.version }}"
          VERSION="${VERSION#v}"  # ‚Üê Also strip if manually entered with v
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "üîç Target version: $VERSION"
      
    - name: Wait for PyPI and extract SHA256
      id: get-sha
      run: |
        VERSION="${{ steps.get-version.outputs.version }}"
        
        echo "‚è≥ Waiting for omnipkg $VERSION on PyPI..."
        echo "‚è∞ No timeout - will wait as long as needed for your builds to complete"
        
        ATTEMPT=0
        while true; do
          ATTEMPT=$((ATTEMPT + 1))
          ELAPSED=$((ATTEMPT * 2))
          
          if [ $((ATTEMPT % 30)) -eq 0 ]; then
            echo "üïê Still waiting... ${ELAPSED} minutes elapsed"
          fi
          
          HTTP_CODE=$(curl -s -o pypi_response.json -w "%{http_code}" \
            "https://pypi.org/pypi/omnipkg/$VERSION/json")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Package found on PyPI!"
            
            SHA256=$(jq -r '.urls[] | select(.filename | endswith(".tar.gz")) | .digests.sha256' pypi_response.json)
            
            if [ -n "$SHA256" ] && [ "$SHA256" != "null" ]; then
              echo "‚úÖ SHA256 extracted from PyPI: $SHA256"
              echo "sha256=$SHA256" >> $GITHUB_OUTPUT
              break
            else
              echo "‚ö†Ô∏è  SHA256 not found in response, retrying..."
            fi
          fi
          
          sleep 120
        done
        
        rm -f pypi_response.json

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 2: Update local meta.yaml templates in main repo
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  update-local-metas:
    needs: wait-for-pypi
    runs-on: ubuntu-latest
    steps:
    - name: Checkout omnipkg repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main
        fetch-depth: 0

    - name: Update meta-noarch.yaml
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "üìù Updating src/omnipkg/conda-recipes/meta-noarch.yaml"
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" src/omnipkg/conda-recipes/meta-noarch.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" src/omnipkg/conda-recipes/meta-noarch.yaml
        
        echo "‚úÖ Updated meta-noarch.yaml"
        
    - name: Update meta-platforms.yaml
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "üìù Updating src/omnipkg/conda-recipes/meta-platforms.yaml"
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" src/omnipkg/conda-recipes/meta-platforms.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" src/omnipkg/conda-recipes/meta-platforms.yaml
        
        echo "‚úÖ Updated meta-platforms.yaml"
        
    - name: Create PR with conda meta updates
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        BRANCH="auto-update-conda-meta-$VERSION"
        
        git checkout -b "$BRANCH"
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add src/omnipkg/conda-recipes/meta-noarch.yaml src/omnipkg/conda-recipes/meta-platforms.yaml
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit"
        else
          git commit -m "chore: update conda meta files to version $VERSION"
          git push origin "$BRANCH"
          
          gh pr create \
            --title "chore: update conda meta files to version $VERSION" \
            --body "Automated update from release workflow" \
            --base main \
            --head "$BRANCH"
          
          echo "‚úÖ PR created for conda meta updates"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 3: Update conda-forge feedstock (NOARCH - Build 0)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  update-feedstock-noarch:
    name: "üöÄ Conda-Forge Noarch (Build 0)"
    needs: [wait-for-pypi, update-local-metas]
    runs-on: ubuntu-latest
    timeout-minutes: 120
    outputs:
      pr_number: ${{ steps.create-pr.outputs.pull-request-number }}
    steps:
    - name: Checkout feedstock fork
      uses: actions/checkout@v4
      with:
        repository: 1minds3t/omnipkg-feedstock
        token: ${{ secrets.FEEDSTOCK_TOKEN }}
        path: feedstock
        fetch-depth: 0

    - name: Sync fork with upstream
      run: |
        cd feedstock
        git remote add upstream https://github.com/conda-forge/omnipkg-feedstock.git
        git fetch upstream
        git checkout main
        git merge upstream/main --no-edit || echo "Already up to date"
        git push origin main
        echo "‚úÖ Fork synced with conda-forge/omnipkg-feedstock"

    - name: Checkout main repo for template
      uses: actions/checkout@v4
      with:
        path: main-repo

    - name: Update feedstock recipe/meta.yaml (NOARCH)
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "üìù Updating recipe/meta.yaml for NOARCH (build 0)"
        
        # Copy the noarch template from main repo
        cp ../main-repo/src/omnipkg/conda-recipes/meta-noarch.yaml recipe/meta.yaml
        
        # Ensure version and SHA256 are set correctly
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" recipe/meta.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" recipe/meta.yaml
        
        echo "‚úÖ Updated recipe/meta.yaml for NOARCH:"
        head -50 recipe/meta.yaml
        
    - name: Create branch and commit
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        BRANCH="update-noarch-v$VERSION"
        
        git checkout -b "$BRANCH"
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add recipe/meta.yaml
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit"
          echo "skip_pr=true" >> $GITHUB_ENV
        else
          git commit -m "Update omnipkg to $VERSION (noarch)"
          git push -f origin "$BRANCH"
          echo "‚úÖ Changes pushed to branch $BRANCH"
          echo "skip_pr=false" >> $GITHUB_ENV
        fi
        
    - name: Create PR to conda-forge
      id: create-pr
      if: env.skip_pr != 'true'
      env:
        GH_TOKEN: ${{ secrets.FEEDSTOCK_TOKEN }}
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        BRANCH="update-noarch-v$VERSION"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        # Use simple multi-line string assignment (safe in YAML)
        PR_BODY="ü§ñ Automated update to omnipkg version $VERSION (noarch build)

        **Changes:**
        - ‚úÖ Version: $VERSION
        - ‚úÖ SHA256: $SHA256
        - ‚úÖ Build number: 0
        - ‚úÖ Architecture: noarch

        This PR updates the recipe for conda-forge distribution."
        
        # Create PR
        PR_URL=$(gh pr create \
          --repo conda-forge/omnipkg-feedstock \
          --base main \
          --head 1minds3t:$BRANCH \
          --title "Update omnipkg to $VERSION (noarch)" \
          --body "$PR_BODY" || echo "")
        
        if [ -n "$PR_URL" ]; then
          PR_NUMBER=$(echo "$PR_URL" | grep -oP '\d+$')
          echo "‚úÖ PR created: $PR_URL"
          echo "pull-request-number=$PR_NUMBER" >> $GITHUB_OUTPUT
        else
          echo "‚ö†Ô∏è  PR may already exist, checking..."
          PR_NUMBER=$(gh pr list --repo conda-forge/omnipkg-feedstock --head 1minds3t:$BRANCH --json number --jq '.[0].number')
          echo "pull-request-number=$PR_NUMBER" >> $GITHUB_OUTPUT
        fi

    - name: Request re-render
      if: env.skip_pr != 'true' && steps.create-pr.outputs.pull-request-number != ''
      env:
        GH_TOKEN: ${{ secrets.FEEDSTOCK_TOKEN }}
      run: |
        cd feedstock
        PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
        
        echo "üîÑ Requesting re-render from @conda-forge-admin..."
        gh pr comment $PR_NUMBER \
          --repo conda-forge/omnipkg-feedstock \
          --body "@conda-forge-admin, please rerender"
        
        echo "‚úÖ Re-render requested, waiting 10 minutes for conda-forge-admin..."
        sleep 600  # Wait 10 minutes for re-render

    - name: Wait for checks to pass
      if: env.skip_pr != 'true' && steps.create-pr.outputs.pull-request-number != ''
      env:
        GH_TOKEN: ${{ secrets.FEEDSTOCK_TOKEN }}
      run: |
        PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
        
        echo "‚è≥ Waiting for CI checks to complete..."
        echo "‚è∞ Waiting additional 5 minutes for re-render to adjust builds..."
        sleep 300
        
        # Now wait for actual checks to pass
        ATTEMPT=0
        MAX_ATTEMPTS=60  # 2 hours max
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          
          # Get check status
          STATUS=$(gh pr view $PR_NUMBER \
            --repo conda-forge/omnipkg-feedstock \
            --json statusCheckRollup \
            --jq '.statusCheckRollup[] | select(.conclusion != null) | .conclusion' | sort -u)
          
          PENDING=$(gh pr view $PR_NUMBER \
            --repo conda-forge/omnipkg-feedstock \
            --json statusCheckRollup \
            --jq '.statusCheckRollup[] | select(.status == "IN_PROGRESS" or .status == "PENDING") | .name' | wc -l)
          
          TOTAL=$(gh pr view $PR_NUMBER \
            --repo conda-forge/omnipkg-feedstock \
            --json statusCheckRollup \
            --jq '.statusCheckRollup | length')
          
          echo "üìä Check status (Attempt $ATTEMPT): $((TOTAL - PENDING))/$TOTAL completed"
          
          if [ "$PENDING" -eq 0 ] && [ "$TOTAL" -gt 0 ]; then
            if echo "$STATUS" | grep -q "FAILURE"; then
              echo "‚ùå Some checks failed"
              gh pr view $PR_NUMBER --repo conda-forge/omnipkg-feedstock --json statusCheckRollup
              exit 1
            elif echo "$STATUS" | grep -q "SUCCESS"; then
              echo "‚úÖ All checks passed!"
              break
            fi
          fi
          
          sleep 120  # Check every 2 minutes
        done

    - name: Merge PR
      if: env.skip_pr != 'true' && steps.create-pr.outputs.pull-request-number != ''
      env:
        GH_TOKEN: ${{ secrets.FEEDSTOCK_TOKEN }}
      run: |
        PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        
        echo "üéØ Merging PR #$PR_NUMBER..."
        gh pr merge $PR_NUMBER \
          --repo conda-forge/omnipkg-feedstock \
          --squash \
          --subject "Build for $VERSION (noarch)" \
          --body ""
        
        echo "‚úÖ Noarch build merged to conda-forge!"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 4: Update conda-forge feedstock (PLATFORMS - Build 1)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  update-feedstock-platforms:
    name: "üöÄ Conda-Forge Platforms (Build 1)"
    needs: [wait-for-pypi, update-feedstock-noarch]
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
    - name: Checkout feedstock fork
      uses: actions/checkout@v4
      with:
        repository: 1minds3t/omnipkg-feedstock
        token: ${{ secrets.FEEDSTOCK_TOKEN }}
        path: feedstock
        fetch-depth: 0

    - name: Sync fork with upstream again
      run: |
        cd feedstock
        git remote add upstream https://github.com/conda-forge/omnipkg-feedstock.git || true
        git fetch upstream
        git checkout main
        git merge upstream/main --no-edit || echo "Already up to date"
        git push origin main
        echo "‚úÖ Fork re-synced after noarch merge"

    - name: Checkout main repo for template
      uses: actions/checkout@v4
      with:
        path: main-repo

    - name: Update feedstock recipe/meta.yaml (PLATFORMS)
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "üìù Updating recipe/meta.yaml for PLATFORMS (build 1)"
        
        # Copy the platforms template from main repo
        cp ../main-repo/src/omnipkg/conda-recipes/meta-platforms.yaml recipe/meta.yaml
        
        # Ensure version and SHA256 are set correctly
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" recipe/meta.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" recipe/meta.yaml
        
        echo "‚úÖ Updated recipe/meta.yaml for PLATFORMS:"
        head -50 recipe/meta.yaml
        
    - name: Create branch and commit
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        BRANCH="update-platforms-v$VERSION"
        
        git checkout -b "$BRANCH"
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add recipe/meta.yaml
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit"
          echo "skip_pr=true" >> $GITHUB_ENV
        else
          git commit -m "Update omnipkg to $VERSION (platforms)"
          git push -f origin "$BRANCH"
          echo "‚úÖ Changes pushed to branch $BRANCH"
          echo "skip_pr=false" >> $GITHUB_ENV
        fi
        
    - name: Create PR to conda-forge
      id: create-pr
      if: env.skip_pr != 'true'
      env:
        GH_TOKEN: ${{ secrets.FEEDSTOCK_TOKEN }}
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        BRANCH="update-platforms-v$VERSION"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        # Use simple multi-line string assignment (safe in YAML)
        PR_BODY="ü§ñ Automated update to omnipkg version $VERSION (platform builds)

        **Changes:**
        - ‚úÖ Version: $VERSION
        - ‚úÖ SHA256: $SHA256
        - ‚úÖ Build number: 1
        - ‚úÖ Architectures: linux-64, linux-aarch64, linux-ppc64le, osx-64, osx-arm64, win-64

        This PR updates the recipe for conda-forge distribution with platform-specific builds."
        
        # Create PR
        PR_URL=$(gh pr create \
          --repo conda-forge/omnipkg-feedstock \
          --base main \
          --head 1minds3t:$BRANCH \
          --title "Update omnipkg to $VERSION (platforms)" \
          --body "$PR_BODY" || echo "")
        
        if [ -n "$PR_URL" ]; then
          PR_NUMBER=$(echo "$PR_URL" | grep -oP '\d+$')
          echo "‚úÖ PR created: $PR_URL"
          echo "pull-request-number=$PR_NUMBER" >> $GITHUB_OUTPUT
        else
          echo "‚ö†Ô∏è  PR may already exist, checking..."
          PR_NUMBER=$(gh pr list --repo conda-forge/omnipkg-feedstock --head 1minds3t:$BRANCH --json number --jq '.[0].number'
