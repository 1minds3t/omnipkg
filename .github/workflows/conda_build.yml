name: Build and Upload Conda Packages + Conda-Forge Automation

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version to build (e.g., 2.1.2)'
        required: true
        type: string

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 1: Wait for PyPI and get SHA256
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  wait-for-pypi:
    runs-on: ubuntu-latest
    timeout-minutes: 1440
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      sha256: ${{ steps.get-sha.outputs.sha256 }}
    steps:
    - name: Get version from release or input
      id: get-version
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
        else
          VERSION="${{ github.event.inputs.version }}"
          VERSION="${VERSION#v}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "üîç Target version: $VERSION"
      
    - name: Wait for PyPI and extract SHA256
      id: get-sha
      run: |
        VERSION="${{ steps.get-version.outputs.version }}"
        
        echo "‚è≥ Waiting for omnipkg $VERSION on PyPI..."
        
        ATTEMPT=0
        while true; do
          ATTEMPT=$((ATTEMPT + 1))
          ELAPSED=$((ATTEMPT * 2))
          
          if [ $((ATTEMPT % 30)) -eq 0 ]; then
            echo "üïê Still waiting... ${ELAPSED} minutes elapsed"
          fi
          
          HTTP_CODE=$(curl -s -o pypi_response.json -w "%{http_code}" \
            "https://pypi.org/pypi/omnipkg/$VERSION/json")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Package found on PyPI!"
            
            SHA256=$(jq -r '.urls[] | select(.filename | endswith(".tar.gz")) | .digests.sha256' pypi_response.json)
            
            if [ -n "$SHA256" ] && [ "$SHA256" != "null" ]; then
              echo "‚úÖ SHA256 extracted from PyPI: $SHA256"
              echo "sha256=$SHA256" >> $GITHUB_OUTPUT
              break
            else
              echo "‚ö†Ô∏è  SHA256 not found in response, retrying..."
            fi
          fi
          
          sleep 120
        done
        
        rm -f pypi_response.json

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 2: Update local templates in main repo via PR
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  update-local-templates:
    needs: wait-for-pypi
    runs-on: ubuntu-latest
    outputs:
      pr_branch: ${{ steps.create-pr.outputs.pr_branch }}
    steps:
    - name: Checkout omnipkg repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main
        fetch-depth: 0

    - name: Update both meta.yaml templates
      id: update-templates
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "üìù Updating meta-noarch.yaml"
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" src/omnipkg/conda-recipes/meta-noarch.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" src/omnipkg/conda-recipes/meta-noarch.yaml
        
        echo "üìù Updating meta-platforms.yaml"
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" src/omnipkg/conda-recipes/meta-platforms.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" src/omnipkg/conda-recipes/meta-platforms.yaml
        
        echo "‚úÖ Templates updated"
        
    - name: Create PR with template updates
      id: create-pr
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        BRANCH="auto-update-conda-meta-$VERSION"
        
        git checkout -b "$BRANCH"
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add src/omnipkg/conda-recipes/meta-noarch.yaml src/omnipkg/conda-recipes/meta-platforms.yaml
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit"
          echo "pr_branch=" >> $GITHUB_OUTPUT
        else
          git commit -m "chore: update conda meta files to version $VERSION"
          git push -f origin "$BRANCH"
          
          gh pr create \
            --title "chore: update conda meta files to version $VERSION" \
            --body "Automated update from release workflow" \
            --base main \
            --head "$BRANCH" || echo "‚ÑπÔ∏è  PR already exists"
          
          echo "‚úÖ Branch updated"
          echo "pr_branch=$BRANCH" >> $GITHUB_OUTPUT
          
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 3: Conda-Forge NOARCH (Build 0)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  update-feedstock-noarch:
    name: "üöÄ Conda-Forge Noarch (Build 0)"
    needs: [wait-for-pypi, update-local-templates]
    runs-on: ubuntu-latest
    timeout-minutes: 120
    outputs:
      pr_number: ${{ steps.create-pr.outputs.pull-request-number }}
    steps:
    - name: Checkout feedstock fork
      uses: actions/checkout@v4
      with:
        repository: 1minds3t/omnipkg-feedstock
        token: ${{ secrets.FEEDSTOCK_TOKEN }}
        path: feedstock
        fetch-depth: 0

    - name: Sync fork with upstream
      run: |
        cd feedstock
        git remote add upstream https://github.com/conda-forge/omnipkg-feedstock.git
        git fetch upstream
        git checkout main
        git merge upstream/main --no-edit || echo "Already up to date"
        git push origin main
        echo "‚úÖ Fork synced"

    - name: Checkout main repo templates (from PR branch if exists)
      uses: actions/checkout@v4
      with:
        path: main-repo
        ref: ${{ needs.update-local-templates.outputs.pr_branch || 'main' }}

    - name: Update feedstock with NOARCH template
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "üìù Copying NOARCH templates"
        
        # Copy meta-noarch.yaml ‚Üí recipe/meta.yaml
        cp ../main-repo/src/omnipkg/conda-recipes/meta-noarch.yaml recipe/meta.yaml
        
        # Copy conda-forge-noarch.yml ‚Üí conda-forge.yml
        cp ../main-repo/src/omnipkg/conda-recipes/conda-forge-noarch.yml conda-forge.yml
        
        # Update version and SHA256 in meta.yaml
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" recipe/meta.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" recipe/meta.yaml
        
        echo "‚úÖ NOARCH files updated:"
        echo "--- recipe/meta.yaml ---"
        head -20 recipe/meta.yaml
        echo "--- conda-forge.yml ---"
        cat conda-forge.yml
        
    - name: Create branch and commit
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        BRANCH="update-noarch-v$VERSION"
        
        git checkout -b "$BRANCH"
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add recipe/meta.yaml conda-forge.yml
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit"
          echo "skip_pr=true" >> $GITHUB_ENV
        else
          git commit -m "Update omnipkg to $VERSION (noarch)"
          git push -f origin "$BRANCH"
          echo "‚úÖ Changes pushed to branch $BRANCH"
          echo "skip_pr=false" >> $GITHUB_ENV
        fi
        
    - name: Create PR to conda-forge
      id: create-pr
      if: env.skip_pr != 'true'
      env:
        GH_TOKEN: ${{ secrets.FEEDSTOCK_TOKEN }}
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        BRANCH="update-noarch-v$VERSION"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        PR_BODY="ü§ñ Automated update to omnipkg version $VERSION (noarch build)

        **Changes:**
        - ‚úÖ Version: $VERSION
        - ‚úÖ SHA256: $SHA256
        - ‚úÖ Build number: 0
        - ‚úÖ Architecture: noarch
        - ‚úÖ Updated conda-forge.yml for noarch config

        This PR updates the recipe for conda-forge distribution."
        
        PR_URL=$(gh pr create \
          --repo conda-forge/omnipkg-feedstock \
          --base main \
          --head 1minds3t:$BRANCH \
          --title "Update omnipkg to $VERSION (noarch)" \
          --body "$PR_BODY" || echo "")
        
        if [ -n "$PR_URL" ]; then
          PR_NUMBER=$(echo "$PR_URL" | grep -oP '\d+$')
          echo "‚úÖ PR created: $PR_URL"
        else
          echo "‚ö†Ô∏è  PR already exists, finding it..."
          PR_NUMBER=$(gh pr list --repo conda-forge/omnipkg-feedstock --head 1minds3t:$BRANCH --json number --jq '.[0].number')
          echo "‚úÖ Found existing PR #$PR_NUMBER"
        fi
        echo "pull-request-number=$PR_NUMBER" >> $GITHUB_OUTPUT

    - name: Request re-render
      if: env.skip_pr != 'true' && steps.create-pr.outputs.pull-request-number != ''
      env:
        GH_TOKEN: ${{ secrets.FEEDSTOCK_TOKEN }}
      run: |
        PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
        
        echo "üîÑ Requesting re-render..."
        gh pr comment $PR_NUMBER \
          --repo conda-forge/omnipkg-feedstock \
          --body "@conda-forge-admin, please rerender"
        
        sleep 600

    - name: Wait for checks
      if: env.skip_pr != 'true' && steps.create-pr.outputs.pull-request-number != ''
      env:
        GH_TOKEN: ${{ secrets.FEEDSTOCK_TOKEN }}
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        BRANCH="update-noarch-v$VERSION"
        
        # Get PR number from create step
        PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
        
        if [ -z "$PR_NUMBER" ]; then
          echo "üîç No PR number from create step, looking for existing PR..."
          PR_NUMBER=$(gh pr list \
            --repo conda-forge/omnipkg-feedstock \
            --head 1minds3t:$BRANCH \
            --state open \
            --json number \
            --jq '.[0].number')
          echo "‚úÖ Found existing PR #$PR_NUMBER"
        fi
        
        echo "‚è≥ Waiting for checks..."
        sleep 300
        
        ATTEMPT=0
        MAX_ATTEMPTS=60
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          
          PENDING=$(gh pr view $PR_NUMBER \
            --repo conda-forge/omnipkg-feedstock \
            --json statusCheckRollup \
            --jq '[.statusCheckRollup[] | select(.status == "IN_PROGRESS" or .status == "PENDING" or .status == "QUEUED")] | length')
          
          TOTAL=$(gh pr view $PR_NUMBER \
            --repo conda-forge/omnipkg-feedstock \
            --json statusCheckRollup \
            --jq '.statusCheckRollup | length')
          
          FAILED=$(gh pr view $PR_NUMBER \
            --repo conda-forge/omnipkg-feedstock \
            --json statusCheckRollup \
            --jq '[.statusCheckRollup[] | select(.conclusion == "FAILURE")] | length')
          
          echo "üìä Check status (Attempt $ATTEMPT): $((TOTAL - PENDING))/$TOTAL completed"
          
          if [ "$PENDING" -eq 0 ] && [ "$TOTAL" -gt 0 ]; then
            if [ "$FAILED" -gt 0 ]; then
              echo "‚ùå Some checks failed"
              gh pr view $PR_NUMBER --repo conda-forge/omnipkg-feedstock --json statusCheckRollup
              exit 1
            else
              echo "‚úÖ All checks passed!"
              break
            fi
          fi
          
          sleep 120
        done

    - name: Merge PR
      if: env.skip_pr != 'true' && steps.create-pr.outputs.pull-request-number != ''
      env:
        GH_TOKEN: ${{ secrets.FEEDSTOCK_TOKEN }}
      run: |
        PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        
        echo "üéØ Merging PR #$PR_NUMBER..."
        gh pr merge $PR_NUMBER \
          --repo conda-forge/omnipkg-feedstock \
          --squash \
          --subject "Build for $VERSION (noarch)" \
          --body ""
        
        echo "‚úÖ Noarch build merged!"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 4: Conda-Forge PLATFORMS (Build 1)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  update-feedstock-platforms:
    name: "üöÄ Conda-Forge Platforms (Build 1)"
    needs: [wait-for-pypi, update-local-templates, update-feedstock-noarch]
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
    - name: Checkout feedstock fork
      uses: actions/checkout@v4
      with:
        repository: 1minds3t/omnipkg-feedstock
        token: ${{ secrets.FEEDSTOCK_TOKEN }}
        path: feedstock
        fetch-depth: 0

    - name: Sync fork with upstream
      run: |
        cd feedstock
        git remote add upstream https://github.com/conda-forge/omnipkg-feedstock.git || true
        git fetch upstream
        git checkout main
        git merge upstream/main --no-edit || echo "Already up to date"
        git push origin main
        echo "‚úÖ Fork re-synced"

    - name: Checkout main repo templates (from PR branch if exists)
      uses: actions/checkout@v4
      with:
        path: main-repo
        ref: ${{ needs.update-local-templates.outputs.pr_branch || 'main' }}

    - name: Find existing PR
      id: find-pr
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        BRANCH="update-platforms-v$VERSION"
        
        PR_NUMBER=$(gh pr list \
          --repo conda-forge/omnipkg-feedstock \
          --head 1minds3t:$BRANCH \
          --state open \
          --json number \
          --jq '.[0].number')
        
        if [ -n "$PR_NUMBER" ]; then
          echo "‚úÖ Found existing PR #$PR_NUMBER"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        fi
      env:
        GH_TOKEN: ${{ secrets.FEEDSTOCK_TOKEN }}

    - name: Check if work needed
      id: check-needed
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        BRANCH="update-platforms-v$VERSION"
        
        if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
          echo "‚úÖ Branch exists, skipping update"
          echo "skip_update=true" >> $GITHUB_ENV
        else
          echo "skip_update=false" >> $GITHUB_ENV
        fi

    - name: Update feedstock with PLATFORMS template
      if: env.skip_update != 'true'
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "üìù Copying PLATFORMS templates"
        
        # Copy meta-platforms.yaml ‚Üí recipe/meta.yaml
        cp ../main-repo/src/omnipkg/conda-recipes/meta-platforms.yaml recipe/meta.yaml
        
        # Copy conda-forge-platforms.yml ‚Üí conda-forge.yml
        cp ../main-repo/src/omnipkg/conda-recipes/conda-forge-platforms.yml conda-forge.yml
        
        # Update version and SHA256 in meta.yaml
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" recipe/meta.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" recipe/meta.yaml
        
        echo "‚úÖ PLATFORMS files updated:"
        echo "--- recipe/meta.yaml ---"
        head -20 recipe/meta.yaml
        echo "--- conda-forge.yml ---"
        cat conda-forge.yml
        
    - name: Create branch and commit
      if: env.skip_update != 'true'
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        BRANCH="update-platforms-v$VERSION"
        
        git checkout -b "$BRANCH"
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add recipe/meta.yaml conda-forge.yml
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit"
          echo "skip_pr=true" >> $GITHUB_ENV
        else
          git commit -m "Update omnipkg to $VERSION (platforms)"
          git push -f origin "$BRANCH"
          echo "‚úÖ Changes pushed"
          echo "skip_pr=false" >> $GITHUB_ENV
        fi
        
    - name: Create PR to conda-forge
      id: create-pr
      if: env.skip_pr != 'true'
      env:
        GH_TOKEN: ${{ secrets.FEEDSTOCK_TOKEN }}
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        BRANCH="update-platforms-v$VERSION"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        PR_BODY="ü§ñ Automated update to omnipkg version $VERSION (platform builds)

        **Changes:**
        - ‚úÖ Version: $VERSION
        - ‚úÖ SHA256: $SHA256
        - ‚úÖ Build number: 1
        - ‚úÖ Architectures: linux-64, linux-aarch64, linux-ppc64le, osx-64, osx-arm64, win-64
        - ‚úÖ Updated conda-forge.yml for cross-compilation

        This PR updates the recipe for platform-specific builds."
        
        PR_URL=$(gh pr create \
          --repo conda-forge/omnipkg-feedstock \
          --base main \
          --head 1minds3t:$BRANCH \
          --title "Update omnipkg to $VERSION (platforms)" \
          --body "$PR_BODY" || echo "")
        
        if [ -n "$PR_URL" ]; then
          PR_NUMBER=$(echo "$PR_URL" | grep -oP '\d+$')
          echo "‚úÖ PR created: $PR_URL"
        else
          echo "‚ö†Ô∏è  PR already exists, finding it..."
          PR_NUMBER=$(gh pr list --repo conda-forge/omnipkg-feedstock --head 1minds3t:$BRANCH --json number --jq '.[0].number')
          echo "‚úÖ Found existing PR #$PR_NUMBER"
        fi
        echo "pull-request-number=$PR_NUMBER" >> $GITHUB_OUTPUT

    - name: Request re-render
      if: env.skip_pr != 'true' && steps.create-pr.outputs.pull-request-number != ''
      env:
        GH_TOKEN: ${{ secrets.FEEDSTOCK_TOKEN }}
      run: |
        PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
        
        gh pr comment $PR_NUMBER \
          --repo conda-forge/omnipkg-feedstock \
          --body "@conda-forge-admin, please rerender"
        
        sleep 600

    - name: Wait for checks
      if: env.skip_pr != 'true'
      env:
        GH_TOKEN: ${{ secrets.FEEDSTOCK_TOKEN }}
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        BRANCH="update-platforms-v$VERSION"
        
        # Get PR number from find-pr step
        PR_NUMBER="${{ steps.find-pr.outputs.pr_number }}"
        
        if [ -z "$PR_NUMBER" ]; then
          echo "üîç Trying alternative PR search..."
          PR_NUMBER=$(gh pr list \
            --repo conda-forge/omnipkg-feedstock \
            --state open \
            --json number,headRefName \
            --jq ".[] | select(.headRefName==\"$BRANCH\") | .number")
          
          if [ -z "$PR_NUMBER" ]; then
            echo "‚ùå Could not find PR for branch $BRANCH"
            echo "üîç Listing all open PRs:"
            gh pr list --repo conda-forge/omnipkg-feedstock --state open
            exit 1
          fi
          
          echo "‚úÖ Found PR #$PR_NUMBER"
        fi
        
        echo "‚è≥ Waiting for checks..."
        sleep 300
        
        ATTEMPT=0
        MAX_ATTEMPTS=60
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          
          PENDING=$(gh pr view $PR_NUMBER \
            --repo conda-forge/omnipkg-feedstock \
            --json statusCheckRollup \
            --jq '[.statusCheckRollup[] | select(.status == "IN_PROGRESS" or .status == "PENDING" or .status == "QUEUED")] | length')
          
          TOTAL=$(gh pr view $PR_NUMBER \
            --repo conda-forge/omnipkg-feedstock \
            --json statusCheckRollup \
            --jq '.statusCheckRollup | length')
          
          FAILED=$(gh pr view $PR_NUMBER \
            --repo conda-forge/omnipkg-feedstock \
            --json statusCheckRollup \
            --jq '[.statusCheckRollup[] | select(.conclusion == "FAILURE")] | length')
          
          echo "üìä Check status (Attempt $ATTEMPT): $((TOTAL - PENDING))/$TOTAL completed"
          
          if [ "$PENDING" -eq 0 ] && [ "$TOTAL" -gt 0 ]; then
            if [ "$FAILED" -gt 0 ]; then
              echo "‚ùå Some checks failed"
              gh pr view $PR_NUMBER --repo conda-forge/omnipkg-feedstock --json statusCheckRollup
              exit 1
            else
              echo "‚úÖ All checks passed!"
              break
            fi
          fi
          
          sleep 120
        done

    - name: Merge PR
      if: env.skip_pr != 'true' && steps.create-pr.outputs.pull-request-number != ''
      env:
        GH_TOKEN: ${{ secrets.FEEDSTOCK_TOKEN }}
      run: |
        PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        
        gh pr merge $PR_NUMBER \
          --repo conda-forge/omnipkg-feedstock \
          --squash \
          --subject "Build for $VERSION (platforms)" \
          --body ""
        
        echo "‚úÖ Platforms build merged!"
