name: Build and Upload Conda Packages (Noarch + All Platforms)

on:
  workflow_run:
    workflows: ["Publish to PyPI"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version to build'
        required: true
        type: string
      update_feedstock:
        description: 'Update conda-forge feedstock (yes/no)'
        required: false
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Wait for PyPI availability
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  wait-for-pypi:
    runs-on: ubuntu-latest
    timeout-minutes: 300
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      sha256: ${{ steps.get-sha.outputs.sha256 }}
    steps:
    - name: Get version from workflow or input
      id: get-version
      run: |
        if [ "${{ github.event_name }}" == "workflow_run" ]; then
          VERSION=$(echo "${{ github.event.workflow_run.head_branch }}" | sed 's/^v//')
          if [ -z "$VERSION" ]; then
            VERSION=$(gh api repos/${{ github.repository }}/releases/latest --jq '.tag_name' | sed 's/^v//')
          fi
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ” Waiting for version: $VERSION"
      env:
        GH_TOKEN: ${{ github.token }}
        
    - name: Wait for PyPI package availability
      id: wait-pypi
      run: |
        VERSION="${{ steps.get-version.outputs.version }}"
        MAX_ATTEMPTS=600
        SLEEP_TIME=30
        
        echo "â³ Checking for omnipkg version $VERSION on PyPI..."
        
        for i in $(seq 1 $MAX_ATTEMPTS); do
          ELAPSED=$((i * SLEEP_TIME / 60))
          echo "ğŸ”„ Attempt $i/$MAX_ATTEMPTS (${ELAPSED} minutes elapsed)..."
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://pypi.org/pypi/omnipkg/$VERSION/json")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Package version found on PyPI API!"
            
            DOWNLOAD_URL="https://files.pythonhosted.org/packages/source/o/omnipkg/omnipkg-$VERSION.tar.gz"
            DOWNLOAD_CODE=$(curl -s -o /dev/null -w "%{http_code}" -I "$DOWNLOAD_URL")
            
            if [ "$DOWNLOAD_CODE" = "200" ] || [ "$DOWNLOAD_CODE" = "302" ]; then
              echo "âœ… Package file is downloadable!"
              sleep 10
              break
            else
              echo "âš ï¸  Package found but file not yet on CDN (HTTP $DOWNLOAD_CODE)"
            fi
          else
            echo "â³ Package not available (HTTP $HTTP_CODE)"
          fi
          
          if [ $i -eq $MAX_ATTEMPTS ]; then
            echo "âŒ Package not found after 5 hours"
            exit 1
          fi
          
          if [ $i -gt 60 ]; then
            SLEEP_TIME=60
          fi
          
          sleep $SLEEP_TIME
        done
        
    - name: Download and calculate SHA256
      id: get-sha
      run: |
        VERSION="${{ steps.get-version.outputs.version }}"
        
        echo "ğŸ“¦ Downloading package from PyPI..."
        if ! curl -L -f -o "omnipkg-$VERSION.tar.gz" \
          "https://files.pythonhosted.org/packages/source/o/omnipkg/omnipkg-$VERSION.tar.gz"; then
          echo "âš ï¸  CDN failed, trying fallback..."
          curl -L -f -o "omnipkg-$VERSION.tar.gz" \
            "https://pypi.org/packages/source/o/omnipkg/omnipkg-$VERSION.tar.gz"
        fi
        
        FILE_SIZE=$(wc -c < "omnipkg-$VERSION.tar.gz")
        echo "ğŸ“Š File size: $FILE_SIZE bytes"
        if [ "$FILE_SIZE" -lt 10000 ]; then
          echo "âŒ Downloaded file too small ($FILE_SIZE bytes)"
          exit 1
        fi
        
        SHA256=$(sha256sum "omnipkg-$VERSION.tar.gz" | cut -d' ' -f1)
        echo "sha256=$SHA256" >> $GITHUB_OUTPUT
        echo "âœ… SHA256: $SHA256"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Update local meta.yaml templates
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-local-metas:
    needs: wait-for-pypi
    runs-on: ubuntu-latest
    steps:
    - name: Checkout omnipkg repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update meta-noarch.yaml
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "ğŸ“ Updating meta-noarch.yaml"
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" src/omnipkg/conda-recipe/meta-noarch.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" src/omnipkg/conda-recipe/meta-noarch.yaml
        
        echo "âœ… Updated meta-noarch.yaml"
        head -30 src/omnipkg/conda-recipe/meta-noarch.yaml
        
    - name: Update meta-platform.yaml
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "ğŸ“ Updating meta-platform.yaml"
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" src/omnipkg/conda-recipe/meta-platform.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" src/omnipkg/conda-recipe/meta-platform.yaml
        sed -i "s/number: 0/number: 1/" src/omnipkg/conda-recipe/meta-platform.yaml
        
        echo "âœ… Updated meta-platform.yaml"
        head -30 src/omnipkg/conda-recipe/meta-platform.yaml
        
    - name: Commit and push updates
      run: |
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add src/omnipkg/conda-recipe/meta-noarch.yaml src/omnipkg/conda-recipe/meta-platform.yaml
        
        if git diff --staged --quiet; then
          echo "â„¹ï¸  No changes to commit"
        else
          git commit -m "chore: update conda meta files to version $VERSION"
          git push
          echo "âœ… Changes pushed"
        fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Build NOARCH package (build 0) for custom channel
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-noarch:
    name: "Build Noarch (build 0)"
    needs: [wait-for-pypi, update-local-metas]
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.11'
        channels: conda-forge,defaults
        channel-priority: strict

    - name: Install conda-build and anaconda-client
      shell: bash -l {0}
      run: conda install conda-build anaconda-client -y
        
    - name: Copy meta-noarch.yaml to meta.yaml
      shell: bash -l {0}
      run: |
        cp src/omnipkg/conda-recipe/meta-noarch.yaml src/omnipkg/conda-recipe/meta.yaml
        echo "ğŸ“‹ Using noarch configuration (build 0):"
        head -50 src/omnipkg/conda-recipe/meta.yaml
        
    - name: Build noarch conda package
      shell: bash -l {0}
      run: |
        export PYTHONIOENCODING=UTF-8
        conda build src/omnipkg/conda-recipe --output-folder ./conda-dist
        echo "âœ… Noarch package built (build 0)"
        ls -lah ./conda-dist/noarch/
        
    - name: Upload to custom channel (minds3t)
      shell: bash -l {0}
      run: |
        find ./conda-dist -name "*.conda" -o -name "*.tar.bz2" | while read file; do
          echo "ğŸ“¤ Uploading $file to anaconda.org/minds3t"
          anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload "$file" --force --user minds3t
        done
        echo "âœ… Noarch package uploaded to custom channel"
      env:
        ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: Build ALL PLATFORM packages (build 1) for custom channel
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-platforms:
    name: "Build ${{ matrix.label }} (build 1)"
    needs: [wait-for-pypi, build-noarch]
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Linux x86_64 (native on ubuntu-latest)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - runner: ubuntu-latest
            label: "linux-64"
            conda_subdir: "linux-64"
            
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Linux ARM64 (cross-compile with QEMU on ubuntu-latest)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - runner: ubuntu-latest
            label: "linux-aarch64"
            conda_subdir: "linux-aarch64"
            cross_compile: true
            
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Linux ppc64le (cross-compile with QEMU on ubuntu-latest)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - runner: ubuntu-latest
            label: "linux-ppc64le"
            conda_subdir: "linux-ppc64le"
            cross_compile: true
            
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # macOS Intel x86_64 (native on macos-13)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - runner: macos-13
            label: "osx-64"
            conda_subdir: "osx-64"
            
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # macOS Apple Silicon ARM64 (native on macos-latest/macos-14)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - runner: macos-14
            label: "osx-arm64"
            conda_subdir: "osx-arm64"
            
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Windows x86_64 (native on windows-latest)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - runner: windows-latest
            label: "win-64"
            conda_subdir: "win-64"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.11'
        channels: conda-forge,defaults
        channel-priority: strict

    - name: Install conda-build and anaconda-client
      shell: bash -l {0}
      run: conda install conda-build anaconda-client -y

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Cross-compilation setup (Linux ARM64 & ppc64le ONLY)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Setup QEMU for cross-compilation
      if: matrix.cross_compile == true
      shell: bash -l {0}
      run: |
        echo "ğŸ”§ Setting up cross-compilation for ${{ matrix.conda_subdir }}"
        
        # Install QEMU and cross-compilation tools
        sudo apt-get update
        sudo apt-get install -y qemu-user-static
        
        # Install cross-compilation conda packages
        conda install -y cross-python_${{ matrix.conda_subdir }}
        
        echo "âœ… Cross-compilation setup complete"
        
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Copy platform-specific meta.yaml
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Copy meta-platform.yaml to meta.yaml
      shell: bash -l {0}
      run: |
        cp src/omnipkg/conda-recipe/meta-platform.yaml src/omnipkg/conda-recipe/meta.yaml
        echo "ğŸ“‹ Using platform configuration (build 1) for ${{ matrix.label }}:"
        head -50 src/omnipkg/conda-recipe/meta.yaml
        
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Build the package (native or cross-compiled)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Build platform-specific package
      shell: bash -l {0}
      run: |
        export PYTHONIOENCODING=UTF-8
        
        echo "ğŸ—ï¸  Building for ${{ matrix.label }}..."
        
        if [ "${{ matrix.cross_compile }}" = "true" ]; then
          echo "ğŸ”€ Cross-compiling for ${{ matrix.conda_subdir }}"
          export CONDA_SUBDIR=${{ matrix.conda_subdir }}
          export CONDA_BUILD_CROSS_COMPILATION=1
          
          conda build src/omnipkg/conda-recipe \
            --output-folder ./conda-dist \
            -m .ci_support/${{ matrix.conda_subdir }}_.yaml || {
              echo "âš ï¸  Cross-compilation config not found, trying without..."
              conda build src/omnipkg/conda-recipe --output-folder ./conda-dist
            }
        else
          echo "ğŸ”¨ Native build for ${{ matrix.conda_subdir }}"
          conda build src/omnipkg/conda-recipe --output-folder ./conda-dist
        fi
        
        echo "âœ… Platform package built for ${{ matrix.label }}"
        echo "ğŸ“¦ Package contents:"
        find ./conda-dist -name "*.conda" -o -name "*.tar.bz2"
        
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Upload to your custom Anaconda channel
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Upload to custom channel (minds3t)
      shell: bash -l {0}
      run: |
        find ./conda-dist -name "*.conda" -o -name "*.tar.bz2" | while read file; do
          echo "ğŸ“¤ Uploading $file to anaconda.org/minds3t"
          anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload "$file" --force --user minds3t
        done
        echo "âœ… Platform package uploaded to custom channel for ${{ matrix.label }}"
      env:
        ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: Summary of all builds
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-summary:
    name: "ğŸ“Š Build Summary"
    needs: [build-noarch, build-platforms]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Print Summary
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“¦ CONDA BUILD SUMMARY"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ… Noarch build: ${{ needs.build-noarch.result }}"
        echo "âœ… Platform builds: ${{ needs.build-platforms.result }}"
        echo ""
        echo "ğŸ¯ All packages uploaded to: anaconda.org/minds3t"
        echo ""
        echo "Supported platforms:"
        echo "  - noarch (Python-only, build 0)"
        echo "  - linux-64 (x86_64, build 1)"
        echo "  - linux-aarch64 (ARM64, build 1)"
        echo "  - linux-ppc64le (PowerPC, build 1)"
        echo "  - osx-64 (Intel Mac, build 1)"
        echo "  - osx-arm64 (Apple Silicon, build 1)"
        echo "  - win-64 (Windows x64, build 1)"
        echo ""
        echo "Install with: conda install -c minds3t omnipkg"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 6: Update conda-forge feedstock (OPTIONAL)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-feedstock:
    name: "ğŸš€ Update Feedstock (Optional)"
    needs: [wait-for-pypi, build-summary]
    if: github.event.inputs.update_feedstock == 'yes'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - name: Checkout feedstock fork
      uses: actions/checkout@v4
      with:
        repository: 1minds3t/omnipkg-feedstock
        token: ${{ secrets.FEEDSTOCK_TOKEN }}
        path: feedstock

    - name: Update feedstock meta.yaml
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        SHA256="${{ needs.wait-for-pypi.outputs.sha256 }}"
        
        echo "ğŸ“ Updating recipe/meta.yaml to version $VERSION"
        
        # Update version and SHA
        sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" recipe/meta.yaml
        sed -i "s/sha256: .*/sha256: $SHA256/" recipe/meta.yaml
        
        # For feedstock, use build 0 and let conda-forge handle it
        sed -i "s/number: .*/number: 0/" recipe/meta.yaml
        
        echo "âœ… Updated meta.yaml:"
        head -40 recipe/meta.yaml
        
    - name: Commit and push to fork
      run: |
        cd feedstock
        VERSION="${{ needs.wait-for-pypi.outputs.version }}"
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add recipe/meta.yaml
        
        if git diff --staged --quiet; then
          echo "â„¹ï¸  No changes to commit"
          exit 0
        fi
        
        git commit -m "Update omnipkg to $VERSION"
        git push origin main
        echo "âœ… Changes pushed to fork"
        
    - name: Create PR to conda-forge
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.FEEDSTOCK_TOKEN }}
        path: feedstock
        commit-message: "Update omnipkg to ${{ needs.wait-for-pypi.outputs.version }}"
        title: "Update omnipkg to ${{ needs.wait-for-pypi.outputs.version }}"
        body: |
          ğŸ¤– Automated update to omnipkg version ${{ needs.wait-for-pypi.outputs.version }}
          
          **Changes:**
          - âœ… Version: ${{ needs.wait-for-pypi.outputs.version }}
          - âœ… SHA256: ${{ needs.wait-for-pypi.outputs.sha256 }}
          - âœ… Build number: 0
          
          **Supported platforms:**
          - linux-64, linux-aarch64, linux-ppc64le
          - osx-64, osx-arm64
          - win-64
          - noarch
          
          All platform builds are already available on anaconda.org/minds3t for testing.
          
          This PR updates the recipe for conda-forge distribution.
        branch: "update-v${{ needs.wait-for-pypi.outputs.version }}"
        base: main
        delete-branch: true
