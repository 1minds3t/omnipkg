# .github/workflows/update-platform-support.yml
name: Update Platform Support Matrix

on:
  workflow_run:
    workflows: ["Cross-Platform Build Verification"]
    types:
      - completed
  workflow_dispatch:

jobs:
  update-matrix:
    name: Generate Platform Support Table
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Fetch workflow results
        id: fetch
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the latest successful workflow run
          RUN_ID=$(gh run list --workflow="Cross-Platform Build Verification" \
            --status=success --limit=1 --json databaseId --jq '.[0].databaseId')
          
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          
          # Fetch job results
          gh run view $RUN_ID --json jobs > workflow-jobs.json
          
          echo "‚úÖ Fetched workflow results for run #$RUN_ID"
      
      - name: Parse platform results
        id: parse
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import sys
          
          # Load workflow jobs
          with open('workflow-jobs.json', 'r') as f:
              data = json.load(f)
          
          # Platform mapping
          platforms = {
              # Self-hosted
              "Linux x86_64 (self-hosted)": {
                  "os": "Linux",
                  "arch": "x86_64",
                  "type": "bare-metal",
                  "notes": "Native installation"
              },
              "macOS x86_64 Intel (self-hosted)": {
                  "os": "macOS",
                  "arch": "x86_64 (Intel)",
                  "type": "bare-metal",
                  "notes": "Native installation"
              },
              
              # GitHub-hosted
              "Ubuntu x86_64": {
                  "os": "Ubuntu",
                  "arch": "x86_64",
                  "type": "GitHub Actions",
                  "notes": "Latest LTS"
              },
              "Windows x86_64": {
                  "os": "Windows",
                  "arch": "x86_64",
                  "type": "GitHub Actions",
                  "notes": "Latest Server"
              },
              
              # Docker/Podman - Debian family
              "Docker - Debian/Ubuntu (debian:12)": {
                  "os": "Debian 12 (Bookworm)",
                  "arch": "x86_64",
                  "type": "container",
                  "notes": "Standard install"
              },
              "Docker - Debian/Ubuntu (debian:11)": {
                  "os": "Debian 11 (Bullseye)",
                  "arch": "x86_64",
                  "type": "container",
                  "notes": "Standard install"
              },
              "Docker - Debian/Ubuntu (ubuntu:24.04)": {
                  "os": "Ubuntu 24.04 (Noble)",
                  "arch": "x86_64",
                  "type": "container",
                  "notes": "`--break-system-packages` required"
              },
              "Docker - Debian/Ubuntu (ubuntu:22.04)": {
                  "os": "Ubuntu 22.04 (Jammy)",
                  "arch": "x86_64",
                  "type": "container",
                  "notes": "Standard install"
              },
              "Docker - Debian/Ubuntu (ubuntu:20.04)": {
                  "os": "Ubuntu 20.04 (Focal)",
                  "arch": "x86_64",
                  "type": "container",
                  "notes": "Standard install"
              },
              
              # Podman - Debian family
              "Podman - debian:12": {
                  "os": "Debian 12 (Bookworm)",
                  "arch": "x86_64",
                  "type": "podman",
                  "notes": "`--break-system-packages` required"
              },
              "Podman - ubuntu:24.04": {
                  "os": "Ubuntu 24.04 (Noble)",
                  "arch": "x86_64",
                  "type": "podman",
                  "notes": "`--break-system-packages` required"
              },
              "Podman - fedora:39": {
                  "os": "Fedora 39",
                  "arch": "x86_64",
                  "type": "podman",
                  "notes": "Standard install"
              },
              
              # RHEL family
              "Docker - RHEL/Fedora (fedora:39)": {
                  "os": "Fedora 39",
                  "arch": "x86_64",
                  "type": "container",
                  "notes": "Standard install"
              },
              "Docker - RHEL/Fedora (fedora:38)": {
                  "os": "Fedora 38",
                  "arch": "x86_64",
                  "type": "container",
                  "notes": "Standard install"
              },
              "Docker - RHEL/Fedora (rockylinux:9)": {
                  "os": "Rocky Linux 9",
                  "arch": "x86_64",
                  "type": "container",
                  "notes": "Standard install"
              },
              "Docker - RHEL/Fedora (rockylinux:8)": {
                  "os": "Rocky Linux 8",
                  "arch": "x86_64",
                  "type": "container",
                  "notes": "Requires Python 3.9+ (default is 3.6)"
              },
              "Docker - RHEL/Fedora (almalinux:9)": {
                  "os": "AlmaLinux 9",
                  "arch": "x86_64",
                  "type": "container",
                  "notes": "Standard install"
              },
              
              # Other distros
              "Docker - Arch/Alpine (archlinux:latest)": {
                  "os": "Arch Linux",
                  "arch": "x86_64",
                  "type": "container",
                  "notes": "`--break-system-packages` required"
              },
              "Docker - Arch/Alpine (alpine:latest)": {
                  "os": "Alpine Linux",
                  "arch": "x86_64",
                  "type": "container",
                  "notes": "Requires build deps (gcc, musl-dev)"
              }
          }
          
          # Parse job results
          results = {}
          for job in data['jobs']:
              job_name = job['name']
              status = job['conclusion']
              
              if job_name in platforms:
                  platform_info = platforms[job_name]
                  platform_info['status'] = status
                  platform_info['runtime'] = job.get('completedAt', 'N/A')
                  results[job_name] = platform_info
          
          # Save results
          with open('.github/platform-results.json', 'w') as f:
              json.dump(results, f, indent=2)
          
          # Count successes
          success_count = sum(1 for p in results.values() if p['status'] == 'success')
          total_count = len(results)
          
          print(f"‚úÖ {success_count}/{total_count} platforms verified")
          
          # Output for GitHub Actions
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"success_count={success_count}\n")
              f.write(f"total_count={total_count}\n")
          PYTHON_SCRIPT
      
      - name: Generate platform support table
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          
          with open('.github/platform-results.json', 'r') as f:
              results = json.load(f)
          
          # Group by OS family
          grouped = {
              "Linux (Native)": [],
              "macOS (Native)": [],
              "Windows (Native)": [],
              "Debian/Ubuntu": [],
              "RHEL/Fedora": [],
              "Other Linux": []
          }
          
          for job_name, info in results.items():
              os_name = info['os']
              
              if info['type'] == 'bare-metal' and 'Linux' in os_name:
                  grouped["Linux (Native)"].append((job_name, info))
              elif info['type'] == 'bare-metal' and 'macOS' in os_name:
                  grouped["macOS (Native)"].append((job_name, info))
              elif info['type'] == 'GitHub Actions' and 'Windows' in os_name:
                  grouped["Windows (Native)"].append((job_name, info))
              elif 'Ubuntu' in os_name or 'Debian' in os_name:
                  grouped["Debian/Ubuntu"].append((job_name, info))
              elif any(x in os_name for x in ['Fedora', 'Rocky', 'Alma']):
                  grouped["RHEL/Fedora"].append((job_name, info))
              else:
                  grouped["Other Linux"].append((job_name, info))
          
          # Generate markdown table
          md_lines = [
              "<!-- PLATFORM_SUPPORT_START -->",
              "## üåê Verified Platform Support",
              "",
              f"[![Platforms Verified](https://img.shields.io/badge/platforms-{len(results)}%20verified-success?logo=linux&logoColor=white)](https://github.com/1minds3t/omnipkg/actions/workflows/cross-platform-build-verification.yml)",
              "",
              "**omnipkg** is a pure Python package (noarch) with **no C-extensions**, ensuring universal compatibility across all platforms and architectures.",
              "",
              "### üìä Platform Matrix",
              ""
          ]
          
          for group_name, platforms in grouped.items():
              if not platforms:
                  continue
              
              md_lines.append(f"#### {group_name}")
              md_lines.append("")
              md_lines.append("| Platform | Architecture | Status | Installation Notes |")
              md_lines.append("|----------|--------------|--------|-------------------|")
              
              for job_name, info in platforms:
                  status_badge = "‚úÖ" if info['status'] == 'success' else "‚ùå"
                  os_name = info['os']
                  arch = info['arch']
                  notes = info['notes']
                  
                  md_lines.append(f"| {os_name} | {arch} | {status_badge} | {notes} |")
              
              md_lines.append("")
          
          # Add special notes section
          md_lines.extend([
              "### üìù Special Installation Notes",
              "",
              "#### Ubuntu 24.04+ / Debian 12+ (PEP 668)",
              "```bash",
              "# Use --break-system-packages flag",
              "python3 -m pip install --break-system-packages omnipkg",
              "```",
              "",
              "#### Rocky/Alma Linux 8 (Python 3.6 ‚Üí 3.9)",
              "```bash",
              "# Install Python 3.9 first",
              "sudo dnf install -y python39 python39-pip",
              "sudo ln -sf /usr/bin/python3.9 /usr/bin/python3",
              "",
              "# Then install omnipkg",
              "python3 -m pip install omnipkg",
              "```",
              "",
              "#### Alpine Linux (Build Dependencies)",
              "```bash",
              "# Install build tools for psutil",
              "apk add --no-cache gcc python3-dev musl-dev linux-headers",
              "python3 -m pip install --break-system-packages omnipkg",
              "```",
              "",
              "#### Arch Linux",
              "```bash",
              "python -m pip install --break-system-packages omnipkg",
              "```",
              "",
              "### üêç Python Version Support",
              "",
              "**Supported:** Python 3.7 - 3.14 (including beta/rc releases)",
              "",
              "**Architecture:** `noarch` (pure Python, no compiled extensions)",
              "",
              "This means omnipkg runs on **any** architecture where Python is available:",
              "- ‚úÖ x86_64 (Intel/AMD)",
              "- ‚úÖ ARM32 (armv6/v7) via [piwheels](https://www.piwheels.org/project/omnipkg/)",
              "- ‚úÖ ARM64 (aarch64) - native Python support",
              "- ‚úÖ RISC-V, POWER, s390x - anywhere Python runs!",
              "",
              "<!-- PLATFORM_SUPPORT_END -->"
          ])
          
          # Write to file
          with open('.github/platform-support.md', 'w') as f:
              f.write('\n'.join(md_lines))
          
          print("‚úÖ Platform support table generated")
          PYTHON_SCRIPT
      
      - name: Update README
        run: |
          # Check if markers exist in README
          if grep -q "<!-- PLATFORM_SUPPORT_START -->" README.md; then
            # Remove old content between markers
            perl -i -p0e 's/<!-- PLATFORM_SUPPORT_START -->.*?<!-- PLATFORM_SUPPORT_END -->//gs' README.md
            
            # Find insertion point (after "## üõ†Ô∏è Get Started in 30 Seconds" section)
            # Insert new platform support table before installation options
            sed -i '/### Installation Options/e cat .github/platform-support.md' README.md
          else
            echo "‚ö†Ô∏è Platform support markers not found in README.md"
            echo "Please add <!-- PLATFORM_SUPPORT_START --> and <!-- PLATFORM_SUPPORT_END --> markers"
          fi
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add README.md .github/platform-support.md .github/platform-results.json || true
          
          if ! git diff --staged --quiet; then
            git commit -m "Auto-update platform support matrix [skip ci]"
            git pull --rebase origin main
            git push
          else
            echo "No changes to commit"
          fi
      
      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## üåê Platform Support Updated
          
          **Verified Platforms:** ${{ steps.parse.outputs.success_count }}/${{ steps.parse.outputs.total_count }}
          
          **Categories:**
          - Native Linux (x86_64)
          - Native macOS (Intel x86_64)
          - Native Windows (x86_64)
          - Debian/Ubuntu (12+ container distros)
          - RHEL/Fedora (5 distros)
          - Arch Linux & Alpine Linux
          
          **Architecture Support:**
          - ‚úÖ x86_64 (verified in CI)
          - ‚úÖ ARM32 (piwheels)
          - ‚úÖ ARM64 (Python native support)
          - ‚úÖ Any arch where Python runs (noarch package)
          
          View the full platform matrix in the updated README.
          EOF
