name: "ðŸŽ macOS - Daemon Debug"
on:
  workflow_dispatch:

jobs:
  daemon-debug:
    runs-on: macos-latest
    timeout-minutes: 20
    env:
      PYTHONIOENCODING: "utf-8"
      PYTHONUTF8: "1"
      OMNIPKG_NONINTERACTIVE: "1"
      OMNIPKG_DEBUG: "1"
      CI: "true"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: src

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install omnipkg
        run: |
          python -m pip install --upgrade pip
          pip install -e src
        shell: bash

      - name: Adopt Python 3.9
        run: omnipkg python adopt 3.9
        shell: bash

      - name: Adopt Python 3.10
        run: omnipkg python adopt 3.10
        shell: bash

      - name: Show interpreter registry
        run: |
          echo "=== TMPDIR ==="
          echo "$TMPDIR"
          echo ""
          echo "=== Registry ==="
          find "${TMPDIR}" "$HOME" /Library/Frameworks \
            -name "registry.json" -path "*omnipkg*" 2>/dev/null \
            | head -5 | while read f; do
              echo "ðŸ“„ $f:"
              cat "$f"
              echo ""
            done
        shell: bash

      - name: Start daemon manually and capture output
        run: |
          echo "=== Starting daemon ==="
          omnipkg daemon start
          echo "=== Daemon started ==="
          sleep 2
          echo "=== Daemon log ==="
          find "${TMPDIR}" /tmp -name "omnipkg_daemon.log" 2>/dev/null \
            | head -3 | while read f; do
              echo "ðŸ“„ $f"
              cat "$f"
            done
        shell: bash

      - name: Spawn a single worker (Python 3.9) and capture crash
        run: |
          python - <<'EOS'
          import sys
          import os
          sys.path.insert(0, "src")
          from omnipkg.isolation.worker_daemon import DaemonClient
          from omnipkg.core import ConfigManager
          import traceback

          print("--- Test: Python 3.9 Worker ---")
          try:
              cm = ConfigManager()
              # Explicitly resolve the interpreter path
              python_exe = cm.get_interpreter_for_version("3.9")
              print(f"ðŸŽ¯ Resolved Python 3.9: {python_exe}")
              
              if not python_exe:
                  print("âŒ Failed to resolve Python 3.9 interpreter")
                  sys.exit(1)

              client = DaemonClient()
              # FIX: Use keyword arguments to ensure correct mapping
              result = client.execute(
                  spec="rich==13.4.2", 
                  code="import rich; print(f'Rich version: {rich.__version__}')",
                  python_exe=str(python_exe)
              )
              print(f"âœ… Result: {result}")
              
              if not result.get("success"):
                  print(f"âŒ Worker reported failure: {result.get('error')}")
                  sys.exit(1)
                  
          except Exception as e:
              print(f"âŒ Failed: {e}")
              traceback.print_exc()
              sys.exit(1)
          EOS
        shell: bash

      - name: Test direct install in Python 3.9
        run: |
          PYTHON39="/Library/Frameworks/Python.framework/Versions/3.11/.omnipkg/interpreters/cpython-3.9.23/bin/python3.9"
          $PYTHON39 -m pip install "rich==13.4.2" --dry-run -v
          # Also test if omnipkg loader works directly
          $PYTHON39 -c "
          import sys
          sys.path.insert(0, 'src')
          from omnipkg.loader import omnipkgLoader
          with omnipkgLoader('rich==13.4.2', quiet=False):
              import rich
              print('rich version:', rich.__version__)
          "
        shell: bash

      - name: Spawn a single worker (Python 3.10) and capture crash
        run: |
          python - <<'EOS'
          import sys
          import os
          sys.path.insert(0, "src")
          from omnipkg.isolation.worker_daemon import DaemonClient
          from omnipkg.core import ConfigManager
          import traceback

          print("--- Test: Python 3.10 Worker ---")
          try:
              cm = ConfigManager()
              python_exe = cm.get_interpreter_for_version("3.10")
              print(f"ðŸŽ¯ Resolved Python 3.10: {python_exe}")
              
              if not python_exe:
                  print("âŒ Failed to resolve Python 3.10 interpreter")
                  sys.exit(1)

              client = DaemonClient()
              result = client.execute(
                  spec="rich==13.6.0", 
                  code="import rich; print(f'Rich version: {rich.__version__}')",
                  python_exe=str(python_exe)
              )
              print(f"âœ… Result: {result}")
              
              if not result.get("success"):
                  print(f"âŒ Worker reported failure: {result.get('error')}")
                  sys.exit(1)

          except Exception as e:
              print(f"âŒ Failed: {e}")
              traceback.print_exc()
              sys.exit(1)
          EOS
        shell: bash

      - name: Dump full daemon log
        if: always()
        run: |
          echo "=== Full Daemon Log ==="
          find "${TMPDIR}" /tmp -name "omnipkg_daemon.log" 2>/dev/null \
            | while read f; do
              echo "ðŸ“„ $f"
              cat "$f"
            done
          echo ""
          echo "=== Worker temp scripts ==="
          find "${TMPDIR}" /tmp -name "*.py" -newer /tmp 2>/dev/null \
            | head -5 | while read f; do
              echo "ðŸ“„ $f (last 30 lines):"
              tail -30 "$f"
              echo ""
            done
        shell: bash
