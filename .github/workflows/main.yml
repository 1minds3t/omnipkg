# .github/workflows/cross-platform-build-verification.yml
name: Cross-Platform Build Verification

on:
  push:
    branches: [main, development]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-matrix:
    name: Build on ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            runner: ubuntu-latest
            arch: x86_64
            distro: ubuntu
          - os: ubuntu-20.04
            runner: ubuntu-20.04
            arch: x86_64
            distro: ubuntu-lts
          
          # Linux ARM64
          - os: ubuntu-latest-arm
            runner: ubuntu-24.04-arm64
            arch: aarch64
            distro: ubuntu
          
          # macOS Intel
          - os: macos-13
            runner: macos-13
            arch: x86_64
            distro: macos
          
          # macOS Apple Silicon
          - os: macos-latest
            runner: macos-latest
            arch: arm64
            distro: macos
          
          # Windows x86_64
          - os: windows-latest
            runner: windows-latest
            arch: x86_64
            distro: windows
          
          # Windows ARM64 (if GitHub adds support)
          # - os: windows-arm
          #   runner: windows-arm64
          #   arch: arm64
          #   distro: windows
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build wheel setuptools
      
      - name: Build package
        run: |
          python -m build
      
      - name: Install package
        shell: bash
        run: |
          pip install dist/*.whl
      
      - name: Test basic functionality
        shell: bash
        run: |
          omnipkg --version
          8pkg --version
          omnipkg list
      
      - name: Test daemon (Unix-like)
        if: runner.os != 'Windows'
        run: |
          omnipkg daemon start
          sleep 2
          omnipkg daemon status
          omnipkg daemon monitor
          omnipkg daemon stop
      
      - name: Test daemon (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          omnipkg daemon start --no-fork
          sleep 2
          omnipkg daemon status
          omnipkg daemon monitor
          omnipkg daemon stop
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: omnipkg-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/

  # Additional distro tests using Docker
  linux-distros:
    name: ${{ matrix.distro }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        distro:
          - debian:12
          - debian:11
          - ubuntu:24.04
          - ubuntu:22.04
          - ubuntu:20.04
          - fedora:39
          - fedora:38
          - rockylinux:9
          - rockylinux:8
          - almalinux:9
          - archlinux:latest
          - alpine:latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test in ${{ matrix.distro }}
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ matrix.distro }}
          options: -v ${{ github.workspace }}:/workspace
          run: |
            cd /workspace
            
            # Install Python based on distro
            if command -v apt-get &> /dev/null; then
              apt-get update && apt-get install -y python3 python3-pip python3-venv
            elif command -v dnf &> /dev/null; then
              dnf install -y python3 python3-pip
            elif command -v pacman &> /dev/null; then
              pacman -Sy --noconfirm python python-pip
            elif command -v apk &> /dev/null; then
              apk add --no-cache python3 py3-pip
            fi
            
            # Build and install
            python3 -m pip install --upgrade pip build
            python3 -m build
            python3 -m pip install dist/*.whl
            
            # Test
            omnipkg --version
            omnipkg list

  # FreeBSD (experimental)
  freebsd:
    name: FreeBSD 14.0
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test on FreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          release: 14.0
          usesh: true
          prepare: |
            pkg install -y python311 py39-pip
          run: |
            python3.11 -m pip install --upgrade pip build
            python3.11 -m build
            python3.11 -m pip install dist/*.whl
            omnipkg --version
            omnipkg list

  # Generate badge data
  generate-badge:
    name: Generate Platform Support Badge
    needs: [build-matrix, linux-distros, freebsd]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      
      - name: Generate badge JSON
        run: |
          cat > platform-support.json << 'EOF'
          {
            "schemaVersion": 1,
            "label": "platforms",
            "message": "Linux | macOS | Windows | FreeBSD",
            "color": "brightgreen"
          }
          EOF
          
          cat > arch-support.json << 'EOF'
          {
            "schemaVersion": 1,
            "label": "architectures",
            "message": "x86_64 | ARM64 | aarch64",
            "color": "blue"
          }
          EOF
      
      - name: Commit badge data
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add platform-support.json arch-support.json
          git diff --staged --quiet || git commit -m "Update platform support badges [skip ci]"
          git push
