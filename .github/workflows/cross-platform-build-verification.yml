linux-distros-podman-critical:
    name: Podman - ${{ matrix.distro }} (${{ matrix.platform }})
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        include:
          # Native x64
          - distro: debian:12
            platform: linux/amd64
          - distro: ubuntu:24.04
            platform: linux/amd64
          - distro: fedora:39
            platform: linux/amd64
            
          # ARM64 QEMU (Debian & Rocky ONLY)
          - distro: debian:12
            platform: linux/arm64
          - distro: rockylinux:9
            platform: linux/arm64
            
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_ref || github.ref }}
          
      - name: Test
        run: |
          # Use the workspace directly - no temp dir needed
          # GitHub Actions already provides an isolated workspace per job
          WORKSPACE_DIR="$(pwd)"
          
          echo "Testing in workspace: $WORKSPACE_DIR"
          
          if [[ "${{ matrix.distro }}" == *"alpine"* ]]; then SHELL_CMD="/bin/sh"; else SHELL_CMD="/bin/bash"; fi
          
          # Mount the current workspace directly
          # This avoids temp directory issues entirely
          podman run --rm \
            --security-opt label=disable \
            -v "$WORKSPACE_DIR:/workspace:rw" \
            --platform ${{ matrix.platform }} \
            ${{ matrix.distro }} $SHELL_CMD -c "
            cd /workspace
            
            # Install build dependencies based on distro
            if command -v apt-get > /dev/null 2>&1; then 
              apt-get update && apt-get install -y python3 python3-pip python3-venv build-essential python3-dev gcc
            elif command -v dnf > /dev/null 2>&1; then 
              dnf install -y python3 python3-pip gcc python3-devel
            elif command -v apk > /dev/null 2>&1; then 
              apk add --no-cache python3 py3-pip py3-build gcc python3-dev musl-dev linux-headers
            fi
            
            python3 -m pip install --upgrade pip build || python3 -m pip install --break-system-packages pip build
            python3 -m build
            python3 -m pip install dist/*.whl || python3 -m pip install --break-system-packages dist/*.whl
            omnipkg --version
            omnipkg list
          "
