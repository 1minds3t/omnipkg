name: "Simple Python Adoption Test"

on:
  push:
    branches: [ development ]
  pull_request:
    branches: [ development ]
  workflow_dispatch:

jobs:
  test-python-adoption:
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11 (base environment)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e . redis

      - name: Test Basic Python Adoption and Swapping
        id: full_test_run
        run: |
          set -e
          echo "=== Testing Basic Python Management ==="

          # ── Adopt Python 3.11 (already active) ────────────────────────────
          echo "--- Adopting Python 3.11 ---"
          omnipkg python adopt 3.11

          echo "--- Checking Python info ---"
          omnipkg info python

          # ── Adopt Python 3.9 ──────────────────────────────────────────────
          # 'adopt' now:
          #   1. Downloads + installs the interpreter
          #   2. Creates omnipkg39 / 8pkg39 symlinks in $VENV/bin/
          #   3. Writes OMNIPKG_PYTHON_39_PATH to .omnipkg/profile.d/omnipkg_pythons.sh
          #   4. Patches $VENV/bin/activate to source that snippet
          echo "--- Adopting Python 3.9 ---"
          omnipkg python adopt 3.9

          # Source the profile snippet directly here so the env var is
          # available in this step without relying on activate being re-sourced.
          # (GitHub Actions does NOT re-source activate between run: blocks.)
          PROFILE_SNIPPET="$(python -c "import sys,os; from pathlib import Path; print(Path(sys.prefix)/'.omnipkg'/'profile.d'/'omnipkg_pythons.sh')")"
          if [ -f "$PROFILE_SNIPPET" ]; then
            source "$PROFILE_SNIPPET"
            echo "Sourced profile snippet: $PROFILE_SNIPPET"
          fi

          # ── List ──────────────────────────────────────────────────────────
          echo "--- Listing managed interpreters ---"
          omnipkg list python

          # ── Versioned command: targets 3.9 context directly ───────────────
          # Works because:
          #   a) omnipkg39 symlink exists in PATH (created by adopt above)
          #   b) OMNIPKG_PYTHON_39_PATH is set (sourced from profile snippet)
          #   The dispatcher reads the env var at Priority 0.5 — no swap needed.
          echo "--- Verifying Python 3.9 context (via omnipkg39) ---"
          omnipkg39 info python

          # ── Re-adopt 3.11 to ensure it is in context ──────────────────────
          echo "--- Re-adopting Python 3.11 ---"
          omnipkg python adopt 3.11

          echo "--- Final verification (via omnipkg311) ---"
          omnipkg311 info python

          echo "✅ All basic Python adoption and versioned-command tests passed!"

      - name: Test Summary
        if: always()
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.full_test_run.outcome }}" == "success" ]]; then
            echo "✅ **Simple Python Adoption Test: PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Successfully tested:" >> $GITHUB_STEP_SUMMARY
            echo "- Python interpreter adoption (3.11 and 3.9)" >> $GITHUB_STEP_SUMMARY
            echo "- Versioned commands (omnipkg39, omnipkg311) without swap" >> $GITHUB_STEP_SUMMARY
            echo "- Basic omnipkg info and list commands" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Simple Python Adoption Test: FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi
