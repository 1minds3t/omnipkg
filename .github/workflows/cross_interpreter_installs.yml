name: "ðŸŒŒ LIVE - Quantum Python Auto-Switch Test"

on:
  workflow_dispatch:

jobs:
  test-quantum-switch:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e . redis

      - name: Configure omnipkg for non-interactive use
        run: |
          mkdir -p ~/.config/omnipkg
          echo '{"interactive": false, "auto_confirm": true, "redis_url": "redis://localhost:6379"}' > ~/.config/omnipkg/config.json
          echo "âœ… Omnipkg configured for non-interactive use"

      - name: Adopt and Switch to Python 3.14
        run: |
          echo "--- Adopting and switching to Python 3.14 ---"
          omnipkg python adopt 3.14
          omnipkg swap python 3.14
          omnipkg info python | grep "Active Context:.*3.14" || (echo "âŒ Failed to switch to Python 3.14" && exit 1)
          echo "âœ… Successfully set initial context to Python 3.14"

      - name: Attempt to Install TensorFlow (Trigger Quantum Healing)
        run: |
          echo "--- Attempting to install TensorFlow on incompatible Python 3.14 ---"
          if omnipkg install tensorflow; then
            echo "âœ… Quantum Healing process completed."
          else
            echo "âŒ Quantum Healing process failed."
            exit 1
          fi

      - name: Verify TensorFlow Installation in the Correct Context
        run: |
          echo "--- Switching to Python 3.13 to verify installation ---"
          omnipkg swap python 3.13
          omnipkg info python | grep "Active Context:.*3.13" || (echo "âŒ Failed to switch to Python 3.13 for verification" && exit 1)
          echo "âœ… Switched to Python 3.13"

          echo "--- Verifying TensorFlow installation ---"
          # The 'echo 1' pipes the selection to the interactive prompt of 'omnipkg info'
          if echo 1 | omnipkg info tensorflow | grep "Active Version: 2.20.0"; then
            echo "âœ… TensorFlow 2.20.0 is correctly installed in the Python 3.13 context."
          else
            echo "âŒ TensorFlow installation not found in Python 3.13 context."
            exit 1
          fi

      - name: Test Functional TensorFlow Import on Python 3.13
        run: |
          echo "--- Testing TensorFlow import on Python 3.13 ---"
          # Ensure we are still in the 3.13 context before this test
          omnipkg swap python 3.13
          
          # Use omnipkg's knowledge of the python path to run the import test
          PYTHON_313_EXE=$(omnipkg info python | grep 'Python 3.13:' | awk '{print $4}')
          if [ -z "$PYTHON_313_EXE" ]; then
              echo "âŒ Could not determine Python 3.13 executable path."
              exit 1
          fi

          if "$PYTHON_313_EXE" -c "import tensorflow as tf; print(f'TensorFlow version: {tf.__version__}')"; then
            echo "âœ… TensorFlow imports and runs successfully on Python 3.13."
          else
            echo "âŒ Failed to import TensorFlow on Python 3.13."
            exit 1
          fi

      - name: The Grand Finale - Test for Cross-Version Import Miracle
        run: |
          echo "--- Switching back to Python 3.14 to test for cross-version import ---"
          omnipkg swap python 3.14
          omnipkg info python | grep "Active Context:.*3.14" || (echo "âŒ Failed to switch back to Python 3.14" && exit 1)
          echo "âœ… Now in Python 3.14 context."
          
          echo "--- Attempting to import TensorFlow from Python 3.14 ---"
          PYTHON_314_EXE=$(omnipkg info python | grep 'Python 3.14:' | awk '{print $4}')
          if [ -z "$PYTHON_314_EXE" ]; then
              echo "âŒ Could not determine Python 3.14 executable path."
              exit 1
          fi

          # This command will attempt the import and exit with 0 if it succeeds, 1 if it fails
          if "$PYTHON_314_EXE" -c "import tensorflow as tf" &> /dev/null; then
            echo "ðŸ¤¯ INSANE RESULT: TensorFlow successfully imported from Python 3.14!"
            echo "This indicates a revolutionary cross-version package loading capability."
            # Consider this a success for the purpose of the CI run
            exit 0
          else
            echo "âœ… As expected, TensorFlow cannot be imported from the Python 3.14 context."
            echo "This confirms correct environmental isolation."
          fi
