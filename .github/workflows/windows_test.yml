name: Omnipkg True First-Run Test (Windows)
on:
  push:
    branches:
      - development
      - main
  pull_request:
    branches:
      - development
      - main
  workflow_dispatch:
    inputs:
      branch:
        description: 'The branch to test'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - main

jobs:
  true-first-run-test-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Display test info
        run: |
          Write-Host "Testing on: Windows"
          Write-Host "Branch: ${{ github.ref_name }}"
          Write-Host "Commit: ${{ github.sha }}"
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"
        shell: pwsh

      - name: Wipe previous omnipkg config
        run: |
          if (Test-Path ~\.config\omnipkg) {
            Remove-Item ~\.config\omnipkg -Recurse -Force
            Write-Host "Previous omnipkg config wiped."
          } else {
            Write-Host "No previous omnipkg config found. Starting fresh."
          }
        shell: pwsh

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install omnipkg in editable mode
        run: |
          $env:PYTHONUNBUFFERED = "1"
          pip install -e . 2>&1 | ForEach-Object { Write-Host $_; [Console]::Out.Flush() }
        shell: pwsh

      - name: Trigger first-time setup (3.9)
        run: |
          Write-Host "=== Starting omnipkg status ===" -ForegroundColor Green
          omnipkg status 2>&1 | ForEach-Object { Write-Host $_; [Console]::Out.Flush() }
          Write-Host "=== omnipkg status completed ===" -ForegroundColor Green
        shell: pwsh
        env:
          PYTHONUTF8: "1"
          PYTHONUNBUFFERED: "1"
          PYTHONIOENCODING: "utf-8"
          OMNIPKG_DEBUG: "1"

      - name: Adopt Python 3.11
        run: |
          Write-Host "=== Adopting Python 3.11 ===" -ForegroundColor Green
          omnipkg python adopt 3.11 2>&1 | ForEach-Object { Write-Host $_; [Console]::Out.Flush() }
          Write-Host "=== Adopt completed ===" -ForegroundColor Green
        shell: pwsh
        env:
          PYTHONUTF8: "1"
          PYTHONUNBUFFERED: "1"
          PYTHONIOENCODING: "utf-8"
          OMNIPKG_DEBUG: "1"

      # KEY FIX: Don't use 'swap' in CI - swap only affects the current process's env vars.
      # Instead, find the 3.11 executable directly from the registry and use it explicitly.
      # We store it as a step output so all subsequent steps can use it.
      - name: Locate adopted Python 3.11 executable
        id: find_py311
        run: |
          $registryPath = (python -c "import sys; print(sys.prefix)") + "\.omnipkg\interpreters\registry.json"
          Write-Host "Registry path: $registryPath"
          $registry = Get-Content $registryPath | ConvertFrom-Json
          $py311 = $registry.interpreters.'3.11'
          if (-not $py311 -or -not (Test-Path $py311)) {
            Write-Host "❌ Could not find Python 3.11 in registry" -ForegroundColor Red
            exit 1
          }
          Write-Host "✅ Found Python 3.11: $py311"
          # Export for subsequent steps
          echo "py311=$py311" >> $env:GITHUB_OUTPUT
          echo "PY311=$py311" >> $env:GITHUB_ENV
        shell: pwsh
        env:
          PYTHONUTF8: "1"
          PYTHONIOENCODING: "utf-8"

      # Trigger the first-use KB build for 3.11 explicitly before installing anything.
      # This ensures the KB is fully built before we try to query it.
      - name: Trigger 3.11 KB first-use build
        run: |
          Write-Host "=== Building 3.11 knowledge base ===" -ForegroundColor Green
          & "$env:PY311" -m omnipkg.cli status 2>&1 | ForEach-Object { Write-Host $_; [Console]::Out.Flush() }
          Write-Host "=== KB build completed ===" -ForegroundColor Green
        shell: pwsh
        env:
          PYTHONUTF8: "1"
          PYTHONUNBUFFERED: "1"
          PYTHONIOENCODING: "utf-8"
          OMNIPKG_DEBUG: "1"

      - name: Install six==1.16.0 via Python 3.11 directly
        run: |
          Write-Host "=== Installing six==1.16.0 ===" -ForegroundColor Green
          & "$env:PY311" -m omnipkg.cli install six==1.16.0 2>&1 | ForEach-Object { Write-Host $_; [Console]::Out.Flush() }
          Write-Host "=== Installation completed ===" -ForegroundColor Green
        shell: pwsh
        env:
          PYTHONUTF8: "1"
          PYTHONUNBUFFERED: "1"
          PYTHONIOENCODING: "utf-8"
          OMNIPKG_DEBUG: "1"

      - name: Verify package info is in the knowledge base
        run: |
          Write-Host "=== Verifying package info ===" -ForegroundColor Green
          $output = & "$env:PY311" -m omnipkg.cli info six 2>&1 | Out-String
          Write-Host $output
          if ($output -match "1\.16\.0") {
            Write-Host "✅ SUCCESS: Found version 1.16.0 in knowledge base" -ForegroundColor Green
          } else {
            Write-Host "❌ FAILURE: Version 1.16.0 not found in knowledge base" -ForegroundColor Red
            exit 1
          }
        shell: pwsh
        env:
          PYTHONUTF8: "1"
          PYTHONUNBUFFERED: "1"
          PYTHONIOENCODING: "utf-8"
          OMNIPKG_DEBUG: "1"
