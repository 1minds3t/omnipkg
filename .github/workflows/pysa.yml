# This workflow integrates Python Static Analyzer (Pysa) with
# GitHub's Code Scanning feature.
#
# Python Static Analyzer (Pysa) is a security-focused static
# analysis tool that tracks flows of data from where they
# originate to where they terminate in a dangerous location.
#
# See https://pyre-check.org/docs/pysa-basics/

name: Pysa Security Analysis

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '26 16 * * 0'  # Weekly on Sundays

permissions:
  contents: read

jobs:
  pysa:
    permissions:
      actions: read
      contents: read
      security-events: write
    
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyre-check
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
      
      - name: Initialize Pyre/Pysa
        run: |
          # Create .pyre_configuration if it doesn't exist
          if [ ! -f .pyre_configuration ]; then
            cat > .pyre_configuration << 'EOF'
          {
            "source_directories": ["."],
            "taint_models_path": [".pyre/taint_models"],
            "search_path": [
              {
                "site-package": "pip"
              }
            ]
          }
          EOF
          fi
          
          # Create taint models directory
          mkdir -p .pyre/taint_models
      
      - name: Run Pysa
        continue-on-error: true
        run: |
          pyre analyze --save-results-to pysa-results.json || true
      
      - name: Convert Pysa results to SARIF
        if: always()
        run: |
          python3 << 'EOF'
          import json
          import os
          
          # Check if results exist
          if not os.path.exists('pysa-results.json'):
              print("No Pysa results found - creating empty report")
              results = []
          else:
              try:
                  with open('pysa-results.json', 'r') as f:
                      data = json.load(f)
                  results = data if isinstance(data, list) else []
              except Exception as e:
                  print(f"Could not parse Pysa results: {e}")
                  results = []
          
          # Convert to SARIF format
          sarif = {
              "version": "2.1.0",
              "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
              "runs": [{
                  "tool": {
                      "driver": {
                          "name": "Pysa",
                          "informationUri": "https://pyre-check.org/docs/pysa-basics/",
                          "version": "0.9.0",
                          "rules": []
                      }
                  },
                  "results": []
              }]
          }
          
          # Process Pysa issues
          for issue in results:
              code = issue.get('code', 'security-issue')
              sarif['runs'][0]['results'].append({
                  "ruleId": f"pysa/{code}",
                  "level": "warning",
                  "message": {
                      "text": issue.get('description', 'Security issue detected by Pysa')
                  },
                  "locations": [{
                      "physicalLocation": {
                          "artifactLocation": {
                              "uri": issue.get('path', 'unknown')
                          },
                          "region": {
                              "startLine": issue.get('line', 1),
                              "startColumn": issue.get('column', 1)
                          }
                      }
                  }]
              })
          
          with open('pysa-results.sarif', 'w') as f:
              json.dump(sarif, f, indent=2)
          
          print(f"Converted {len(sarif['runs'][0]['results'])} Pysa issues to SARIF")
          EOF
      
      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pysa-results.sarif
          category: pysa
        continue-on-error: true
      
      - name: Show security summary
        if: always()
        run: |
          echo "### ðŸ”’ Pysa Security Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f pysa-results.json ]; then
            python3 << 'EOF'
          import json
          try:
              with open('pysa-results.json', 'r') as f:
                  data = json.load(f)
              issues = len(data) if isinstance(data, list) else 0
              print(f"**Total security issues found:** {issues}")
              if issues == 0:
                  print("âœ… No taint flow vulnerabilities detected")
          except:
              print("âš ï¸ Could not parse results")
          EOF
          else
            echo "âœ… No security issues found" >> $GITHUB_STEP_SUMMARY
          fi
