name: Build Platform-Specific Wheels for Existing Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to build wheels for (e.g., v2.0.7)'
        required: true
        type: string
      python_versions:
        description: 'Python versions (space-separated, e.g., "3.10 3.11 3.12 3.13")'
        required: false
        default: '3.10 3.11 3.12 3.13'
        type: string
      upload_to_pypi:
        description: 'Upload wheels to PyPI?'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  id-token: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Build wheels for all platforms
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-wheels:
    name: "Build ${{ matrix.platform }} wheels"
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        include:
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Linux x86_64 - Use OmniPkg OUTSIDE containers
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - runner: ubuntu-latest
            platform: manylinux_2_17_x86_64
            os_type: linux
            
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Linux ARM64 (aarch64) - Use QEMU + manylinux
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - runner: ubuntu-latest
            platform: manylinux_2_17_aarch64
            os_type: linux
            arch: aarch64
            use_qemu: true
            
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Linux ppc64le - Use QEMU + manylinux
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - runner: ubuntu-latest
            platform: manylinux_2_17_ppc64le
            os_type: linux
            arch: ppc64le
            use_qemu: true
            
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # macOS Intel x86_64
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - runner: macos-15-intel  # Intel runner (macOS 15)
            platform: macosx_10_13_x86_64
            os_type: macos
            deployment_target: "10.13"
            
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # macOS Apple Silicon ARM64
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - runner: macos-latest  # ARM64 runner
            platform: macosx_11_0_arm64
            os_type: macos
            deployment_target: "11.0"
            
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Windows x86_64
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - runner: windows-latest
            platform: win_amd64
            os_type: windows

    steps:
    - name: Checkout at specific release tag
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.release_tag }}
        
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Setup Python 3.12 for bootstrapping OmniPkg (all platforms)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Set up Python 3.12 for bootstrap
      if: matrix.os_type != 'linux' || matrix.use_qemu != true
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # QEMU Setup for ARM/PPC cross-compilation
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Set up QEMU
      if: matrix.use_qemu == true
      uses: docker/setup-qemu-action@v3
      with:
        platforms: ${{ matrix.arch }}
        
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Linux x86_64: Use OmniPkg on HOST, then build in manylinux
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Build wheels (Linux x86_64)
      if: matrix.os_type == 'linux' && matrix.use_qemu != true
      shell: bash
      run: |
        set -e
        
        # Create bootstrap venv and install OmniPkg (Python 3.12 from setup-python)
        python -m venv .bootstrap
        source .bootstrap/bin/activate
        pip install --upgrade pip wheel
        pip install -e .
        
        echo "ğŸ¯ OmniPkg installed! Version:"
        omnipkg --version
        
        # Use OmniPkg to download Python versions to cache
        IFS=' ' read -ra PY_VERSIONS <<< "${{ inputs.python_versions }}"
        for PY_VER in "${PY_VERSIONS[@]}"; do
          echo "ğŸ“¥ Pre-downloading Python $PY_VER..."
          omnipkg python install "$PY_VER" || true
        done
        
        # Now build wheels in manylinux container using container's Pythons
        docker run --rm \
          -v $(pwd):/workspace \
          -w /workspace \
          quay.io/pypa/manylinux2014_x86_64 \
          /bin/bash -c '
            set -e
            
            # Map requested versions to manylinux Python paths
            declare -A PY_MAP=(
              ["3.10"]="/opt/python/cp310-cp310"
              ["3.11"]="/opt/python/cp311-cp311"
              ["3.12"]="/opt/python/cp312-cp312"
              ["3.13"]="/opt/python/cp313-cp313"
            )
            
            mkdir -p dist
            
            # Build with each manylinux-certified Python
            for PY_VER in ${{ inputs.python_versions }}; do
              PYBIN="${PY_MAP[$PY_VER]}/bin"
              
              if [ ! -d "$PYBIN" ]; then
                echo "âš ï¸  Python $PY_VER not available in manylinux container"
                continue
              fi
              
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ğŸ Building wheel for Python $PY_VER"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "Using: $PYBIN/python"
              
              $PYBIN/python --version
              
              # Install build tools in this Python
              $PYBIN/python -m pip install --upgrade pip build wheel
              
              # Build the wheel
              $PYBIN/python -m build --wheel --outdir dist/
              
              echo "âœ… Wheel built for Python $PY_VER"
            done
            
            # Repair wheels with auditwheel
            echo ""
            echo "ğŸ”§ Repairing wheels with auditwheel..."
            for whl in dist/*.whl; do
              auditwheel repair "$whl" -w dist/
              rm "$whl"  # Remove unrepaired wheel
            done
            
            echo ""
            echo "ğŸ“¦ Final manylinux wheels:"
            ls -lh dist/*.whl
            
            # Fix permissions
            chmod -R 777 dist/
          '
        
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Linux ARM64/PPC: Use manylinux container's Pythons directly
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Build wheels (Linux ARM64/PPC with QEMU)
      if: matrix.os_type == 'linux' && matrix.use_qemu == true
      shell: bash
      run: |
        set -e
        
        docker run --rm --platform linux/${{ matrix.arch }} \
          -v $(pwd):/workspace \
          -w /workspace \
          quay.io/pypa/manylinux2014_${{ matrix.arch }} \
          /bin/bash -c '
            set -e
            
            # Map requested versions to manylinux Python paths
            declare -A PY_MAP=(
              ["3.10"]="/opt/python/cp310-cp310"
              ["3.11"]="/opt/python/cp311-cp311"
              ["3.12"]="/opt/python/cp312-cp312"
              ["3.13"]="/opt/python/cp313-cp313"
            )
            
            mkdir -p dist
            
            for PY_VER in ${{ inputs.python_versions }}; do
              PYBIN="${PY_MAP[$PY_VER]}/bin"
              
              if [ ! -d "$PYBIN" ]; then
                echo "âš ï¸  Python $PY_VER not available in manylinux container"
                continue
              fi
              
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ğŸ Building wheel for Python $PY_VER on ${{ matrix.platform }}"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              $PYBIN/python --version
              $PYBIN/python -m pip install --upgrade pip build wheel
              $PYBIN/python -m build --wheel --outdir dist/
              
              echo "âœ… Wheel built for Python $PY_VER"
            done
            
            # Repair wheels
            echo ""
            echo "ğŸ”§ Repairing wheels with auditwheel..."
            for whl in dist/*.whl; do
              auditwheel repair "$whl" -w dist/
              rm "$whl"
            done
            
            echo "ğŸ“¦ Final manylinux wheels:"
            ls -lh dist/*.whl
            
            chmod -R 777 dist/
          '
        
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # macOS: OmniPkg with EXPLICIT deployment targets
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Build wheels (macOS)
      if: matrix.os_type == 'macos'
      shell: bash
      env:
        MACOSX_DEPLOYMENT_TARGET: ${{ matrix.deployment_target }}
      run: |
        set -e
        
        echo "ğŸ¯ Building for macOS with deployment target: $MACOSX_DEPLOYMENT_TARGET"
        
        # Create bootstrap venv (Python 3.12 from setup-python)
        python -m venv .bootstrap
        source .bootstrap/bin/activate
        pip install --upgrade pip build wheel
        pip install -e .
        
        echo "ğŸ¯ OmniPkg installed!"
        omnipkg --version
        
        IFS=' ' read -ra PY_VERSIONS <<< "${{ inputs.python_versions }}"
        mkdir -p dist
        
        for PY_VER in "${PY_VERSIONS[@]}"; do
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ Building wheel for Python $PY_VER on ${{ matrix.platform }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          omnipkg python adopt "$PY_VER" || omnipkg python install "$PY_VER"
          omnipkg swap python "$PY_VER"
          
          python --version
          
          # Verify deployment target is set
          echo "ğŸ“‹ MACOSX_DEPLOYMENT_TARGET=$MACOSX_DEPLOYMENT_TARGET"
          
          python -m pip install --upgrade pip build wheel
          python -m build --wheel --outdir dist/
          
          echo "âœ… Wheel built for Python $PY_VER"
        done
        
        echo ""
        echo "ğŸ“¦ All wheels built:"
        ls -lh dist/*.whl
        
        # Verify wheel tags match deployment target
        echo ""
        echo "ğŸ” Verifying wheel tags..."
        for whl in dist/*.whl; do
          echo "  $whl"
          unzip -q -c "$whl" "*.dist-info/WHEEL" | grep "^Tag:" || true
        done
        
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Windows: OmniPkg works fine here
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Build wheels (Windows)
      if: matrix.os_type == 'windows'
      shell: pwsh
      run: |
        # Create bootstrap venv (Python 3.12 from setup-python)
        python -m venv .bootstrap
        .\.bootstrap\Scripts\Activate.ps1
        pip install --upgrade pip build wheel
        pip install -e .
        
        Write-Host "ğŸ¯ OmniPkg installed!"
        omnipkg --version
        
        $pyVersions = "${{ inputs.python_versions }}" -split ' '
        New-Item -ItemType Directory -Force -Path dist
        
        foreach ($pyVer in $pyVersions) {
          Write-Host ""
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "ğŸ Building wheel for Python $pyVer on ${{ matrix.platform }}"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          omnipkg python adopt $pyVer
          if ($LASTEXITCODE -ne 0) {
            omnipkg python install $pyVer
          }
          
          omnipkg swap python $pyVer
          
          python --version
          
          python -m pip install --upgrade pip build wheel
          python -m build --wheel --outdir dist/
          
          Write-Host "âœ… Wheel built for Python $pyVer"
        }
        
        Write-Host ""
        Write-Host "ğŸ“¦ All wheels built:"
        Get-ChildItem dist/*.whl
        
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Upload wheels as artifacts
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Upload wheels as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wheels-${{ matrix.platform }}
        path: dist/*.whl
        retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Collect all wheels and optionally upload to PyPI
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  publish-wheels:
    name: "Publish wheels to PyPI"
    needs: build-wheels
    runs-on: ubuntu-latest
    if: inputs.upload_to_pypi == true
    environment: pypi
    
    steps:
    - name: Download all wheel artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: wheels-*
        path: all-wheels
        merge-multiple: true
        
    - name: List all wheels
      run: |
        echo "ğŸ“¦ All platform-specific wheels built:"
        ls -lh all-wheels/*.whl
        echo ""
        echo "Total wheels: $(ls -1 all-wheels/*.whl | wc -l)"
        
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        packages-dir: all-wheels/
        skip-existing: true
        
    - name: Success
      run: |
        echo "ğŸ‰ All platform-specific wheels published to PyPI!"
        echo "Users can now install with: pip install omnipkg"
        echo "And get optimized wheels for their platform!"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Update GitHub Release with wheels
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-release:
    name: "Attach wheels to GitHub Release"
    needs: build-wheels
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all wheel artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: wheels-*
        path: all-wheels
        merge-multiple: true
        
    - name: Upload wheels to GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ inputs.release_tag }}
        files: all-wheels/*.whl
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Success
      run: |
        echo "âœ… Wheels attached to release: ${{ inputs.release_tag }}"
        echo "Users can download platform-specific wheels directly from GitHub!"
