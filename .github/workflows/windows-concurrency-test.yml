name: "üöÄ Windows - Omnipkg Demo Test (CI - No Redis)"

on:
  push:
    branches: [ development ]
  pull_request:
    branches: [ development ]
  workflow_dispatch:

jobs:
  test:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python (3.11)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Configure UTF-8 encoding and unbuffered output
        run: |
          echo "PYTHONIOENCODING=utf-8"    >> $env:GITHUB_ENV
          echo "PYTHONUTF8=1"              >> $env:GITHUB_ENV
          echo "PYTHONUNBUFFERED=1"        >> $env:GITHUB_ENV
          echo "OMNIPKG_DEBUG=1"           >> $env:GITHUB_ENV
          echo "PYTHONDONTWRITEBYTECODE=1" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Install omnipkg
        run: |
          python -m pip install --upgrade pip
          pip install -e .
        shell: pwsh

      - name: Configure omnipkg for non-interactive use
        run: |
          $configDir = "$HOME\.config\omnipkg"
          New-Item -ItemType Directory -Force -Path $configDir | Out-Null
          @{ interactive = $false; auto_confirm = $true } | ConvertTo-Json |
            Out-File -FilePath "$configDir\config.json" -Encoding utf8
          Write-Host "‚úÖ Omnipkg configured"
        shell: pwsh

      - name: Start daemon
        run: omnipkg daemon start
        shell: cmd

      # Dump daemon log immediately after start so we see what workers it spawned
      - name: "[DEBUG] Dump daemon log after start"
        if: always()
        run: |
          python -c "
import os, sys
candidates = [
    os.path.join(os.environ.get('TEMP','C:\\\\Temp'), 'omnipkg', 'omnipkg_daemon.log'),
    os.path.join(os.environ.get('TMP', 'C:\\\\Temp'), 'omnipkg', 'omnipkg_daemon.log'),
]
try:
    from omnipkg.isolation.worker_daemon import DAEMON_LOG_FILE
    candidates.insert(0, DAEMON_LOG_FILE)
except Exception as e:
    print(f'[WARN] Could not import DAEMON_LOG_FILE: {e}')

found = False
for path in candidates:
    if os.path.exists(path):
        print(f'=== DAEMON LOG: {path} ===')
        with open(path, encoding='utf-8', errors='replace') as f:
            for i, line in enumerate(f, 1):
                print(f'[{i:04d}] {line}', end='')
        found = True
        break

if not found:
    print('‚ùå Daemon log not found. Tried:')
    for p in candidates:
        print(f'  {p}')
"
        shell: cmd

      - name: Run Demo (Option 8 - Quantum Multiverse)
        run: omnipkg demo 8 --non-interactive
        shell: cmd

      # Dump daemon log after every run so we always have it in CI artifacts
      - name: "[DEBUG] Dump daemon log after Demo run 1"
        if: always()
        run: |
          python -c "
import os, sys
candidates = [
    os.path.join(os.environ.get('TEMP','C:\\\\Temp'), 'omnipkg', 'omnipkg_daemon.log'),
    os.path.join(os.environ.get('TMP', 'C:\\\\Temp'), 'omnipkg', 'omnipkg_daemon.log'),
]
try:
    from omnipkg.isolation.worker_daemon import DAEMON_LOG_FILE
    candidates.insert(0, DAEMON_LOG_FILE)
except Exception as e:
    print(f'[WARN] Could not import DAEMON_LOG_FILE: {e}')

for path in candidates:
    if os.path.exists(path):
        print(f'=== DAEMON LOG: {path} ===')
        with open(path, encoding='utf-8', errors='replace') as f:
            for i, line in enumerate(f, 1):
                print(f'[{i:04d}] {line}', end='')
        break
"
        shell: cmd

      - name: Run Demo Again (Verify Caching)
        run: omnipkg demo 8 --non-interactive
        shell: cmd
        continue-on-error: true

      - name: "[DEBUG] Dump daemon log after Demo run 2"
        if: always()
        run: |
          python -c "
import os
candidates = [
    os.path.join(os.environ.get('TEMP','C:\\\\Temp'), 'omnipkg', 'omnipkg_daemon.log'),
    os.path.join(os.environ.get('TMP', 'C:\\\\Temp'), 'omnipkg', 'omnipkg_daemon.log'),
]
try:
    from omnipkg.isolation.worker_daemon import DAEMON_LOG_FILE
    candidates.insert(0, DAEMON_LOG_FILE)
except Exception as e:
    print(f'[WARN] {e}')

for path in candidates:
    if os.path.exists(path):
        print(f'=== DAEMON LOG: {path} ===')
        with open(path, encoding='utf-8', errors='replace') as f:
            for i, line in enumerate(f, 1):
                print(f'[{i:04d}] {line}', end='')
        break
"
        shell: cmd

      - name: Run Demo Again (Verify Caching)
        run: omnipkg demo 8 --non-interactive
        shell: cmd
        continue-on-error: true

      - name: "[DEBUG] Dump daemon log after Demo run 3"
        if: always()
        run: |
          python -c "
import os
candidates = [
    os.path.join(os.environ.get('TEMP','C:\\\\Temp'), 'omnipkg', 'omnipkg_daemon.log'),
    os.path.join(os.environ.get('TMP', 'C:\\\\Temp'), 'omnipkg', 'omnipkg_daemon.log'),
]
try:
    from omnipkg.isolation.worker_daemon import DAEMON_LOG_FILE
    candidates.insert(0, DAEMON_LOG_FILE)
except Exception as e:
    print(f'[WARN] {e}')

for path in candidates:
    if os.path.exists(path):
        print(f'=== DAEMON LOG: {path} ===')
        with open(path, encoding='utf-8', errors='replace') as f:
            for i, line in enumerate(f, 1):
                print(f'[{i:04d}] {line}', end='')
        break
"
        shell: cmd
