name: "ðŸš€ Windows - Omnipkg Demo Test (CI - No Redis)"

on:
  push:
    branches: [ development ]
  pull_request:
    branches: [ development ]
  workflow_dispatch:
    inputs:
      code_branch:
        description: 'Branch to checkout and run code from'
        required: false
        default: 'development'

jobs:
  test:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.code_branch || github.ref }}

      - name: Show which branch we are running
        shell: cmd
        run: |
          echo Running workflow from ref: ${{ github.ref }}
          echo Checked out code branch: ${{ github.event.inputs.code_branch || github.ref }}

      - name: Set up Python (3.11)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Configure UTF-8 encoding and unbuffered output
        shell: pwsh
        run: |
          echo "PYTHONIOENCODING=utf-8"    >> $env:GITHUB_ENV
          echo "PYTHONUTF8=1"              >> $env:GITHUB_ENV
          echo "PYTHONUNBUFFERED=1"        >> $env:GITHUB_ENV
          echo "OMNIPKG_DEBUG=1"           >> $env:GITHUB_ENV
          echo "PYTHONDONTWRITEBYTECODE=1" >> $env:GITHUB_ENV

      - name: Install omnipkg
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Configure omnipkg for non-interactive use
        shell: pwsh
        run: |
          $configDir = "$HOME\.config\omnipkg"
          New-Item -ItemType Directory -Force -Path $configDir | Out-Null
          @{ interactive = $false; auto_confirm = $true } | ConvertTo-Json | Out-File -FilePath "$configDir\config.json" -Encoding utf8
          Write-Host "âœ… Omnipkg configured"

      - name: Start daemon
        shell: cmd
        run: omnipkg daemon start

      - name: Dump daemon log after start
        if: always()
        shell: pwsh
        run: |
          $tmp = "$env:TEMP\dump_log.py"
          @'
import os, sys
candidates = []
try:
    from omnipkg.isolation.worker_daemon import DAEMON_LOG_FILE
    candidates.append(DAEMON_LOG_FILE)
except Exception as e:
    print(f"[WARN] {e}")
for var in ("TEMP", "TMP"):
    base = os.environ.get(var, "C:\\Temp")
    candidates.append(os.path.join(base, "omnipkg", "omnipkg_daemon.log"))
print("=" * 80)
for path in candidates:
    if os.path.exists(path):
        print(f"[LOG FILE] {path}")
        with open(path, encoding="utf-8", errors="replace") as f:
            for i, line in enumerate(f, 1):
                print(f"[{i:04d}] {line}", end="")
        sys.exit(0)
print("Log not found. Tried:")
for p in candidates:
    print(f"  {p}")
'@ | Out-File -FilePath $tmp -Encoding utf8
          python $tmp

      - name: Run Demo (Option 8 - Quantum Multiverse)
        shell: cmd
        run: omnipkg demo 8 --non-interactive

      - name: Dump daemon log after demo run 1
        if: always()
        shell: pwsh
        run: |
          $tmp = "$env:TEMP\dump_log.py"
          if (Test-Path $tmp) { python $tmp } else { Write-Host "dump_log.py not found" }

      - name: Run Demo Again (Verify Caching)
        shell: cmd
        run: omnipkg demo 8 --non-interactive
        continue-on-error: true

      - name: Dump daemon log after demo run 2
        if: always()
        shell: pwsh
        run: |
          $tmp = "$env:TEMP\dump_log.py"
          if (Test-Path $tmp) { python $tmp } else { Write-Host "dump_log.py not found" }

      - name: Run Demo Again (Verify Caching)
        shell: cmd
        run: omnipkg demo 8 --non-interactive
        continue-on-error: true

      - name: Dump daemon log after demo run 3
        if: always()
        shell: pwsh
        run: |
          $tmp = "$env:TEMP\dump_log.py"
          if (Test-Path $tmp) { python $tmp } else { Write-Host "dump_log.py not found" }
