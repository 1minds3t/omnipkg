name: "ðŸš€ Windows - Omnipkg Demo Test (CI - No Redis)"

on:
  push:
    branches: [ development ]
  pull_request:
    branches: [ development ]
  workflow_dispatch:

jobs:
  test:
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # NO path parameter - checks out to D:\a\omnipkg\omnipkg
      
      - name: Set up Python (3.11)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Configure UTF-8 encoding and unbuffered output (Windows fix)
        run: |
          echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
          echo "PYTHONUTF8=1" >> $env:GITHUB_ENV
          echo "PYTHONUNBUFFERED=1" >> $env:GITHUB_ENV
          echo "OMNIPKG_DEBUG=1" >> $env:GITHUB_ENV
          # Force immediate flush for all streams
          echo "PYTHONDONTWRITEBYTECODE=1" >> $env:GITHUB_ENV
        shell: pwsh
            
      - name: Install omnipkg
        run: |
          python -m pip install --upgrade pip
          pip install -e .
        shell: pwsh
      
      - name: Configure omnipkg for non-interactive use
        run: |
          $configDir = "$HOME\.config\omnipkg"
          New-Item -ItemType Directory -Force -Path $configDir | Out-Null
          
          @{
            interactive = $false
            auto_confirm = $true
          } | ConvertTo-Json | Out-File -FilePath "$configDir\config.json" -Encoding utf8
          
          Write-Host "âœ… Omnipkg configured"
        shell: pwsh
      
      - name: Run Demo (Option 8 - Quantum Multiverse)
        run: omnipkg demo 8 --non-interactive
        shell: cmd

      - name: Run Demo Again (Verify Caching)
        continue-on-error: true
        run: omnipkg demo 8 --non-interactive
        shell: cmd
      
      - name: Run Demo Again (Verify Caching)
        continue-on-error: true
        run: omnipkg demo 8 --non-interactive
        shell: pwsh
