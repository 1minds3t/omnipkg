name: "üöÄ Windows - Omnipkg Demo Test (CI - No Redis)"
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
jobs:
  test:
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: src  # ADD THIS - changes from D:\a\omnipkg\omnipkg to D:\a\omnipkg\src
      
      - name: Set up Python (3.11)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # FIX: Force UTF-8 encoding globally for all Python processes
      - name: Configure UTF-8 encoding (Windows fix)
        run: |
          echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
          echo "PYTHONUTF8=1" >> $env:GITHUB_ENV
        shell: pwsh
      
      - name: Install omnipkg
        run: |
          python -m pip install --upgrade pip
          pip install -e src  # CHANGED: now references the 'src' directory
        shell: pwsh
      
      - name: Configure omnipkg for non-interactive use
        run: |
          $configDir = "$HOME\.config\omnipkg"
          New-Item -ItemType Directory -Force -Path $configDir | Out-Null
          
          @{
            interactive = $false
            auto_confirm = $true
          } | ConvertTo-Json | Out-File -FilePath "$configDir\config.json" -Encoding utf8
          
          Write-Host "‚úÖ Omnipkg configured"
        shell: pwsh
      
      - name: Run Demo (Option 8 - Quantum Multiverse)
        run: |
          echo "8" | python -m omnipkg.cli demo
          # Graceful exit to flush handles
          python -c "import sys, time; sys.stdout.flush(); sys.stderr.flush(); time.sleep(0.5)"
        shell: pwsh
        working-directory: src
      
      - name: Reset Python Context (Critical for Second Run)
        run: |
          Write-Host "üßπ Resetting Python context to prevent DLL contamination..."
          $pythonExe = Join-Path $env:pythonLocation "python.exe"
          & $pythonExe -c "import sys; print(f'‚úÖ Reset to: {sys.version}')"
          Start-Sleep -Milliseconds 500
        shell: pwsh  # ADD THIS - ensures we're in the right directory
      
      - name: Run Demo (Option 8 - Quantum Multiverse - Second Run - Optional)
        continue-on-error: true
        run: |
          Write-Host "=== SECOND RUN DEBUG INFO ==="
          Write-Host "Working Directory: $(Get-Location)"
          Write-Host "Python: $(python --version)"
          Write-Host "Python Path: $(Get-Command python).Path"
          Write-Host "PYTHONIOENCODING: $env:PYTHONIOENCODING"
          Write-Host "PYTHONUTF8: $env:PYTHONUTF8"
          
          Write-Host "`n=== Checking omnipkg state ==="
          python -c "import sys; print(f'sys.executable: {sys.executable}'); print(f'sys.path: {sys.path[:3]}')"
          
          Write-Host "`n=== Attempting second run with retry logic ==="
          $maxAttempts = 2
          $attempt = 1
          $success = $false
          
          while ($attempt -le $maxAttempts -and -not $success) {
            Write-Host "`n--- Attempt $attempt of $maxAttempts ---"
            
            try {
              # Add small delay before second run to let file locks release
              if ($attempt -gt 1) {
                Write-Host "Waiting 2 seconds for file locks to release..."
                Start-Sleep -Seconds 2
              }
              
              $output = echo "8" | python -m omnipkg.cli demo 2>&1
              Write-Host $output
              
              if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ Run succeeded!"
                $success = $true
              } else {
                Write-Host "‚ùå Exit code: $LASTEXITCODE"
                $attempt++
              }
            } catch {
              Write-Host "‚ùå Exception caught: $_"
              Write-Host "Error details: $($_.Exception.Message)"
              $attempt++
            }
          }
          
          if (-not $success) {
            Write-Host "`n‚ö†Ô∏è All attempts failed, but continuing (optional step)"
          }
        shell: pwsh
        working-directory: src
