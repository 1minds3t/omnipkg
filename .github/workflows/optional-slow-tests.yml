name: Optional Slow Tests (ARM64)

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  # The 2 slow local Podman ARM64 tests (>1 hour)
  linux-distros-podman-slow:
    name: Podman - ${{ matrix.distro }} (${{ matrix.platform }}) [SLOW]
    runs-on: [self-hosted, linux, x64]
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: ubuntu:24.04   # ~1h 6m
            platform: linux/arm64
          - distro: fedora:39      # ~1h 17m
            platform: linux/arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Test
        run: |
          podman run --rm -v $(pwd):/workspace:Z --platform ${{ matrix.platform }} ${{ matrix.distro }} /bin/bash -c "
            cd /workspace
            if command -v apt-get > /dev/null 2>&1; then apt-get update && apt-get install -y python3 python3-pip python3-venv;
            elif command -v dnf > /dev/null 2>&1; then dnf install -y python3 python3-pip; fi
            python3 -m pip install --upgrade pip build || python3 -m pip install --break-system-packages build
            python3 -m build
            python3 -m pip install dist/*.whl || python3 -m pip install --break-system-packages dist/*.whl
            omnipkg --version
          "

  # The slow/queued GitHub-hosted ARM64 runner
  github-arm64-linux:
    name: "Linux ARM64 (GitHub-hosted)"
    runs-on: ubuntu-24.04-arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build and Test
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip build
          python -m build
          pip install dist/*.whl
          omnipkg --version
