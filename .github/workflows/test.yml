name: Test Self-Hosted Linux Only

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test-self-hosted-linux:
    name: "üî• Linux x86_64 (self-hosted) - DIAGNOSTIC MODE"
    runs-on: [self-hosted, linux, x64]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Full Diagnostic Dump
        shell: bash
        run: |
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üîç SYSTEM INFO"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          uname -a
          whoami
          pwd
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üêç PYTHON INFO"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "Python3 location:"
          which python3 || echo "‚ùå No python3 in PATH"
          python3 --version 2>&1 || echo "‚ùå python3 --version failed"
          echo ""
          echo "Python location:"
          which python || echo "‚ùå No python in PATH"
          python --version 2>&1 || echo "‚ùå python --version failed"
          echo ""
          echo "All python* binaries:"
          ls -la /usr/bin/python* 2>/dev/null || echo "None in /usr/bin"
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üì¶ PIP INFO"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "pip3 location:"
          which pip3 || echo "‚ùå No pip3 in PATH"
          pip3 --version 2>&1 || echo "‚ùå pip3 --version failed"
          echo ""
          echo "pip location:"
          which pip || echo "‚ùå No pip in PATH"
          pip --version 2>&1 || echo "‚ùå pip --version failed"
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üîß PYTHON MODULES"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          python3 -m pip --version 2>&1 || echo "‚ùå python3 -m pip failed"
          python3 -c "import ensurepip; print(f'ensurepip: {ensurepip.version()}')" 2>&1 || echo "‚ùå ensurepip not available"
          python3 -c "import venv; print('venv: available')" 2>&1 || echo "‚ùå venv not available"
          python3 -c "import distutils; print('distutils: available')" 2>&1 || echo "‚ùå distutils not available"
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üåç ENVIRONMENT"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          env | grep -i python | sort || echo "No PYTHON* env vars"
          echo ""
          echo "PATH:"
          echo "$PATH" | tr ':' '\n'
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
      - name: Test Direct Install (No venv)
        shell: bash
        env:
          PYTHONUNBUFFERED: "1"
          PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
        run: |
          set -x
          
          # FORCE SYSTEM PYTHON - EXPLICIT VERSION TARGETING
          # Try 3.11 first (most stable), then 3.12, then generic 3.x
          if [ -f "/usr/bin/python3.11" ]; then
            PY=/usr/bin/python3.11
            echo "üéØ Using system Python 3.11: $PY"
          elif [ -f "/usr/bin/python3.12" ]; then
            PY=/usr/bin/python3.12
            echo "üéØ Using system Python 3.12: $PY"
          elif [ -f "/usr/bin/python3" ]; then
            # Verify it's not a symlink to conda
            REAL_PY=$(readlink -f /usr/bin/python3)
            if [[ "$REAL_PY" == *"conda"* ]] || [[ "$REAL_PY" == *"miniconda"* ]]; then
              echo "‚ùå /usr/bin/python3 points to conda, aborting"
              exit 1
            fi
            PY=/usr/bin/python3
            echo "üéØ Using system Python: $PY"
          else
            echo "‚ùå No system Python found"
            exit 1
          fi
          
          $PY --version
          echo "Real path: $(readlink -f $PY)"
          
          echo "üî• Installing pip and build to system Python"
          $PY -m pip install --user --upgrade pip build || {
            echo "‚ùå Failed. Trying bootstrap..."
            curl -sS https://bootstrap.pypa.io/get-pip.py | $PY - --user
            $PY -m pip install --user --upgrade pip build
          }
          
          echo "Building package..."
          $PY -m build
          
          echo "Installing package..."
          $PY -m pip install --user --force-reinstall dist/*.whl
          
          echo "Testing installation..."
          export PATH="$HOME/.local/bin:$PATH"
          omnipkg --version
          8pkg --version
          omnipkg list
          
      - name: Test venv Creation (Will probably fail)
        shell: bash
        continue-on-error: true
        run: |
          set -x
          if command -v python3 &>/dev/null; then PY=python3; else PY=python; fi
          
          echo "üß™ Testing venv creation..."
          $PY -m venv test_venv 2>&1 || {
            echo "‚ùå venv creation failed with exit code $?"
            echo "Trying --without-pip..."
            $PY -m venv test_venv --without-pip 2>&1 || echo "That also failed"
          }
          
          if [ -d "test_venv" ]; then
            echo "‚úÖ test_venv directory created"
            ls -la test_venv/
            if [ -f "test_venv/bin/activate" ]; then
              echo "‚úÖ activate script exists"
              source test_venv/bin/activate
              python --version
              which python
            else
              echo "‚ùå No activate script"
            fi
          else
            echo "‚ùå No test_venv directory created"
          fi
