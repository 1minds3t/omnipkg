- name: Build and Test
        shell: bash
        env:
          PYTHONUNBUFFERED: "1"
          # Force clean PATH on self-hosted to avoid conda
          PATH: ${{ contains(matrix.runner, 'self-hosted') && '/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' || '' }}
        run: |
          set -x
          
          # Self-hosted: Use system Python to avoid broken conda envs
          if [[ "${{ matrix.runner }}" == *"self-hosted"* ]]; then
            if [ -f "/usr/bin/python3.12" ]; then
              PY=/usr/bin/python3.12
            elif [ -f "/usr/bin/python3" ]; then
              PY=/usr/bin/python3
            else
              echo "âŒ No system Python found"
              exit 1
            fi
            echo "ðŸŽ¯ Self-hosted: Using system Python $PY ($($PY --version))"
            
            $PY -m pip install --user --upgrade pip build || {
              echo "pip install failed, trying bootstrap..."
              curl -sS https://bootstrap.pypa.io/get-pip.py | $PY - --user
              $PY -m pip install --user --upgrade pip build
            }
            $PY -m build
            $PY -m pip install --user --force-reinstall dist/*.whl
            
            export PATH="$HOME/.local/bin:$PATH"
            omnipkg --version
            8pkg --version
            omnipkg list
            
          else
            # GitHub-hosted: Standard approach with venv
            if command -v python3 &>/dev/null; then PY=python3; else PY=python; fi
            echo "ðŸ“¦ GitHub-hosted: Using $PY"
            
            $PY -m venv .venv
            if [ -f ".venv/bin/activate" ]; then source .venv/bin/activate; else source .venv/Scripts/activate; fi
            python -m pip install --upgrade pip build
            python -m build
            pip install dist/*.whl
            
            omnipkg --version
            8pkg --version
            omnipkg list
          fi
