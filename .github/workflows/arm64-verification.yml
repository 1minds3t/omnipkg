name: ARM64 Support Verification (QEMU)

on:
  push:
    tags:
      - 'v*'  # Runs on version tags (blocks PyPI publish)
  release:
    types: [published]
  workflow_dispatch:

jobs:
  arm64-qemu:
    name: ARM64 - ${{ matrix.distro }}
    runs-on: [self-hosted, linux, x64]
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: debian:12
            label: "Debian 12 Bookworm (ARM64)"
          
          - distro: ubuntu:24.04
            label: "Ubuntu 24.04 Noble (ARM64)"
          
          - distro: ubuntu:22.04
            label: "Ubuntu 22.04 Jammy (ARM64)"
          
          - distro: fedora:39
            label: "Fedora 39 (ARM64)"
          
          - distro: rockylinux:9
            label: "Rocky Linux 9 (ARM64)"
          
          - distro: alpine:latest
            label: "Alpine Linux (ARM64)"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up QEMU (cached)
        run: |
          if ! command -v qemu-aarch64-static &> /dev/null; then
            echo "Installing QEMU user-mode..."
            sudo apt-get update
            sudo apt-get install -y qemu-user-static binfmt-support
          fi
          echo "✅ QEMU ARM64 emulation ready"
      
      - name: Pre-pull base image
        run: |
          podman pull --platform linux/arm64 ${{ matrix.distro }}
      
      - name: Test in ${{ matrix.distro }} (ARM64/QEMU) - OPTIMIZED
        run: |
          podman run --rm \
            --platform linux/arm64 \
            -v $(pwd):/workspace:Z \
            -e PIP_NO_CACHE_DIR=1 \
            -e PIP_DISABLE_PIP_VERSION_CHECK=1 \
            ${{ matrix.distro }} /bin/sh -c '
            cd /workspace
            
            if command -v apt-get > /dev/null 2>&1; then
              apt-get update -qq
              apt-get install -y -qq --no-install-recommends python3 python3-pip python3-venv
              
              python3 -m pip install --no-cache-dir --upgrade pip build || \
                python3 -m pip install --no-cache-dir --break-system-packages pip build
              
              python3 -m build
              
              python3 -m pip install --no-cache-dir dist/*.whl || \
                python3 -m pip install --no-cache-dir --break-system-packages dist/*.whl
            
            elif command -v dnf > /dev/null 2>&1; then
              if grep -q "release 8" /etc/redhat-release 2>/dev/null; then
                dnf install -y -q python39 python39-pip
                ln -sf /usr/bin/python3.9 /usr/bin/python3
                ln -sf /usr/bin/pip3.9 /usr/bin/pip3
              else
                dnf install -y -q python3 python3-pip
              fi
              
              python3 -m pip install --no-cache-dir --upgrade pip build
              python3 -m build
              python3 -m pip install --no-cache-dir dist/*.whl
            
            elif command -v apk > /dev/null 2>&1; then
              apk add --no-cache -q python3 py3-pip py3-build gcc python3-dev musl-dev linux-headers
              
              python3 -m build
              python3 -m pip install --no-cache-dir --break-system-packages dist/*.whl
            
            else
              echo "❌ Unsupported package manager"
              exit 1
            fi
            
            omnipkg --version
            8pkg --version
            uname -m
            
            echo "✅ omnipkg successfully installed on ARM64!"
          '
      
      - name: Aggressive Podman cleanup
        if: always()
        run: |
          podman ps -aq | xargs -r podman rm -f 2>/dev/null || true
          podman images -q ${{ matrix.distro }} | xargs -r podman rmi -f 2>/dev/null || true
          podman system prune -af --volumes 2>/dev/null || true
          
          echo "✅ Podman cleaned (rootless-safe)"
  
  update-readme-with-arm64-stats:
    name: Update README with ARM64 Stats
    needs: arm64-qemu
    runs-on: ubuntu-latest
    if: success() # Only run if the arm64-qemu jobs succeed

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate ARM64 Results Summary
        id: summary
        run: |
          SUMMARY_CONTENT="""## ✅ ARM64 Support Verified (QEMU)

          **Verified Platforms:** 6/6

          **Tested on:**
          - Debian 12 (Bookworm)
          - Ubuntu 24.04 (Noble)
          - Ubuntu 22.04 (Jammy)
          - Fedora 39
          - Rocky Linux 9
          - Alpine Linux

          *Note: Tests run via QEMU user-mode emulation on a self-hosted x86_64 runner.*
          """
          echo "summary_text<<EOF" >> $GITHUB_ENV
          echo "$SUMMARY_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Update README.md
        run: |
          # This uses sed to replace the content between two markers in the README
          # First, add these markers to your README.md where you want the table to appear:
          # <!-- ARM64_STATUS_START -->
          # <!-- ARM64_STATUS_END -->
          sed -i '/<!-- ARM64_STATUS_START -->/,/<!-- ARM64_STATUS_END -->/{//!d;}' README.md
          sed -i '/<!-- ARM64_STATUS_START -->/a\'"$summary_text" README.md

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          # Check if there are changes to commit
          if ! git diff --staged --quiet; then
            git commit -m "docs: auto-update ARM64 verification status"
            git push
          else
            echo "No changes to README.md needed."
          fi
      
      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ✅ ARM64 Support Verified (QEMU)
          
          **Verified Platforms:** ${{ steps.count.outputs.verified }}/${{ steps.count.outputs.total }}
          
          **Tested on:**
          - Debian 12 (Bookworm)
          - Ubuntu 24.04 (Noble)
          - Ubuntu 22.04 (Jammy)
          - Fedora 39
          - Rocky Linux 9
          - Alpine Linux
          
          **Note:** ARM tests run on tag push as pre-release gate.
          All tests must pass before PyPI publish is allowed.
          
          **Optimizations:** No pip cache, minimal packages, aggressive cleanup
          EOF
