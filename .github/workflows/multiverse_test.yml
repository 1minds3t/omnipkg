name: "ðŸŒ  LIVE - Omnipkg Quantum Multiverse Warp (FINAL)"
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e . redis rich

      - name: Configure omnipkg for CI
        id: setup_omnipkg
        run: |
          # This step is still good practice for CI environments.
          python - << 'EOF'
          import json, os
          from pathlib import Path
          from omnipkg.core import ConfigManager
          
          # Force non-interactive mode for CI
          config_dir = Path.home() / '.config' / 'omnipkg'
          config_dir.mkdir(parents=True, exist_ok=True)
          full_config_path = config_dir / 'config.json'
          
          # Initialize ConfigManager to get the environment ID
          cm = ConfigManager(suppress_init_messages=True)
          env_id = cm.env_id
          print(f"Authoritative Environment ID for this job: {env_id}")
          
          # Write a minimal config to ensure non-interactive mode
          if full_config_path.exists():
              with open(full_config_path, 'r') as f:
                  data = json.load(f)
          else:
              data = {"environments": {}}
          
          if env_id not in data["environments"]:
              data["environments"][env_id] = {}
              
          data["environments"][env_id]["interactive"] = False
          data["environments"][env_id]["auto_confirm"] = True
          
          with open(full_config_path, 'w') as f:
              json.dump(data, f, indent=4)
          
          print("âœ… Omnipkg configured for non-interactive use")
          
          # Set the ENV ID for subsequent steps
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"OMNIPKG_ENV_ID_OVERRIDE={env_id}\n")
          EOF

      - name: Run The Self-Contained Concurrent Test
        env:
          # Pass the authoritative ENV ID to the test script
          OMNIPKG_ENV_ID_OVERRIDE: ${{ env.OMNIPKG_ENV_ID_OVERRIDE }}
        run: |
          echo "--- Running The Self-Contained Concurrent Installation Test ---"
          # Just run the test. It will handle adopting Python versions itself.
          python tests/test_concurrent_install.p
