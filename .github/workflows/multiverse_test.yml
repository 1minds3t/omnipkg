name: "ðŸŒ  LIVE - Omnipkg Quantum Multiverse Warp (FINAL)"
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e . redis rich

      - name: Configure omnipkg for CI
        id: setup_omnipkg
        run: |
          python - << 'EOF'
          import json, os
          from pathlib import Path
          from omnipkg.core import ConfigManager
          cm = ConfigManager(suppress_init_messages=True)
          env_id = cm.env_id
          print(f"Authoritative Environment ID for this job: {env_id}")
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"OMNIPKG_ENV_ID_OVERRIDE={env_id}\n")
          EOF

      - name: Run Quantum Multiverse Demo
        env:
          OMNIPKG_ENV_ID_OVERRIDE: ${{ env.OMNIPKG_ENV_ID_OVERRIDE }}
        run: |
          echo "--- Running Omnipkg Quantum Multiverse Warp Demo ---"
          # This is the correct, robust way to run the test via the intended entry point.
          # It pipes "8" to select the demo and suppresses the harmless BrokenPipeError.
          echo "8" | omnipkg demo 2> >(grep -v "BrokenPipeError\|Broken pipe" || true)
