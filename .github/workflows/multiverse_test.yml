name: "ðŸŒ  LIVE - Omnipkg Quantum Multiverse Warp (FINAL)"
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e . redis rich
          
      - name: Configure omnipkg and Establish Authoritative ENV_ID
        id: setup_omnipkg
        run: |
          python - << 'EOF'
          import json
          import os
          from pathlib import Path
          from omnipkg.core import ConfigManager

          config_dir = Path.home() / '.config' / 'omnipkg'
          config_dir.mkdir(parents=True, exist_ok=True)
          
          config = {
              "interactive": False,
              "auto_confirm": True,
              "redis_url": "redis://localhost:6379"
          }
          with open(config_dir / 'config.json', 'w') as f:
              json.dump(config, f, indent=2)
          print("âœ… Omnipkg configured for non-interactive use")
          
          main_env_id = ConfigManager().env_id
          print(f"Authoritative Environment ID for this job: {main_env_id}")
          
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"OMNIPKG_ENV_ID_OVERRIDE={main_env_id}\n")
          EOF
          
      - name: Adopt All Required Python Versions
        env:
          OMNIPKG_ENV_ID_OVERRIDE: ${{ env.OMNIPKG_ENV_ID_OVERRIDE }}
        run: |
          echo "--- Adopting Python Versions ---"
          omnipkg python adopt 3.9
          omnipkg python adopt 3.10
      
      - name: Reset and Prime Environments to Build Knowledge Bases
        env:
          OMNIPKG_ENV_ID_OVERRIDE: ${{ env.OMNIPKG_ENV_ID_OVERRIDE }}
        run: |
          echo "--- Resetting and Priming Python environments ---"
          PYTHON_39_EXE=$(omnipkg info python | grep 'Python 3.9:' | awk '{print $4}')
          PYTHON_310_EXE=$(omnipkg info python | grep 'Python 3.10:' | awk '{print $4}')

          echo "Priming Python 3.9 by forcing KB rebuild..."
          "$PYTHON_39_EXE" -m omnipkg.cli reset --yes
          
          echo "Priming Python 3.10 by forcing KB rebuild..."
          "$PYTHON_310_EXE" -m omnipkg.cli reset --yes
          
          echo "âœ… All Python environments have been primed."

      - name: Pre-Install Test Packages
        env:
          OMNIPKG_ENV_ID_OVERRIDE: ${{ env.OMNIPKG_ENV_ID_OVERRIDE }}
        run: |
          echo "--- Pre-installing exact rich versions ---"
          PYTHON_39_EXE=$(omnipkg info python | grep 'Python 3.9:' | awk '{print $4}')
          PYTHON_310_EXE=$(omnipkg info python | grep 'Python 3.10:' | awk '{print $4}')
          
          echo "Installing rich==13.4.2 for Python 3.9 (expecting it to be bubbled)..."
          "$PYTHON_39_EXE" -m omnipkg.cli install rich==13.4.2
          
          echo "Installing rich==13.6.0 for Python 3.10 (expecting it to be bubbled)..."
          "$PYTHON_310_EXE" -m omnipkg.cli install rich==13.6.0

      - name: Verify Correct State (Bubbles are Present)
        env:
          OMNIPKG_ENV_ID_OVERRIDE: ${{ env.OMNIPKG_ENV_ID_OVERRIDE }}
        run: |
          echo "--- Verifying Package State ---"
          PYTHON_39_EXE=$(omnipkg info python | grep 'Python 3.9:' | awk '{print $4}')
          PYTHON_310_EXE=$(omnipkg info python | grep 'Python 3.10:' | awk '{print $4}')

          echo "Verifying state for Python 3.9..."
          if "$PYTHON_39_EXE" -m omnipkg.cli info rich | grep -q "13.4.2 (bubble)"; then
            echo "âœ… Correct: rich 13.4.2 is available in a bubble."
          else
            echo "âŒ FAILED: rich 13.4.2 was not found in a bubble."
            "$PYTHON_39_EXE" -m omnipkg.cli info rich
            exit 1
          fi
          
          echo "Verifying state for Python 3.10..."
          if "$PYTHON_310_EXE" -m omnipkg.cli info rich | grep -q "13.6.0 (bubble)"; then
            echo "âœ… Correct: rich 13.6.0 is available in a bubble."
          else
            echo "âŒ FAILED: rich 13.6.0 was not found in a bubble."
            "$PYTHON_310_EXE" -m omnipkg.cli info rich
            exit 1
          fi
      
      - name: Run Quantum Multiverse Demo and Verify
        env:
          OMNIPKG_ENV_ID_OVERRIDE: ${{ env.OMNIPKG_ENV_ID_OVERRIDE }}
        run: |
          echo "--- Running Omnipkg Quantum Multiverse Warp Demo ---"
          # The test itself will use the import hook to find and activate the bubbled versions.
          echo "8" | omnipkg demo
